****************************************************
****************************************************
****************************************************
**************   afernandez
****************************************************
****************************************************
****************************************************
-- Generado por Oracle SQL Developer Data Modeler 3.1.0.699
--   en:        2013-04-24 19:29:59 CEST
--   sitio:      Oracle Database 10g
--   tipo:      Oracle Database 10g



CREATE USER ALUMNO 
    IDENTIFIED BY  
    ACCOUNT UNLOCK 
;

CREATE TABLE ALUMNO.AVIONES 
    ( 
     NAVION NUMBER (10)  NOT NULL , 
     NOMBRE VARCHAR2 (10 BYTE) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE ALUMNO.AVIONES 
    ADD CONSTRAINT PK_AVIONES PRIMARY KEY ( NAVION ) ;



CREATE TABLE ALUMNO.PIEZASCOMPUESTAS 
    ( 
     IDCOMPUESTO NUMBER (10) , 
     NAVION NUMBER (10) , 
     NOMBRE VARCHAR2 (30 BYTE) , 
     IDENTIFICADOR NUMBER (10)  NOT NULL 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE ALUMNO.PIEZASCOMPUESTAS 
    ADD CONSTRAINT PK_PC PRIMARY KEY ( IDENTIFICADOR ) ;



CREATE TABLE ALUMNO.PIEZASSIMPLES 
    ( 
     IDENTIFICADOR NUMBER (10)  NOT NULL , 
     SERIALNUMBER VARCHAR2 (10 BYTE) , 
     NAVION NUMBER (10)  NOT NULL , 
     IDPARTNUMBER VARCHAR2 (10 BYTE) , 
     IDCOMPUESTO NUMBER (10) , 
     NOMBRE VARCHAR2 (10 BYTE) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE ALUMNO.PIEZASSIMPLES 
    ADD CONSTRAINT PK_PS PRIMARY KEY ( IDENTIFICADOR ) ;



CREATE TABLE ALUMNO.TIPOPIEZA 
    ( 
     ID_PART_NUMBER NUMBER (10)  NOT NULL , 
     TIPO_PIEZA VARCHAR2 (10 BYTE)  NOT NULL 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE ALUMNO.TIPOPIEZA 
    ADD CONSTRAINT PK_ID_PART_NUMBER PRIMARY KEY ( ID_PART_NUMBER ) ;




ALTER TABLE ALUMNO.PIEZASSIMPLES 
    ADD CONSTRAINT FK2_PS FOREIGN KEY 
    ( 
     IDCOMPUESTO
    ) 
    REFERENCES ALUMNO.PIEZASCOMPUESTAS 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE ALUMNO.PIEZASCOMPUESTAS 
    ADD CONSTRAINT FK_PC FOREIGN KEY 
    ( 
     NAVION
    ) 
    REFERENCES ALUMNO.AVIONES 
    ( 
     NAVION
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE ALUMNO.PIEZASSIMPLES 
    ADD CONSTRAINT FK_PS FOREIGN KEY 
    ( 
     NAVION
    ) 
    REFERENCES ALUMNO.AVIONES 
    ( 
     NAVION
    ) 
    NOT DEFERRABLE 
;

CREATE OR REPLACE VIEW ALUMNO.AVIONES_PROFESOR AS
SELECT  NAVION PARTE_ID,NULL PARTE_PADRE,NOMBRE NOMBRE, NULL SN,NULL PN FROM AVIONES
UNION
SELECT IDENTIFICADOR PARTE_ID, IDCOMPUESTO PARTE_PADRE,NOMBRE NOMBRE,SERIALNUMBER SN,IDPARTNUMBER PN FROM PIEZASSIMPLES
WHERE IDCOMPUESTO IS NOT NULL
UNION
SELECT IDENTIFICADOR PARTE_ID, NAVION PARTE_PADRE,NOMBRE NOMBRE, SERIALNUMBER SN,IDPARTNUMBER PN FROM PIEZASSIMPLES
WHERE IDCOMPUESTO IS NULL
UNION
SELECT IDENTIFICADOR PARTE_ID,IDCOMPUESTO  PARTE_PADRE, NOMBRE NOMBRE,NULL SN, NULL PN FROM PIEZASCOMPUESTAS
WHERE IDCOMPUESTO IS NOT NULL
UNION
SELECT IDENTIFICADOR PARTE_ID,NAVION  PARTE_PADRE, NOMBRE NOMBRE,NULL SN, NULL PN FROM PIEZASCOMPUESTAS
WHERE IDCOMPUESTO IS NULL ;



CREATE SEQUENCE ALUMNO.INSTRUCTOR_ID_SEQ 
    INCREMENT BY 1 
    MAXVALUE 999999999999999999999999999 
    MINVALUE 1 
    NOCACHE 
;

CREATE SEQUENCE ALUMNO.SECTION_ID_SEQ 
    INCREMENT BY 1 
    MAXVALUE 999999999999999999999999999 
    MINVALUE 1 
    NOCACHE 
;

CREATE SEQUENCE ALUMNO.SECUENCIA_PIEZA_ID 
    INCREMENT BY 1 
    MAXVALUE 999999999999999999999999999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE SEQUENCE ALUMNO.SECUENCIA_SERIALNUMBER 
    INCREMENT BY 1 
    MAXVALUE 999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE OR REPLACE TRIGGER ALUMNO.CREACION_ID_PIEZA 
    BEFORE INSERT ON ALUMNO.AVIONES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."NAVION" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."NAVION" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER ALUMNO.DISPARADOR_DE_PIEZAS_SIMPLES 
    BEFORE INSERT ON ALUMNO.PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end;



create or replace
trigger DISPARADOR_DE_PIEZAS_COMPUESTAS
   before insert on PIEZASCOMPUESTAS
   for each row 

begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER ALUMNO.DISPARADOR_PIEZAS_COMPUESTAS 
    BEFORE INSERT ON ALUMNO.PIEZASCOMPUESTAS 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end;
 
/


CREATE OR REPLACE TRIGGER ALUMNO.DISPARADOR_SERIALNUMBER 
    BEFORE INSERT ON ALUMNO.PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."SERIALNUMBER" is null then 
         select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIALNUMBER" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER ALUMNO.TRIGGER1 
    BEFORE INSERT ON ALUMNO.PIEZASCOMPUESTAS 
    FOR EACH ROW 
BEGIN
  NULL;
END; 
/



CREATE OR REPLACE PROCEDURE ALUMNO.BORRAR_AVION (AVION_ID IN NUMBER) AS 
ID_AVION NUMBER;
BEGIN
ID_AVION:=AVION_ID;
DELETE FROM PIEZASSIMPLES WHERE NAVION=ID_AVION;
DELETE FROM PIEZASCOMPUESTAS WHERE NAVION=ID_AVION;
DELETE FROM AVIONES WHERE NAVION=ID_AVION;
END BORRAR_AVION;
/

CREATE OR REPLACE PROCEDURE ALUMNO.BORRAR_AVIONES  AS 
BEGIN
DELETE FROM PIEZASSIMPLES;
DELETE FROM PIEZASCOMPUESTAS;
DELETE FROM AVIONES;
END BORRAR_AVIONES;
/

CREATE OR REPLACE PROCEDURE ALUMNO.COPIAR_AVION (AVION_ID IN NUMBER  , COPIA_AVION_ID IN NUMBER) AS 
ID_AVION AVIONES%ROWTYPE;
BEGIN
SELECT * INTO ID_AVION FROM AVIONES WHERE NAVION=AVION_ID;
INSERT INTO AVIONES(NOMBRE,NAVION) VALUES(ID_AVION.NOMBRE,COPIA_AVION_ID);
END COPIAR_AVION;
/

CREATE OR REPLACE procedure ALUMNO.COPIAR_HIJOS(id_origen number, id_destino number) as
cursor c_compuesta is select * from piezascompuestas where navion=id_origen;
cursor c_compuesta2 is select * from piezascompuestas where idpartnumber=id_origen;
cursor c_simple is select * from piezassimples where navion=id_origen;
cursor c_simple2 is select * from piezassimples where idcompuesto=id_origen;
avion number(3);
nuevo_hijo_id number(3);
ident number(3);
begin
  avion:=91;
  for i in c_compuesta loop
    if i.id_pieza_contenedora is null then
      insert into piezascompuestas(nombre, id_avion) values(i.nombre, id_destino);
      ident:=i.identificador;
      select secuencia_pieza_id.currval into nuevo_hijo_id from dual;
      copiar_hijos(ident, nuevo_hijo_id);
    end if;
  end loop;
  for j in c_compuesta2 loop
    if j.id_pieza_contenedora is not null then 
      select id_avion into avion from piezascompuestas where identificador=id_destino;
      insert into piezascompuestas(nombre, id_pieza_contenedora, id_avion) values(j.nombre, id_destino, avion);
      ident:=j.identificador;
      select secuencia_pieza_id.currval into nuevo_hijo_id from dual;
      copiar_hijos(ident, nuevo_hijo_id);
    end if;
  end loop;
  for k in c_simple loop
    if k.id_pieza_contenedora is null then
      insert into piezassimples(part_number, nombre, navion) values(k.part_number, k.nombre, id_destino);
    end if;
  end loop;
  for m in c_simple2 loop
    if m.id_pieza_contenedora is not null then
      select navion into avion from piezas_compuestas where identificador=id_destino;
      insert into piezas_simples(part_number, nombre, id_pieza_contenedora, navion) values(m.part_number, m.nombre, id_destino, avion);
    end if;
  end loop;
end;
/

CREATE OR REPLACE PROCEDURE ALUMNO.CREARAVION(ID NUMBER) AS 
DECLARE
BUSCA_ID NUMBER(10);
BEGIN
SELECT NUMERO_CONSECUTIVO INTO BUSCA_ID FROM AVION
WHERE NUMERO_CONSECUTIVO=ID;

IF BUSCA_ID IS NULL THEN
INSERT INTO AVION VALUES(ID);
 NULL;
END CREARAVION;
/

CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
IDCABINA NUMBER(10);
IDPILOTO NUMBER(10);
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION1');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10001',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10002',I,'PN-002','Asiento 1');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10003',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10004',I,'PN-002','Asiento 2');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10005',I,'PN-002','Asiento 3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10006',I,'PN-004','Motor 1');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10007',I,'PN-004','Motor 2');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
END CREAR_AVION;
/

CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION1(ID NUMBER) AS
BUSCA_ID NUMBER(10);
BEGIN
SELECT NUMERO_CONSECUTIVO INTO BUSCA_ID FROM AVION
WHERE NUMERO_CONSECUTIVO=ID;
IF BUSCA_ID!=ID THEN
DBMS_OUTPUT.PUT_LINE('ID NO ENCONTRADO');
END IF;
INSERT INTO AVION VALUES(ID,'NOMBRE');
commit;
END CREAR_AVION1;
/

CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION11(ID NUMBER) AS 
BUSCA_ID NUMBER(10);
BEGIN
SELECT NUMERO_CONSECUTIVO INTO BUSCA_ID FROM AVION
WHERE NUMERO_CONSECUTIVO=ID;
IF BUSCA_ID=ID THEN
DBMS_OUTPUT.PUT_LINE('ID ENCONTRADO');
END IF;
INSERT INTO AVION(NUMERO_CONSECUTIVO,NOMBRE) VALUES(ID,'NOMBRE');
commit;
END CREAR_AVION11;
/

CREATE OR REPLACE PROCEDURE ALUMNO.INTENTA_CREAR_AVION_MASDE10 (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10019',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10020',I,'PN-002','Asiento 11');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10021',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10022',I,'PN-002','Asiento 12');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10023',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10024',I,'PN-004','Motor 5');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10025',I,'PN-004','Motor 6');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10026',I,'PN-004','Motor 7');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10027',I,'PN-004','Motor 8');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10028',I,'PN-005','Caja negra');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10029',I,'PN-006','Gps');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(11,I,'Asiento piloto');
END INTENTA_CREAR_AVION_MASDE10;
/

CREATE OR REPLACE PROCEDURE ALUMNO.INTENTA_CREAR_AVION_MASDE4 (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION2');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10008',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10009',I,'PN-002','Asiento 4');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10010',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10011',I,'PN-002','Asiento 5');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10012',I,'PN-002','Asiento 6');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10013',I,'PN-002','Asiento 7');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10014',I,'PN-002','Asiento 8');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10015',I,'PN-002','Asiento 9');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10016',I,'PN-002','Asiento 10');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10017',I,'PN-004','Motor 3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10018',I,'PN-004','Motor 4');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
END INTENTA_CREAR_AVION_MASDE4;
/

CREATE OR REPLACE FUNCTION ALUMNO.COMPRUEBA_AVION(ID number) RETURN varchar2 AS 
NUMEROPIEZAS NUMBER(10);
ID_NO NUMBER(10):=ID;
EX EXCEPTION;
EX2 EXCEPTION;
  BEGIN
    SELECT COUNT(identificador) INTO NUMEROPIEZAS FROM piezassimples; 
    IF NUMEROPIEZAS>10 THEN
      RAISE EX;
    END IF;
    SELECT NAVION INTO ID_NO FROM aviones WHERE navion=ID;
    IF ID_NO<>ID THEN
      RAISE EX2;
    END IF ;
    EXCEPTION 
      WHEN EX2 THEN
         DBMS_OUTPUT.PUT_LINE('DEMASIADAS PIEZAS');
    RETURN numeropiezas;
  END;
/

CREATE OR REPLACE FUNCTION ALUMNO.COMPRUEBA_PIEZA(ID number) RETURN VARCHAR2 AS 
NUMEROPIEZAS NUMBER(10);
IDAVION NUMBER(10);
EX exception;
BEGIN
select count(identificador) INTO NUMEROPIEZAS from piezascompuestas WHERE numeropiezas=ID;
  IF NUMEROPIEZAS>4 THEN
  RAISE EX;
  END IF;
  IF IDAVION <> id THEN
    RAISE EX;
  END IF;
  RETURN NUMEROPIEZAS;
  EXCEPTION WHEN EX THEN
  DBMS_OUTPUT.PUT_LINE('ERROR');
END;
/

CREATE OR REPLACE FUNCTION ALUMNO.MEDIA RETURN number AS 
Cursor notas is select numeric_grade from grade;
contador number;
resultado number;
media number;
BEGIN
contador:=0;
resultado:=0;
media:=0;
for i in notas loop
if i.numeric_grade>80 then
resultado:=resultado+i.numeric_grade;
contador:=contador+1;
end if;
end loop;
media:=resultado/contador;
return media;
 END;
/

CREATE OR REPLACE FUNCTION ALUMNO.MIFUNCIONMIA RETURN VARCHAR2 AS 
BEGIN
  RETURN NULL;
END MIFUNCIONMIA;
/


-- Informe de Resumen de Oracle SQL Developer Data Modeler: 
-- 
-- CREATE TABLE                             4
-- CREATE INDEX                             0
-- ALTER TABLE                              7
-- CREATE VIEW                              1
-- CREATE PACKAGE                           0
-- CREATE PACKAGE BODY                      0
-- CREATE PROCEDURE                        10
-- CREATE FUNCTION                          4
-- CREATE TRIGGER                           5
-- ALTER TRIGGER                            0
-- CREATE STRUCTURED TYPE                   0
-- CREATE COLLECTION TYPE                   0
-- CREATE CLUSTER                           0
-- CREATE CONTEXT                           0
-- CREATE DATABASE                          0
-- CREATE DIMENSION                         0
-- CREATE DIRECTORY                         0
-- CREATE DISK GROUP                        0
-- CREATE ROLE                              0
-- CREATE ROLLBACK SEGMENT                  0
-- CREATE SEQUENCE                          4
-- CREATE MATERIALIZED VIEW                 0
-- CREATE SYNONYM                           0
-- CREATE TABLESPACE                        0
-- CREATE USER                              1
-- 
-- DROP TABLESPACE                          0
-- DROP DATABASE                            0
-- 
-- ERRORS                                   0
-- WARNINGS                                 0
drop user afernandez cascade;
 
 create user afernandez identified by afernandez;
 grant resource,connect, create view, create procedure to afernandez;
 connect afernandez/afernandez;
 @afernandez.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 18:59:57 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user afernandez cascade
            *
ERROR at line 1:
ORA-01918: user 'AFERNANDEZ' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL>     ACCOUNT UNLOCK
            *
ERROR at line 3:
ORA-00922: missing or invalid option


CREATE TABLE ALUMNO.AVIONES
*
ERROR at line 1:
ORA-01031: insufficient privileges


ALTER TABLE ALUMNO.AVIONES
*
ERROR at line 1:
ORA-00942: table or view does not exist


CREATE TABLE ALUMNO.PIEZASCOMPUESTAS
*
ERROR at line 1:
ORA-01031: insufficient privileges


ALTER TABLE ALUMNO.PIEZASCOMPUESTAS
*
ERROR at line 1:
ORA-00942: table or view does not exist


CREATE TABLE ALUMNO.PIEZASSIMPLES
*
ERROR at line 1:
ORA-01031: insufficient privileges


ALTER TABLE ALUMNO.PIEZASSIMPLES
*
ERROR at line 1:
ORA-00942: table or view does not exist


CREATE TABLE ALUMNO.TIPOPIEZA
*
ERROR at line 1:
ORA-01031: insufficient privileges


ALTER TABLE ALUMNO.TIPOPIEZA
*
ERROR at line 1:
ORA-00942: table or view does not exist


ALTER TABLE ALUMNO.PIEZASSIMPLES
*
ERROR at line 1:
ORA-00942: table or view does not exist


ALTER TABLE ALUMNO.PIEZASCOMPUESTAS
*
ERROR at line 1:
ORA-00942: table or view does not exist


ALTER TABLE ALUMNO.PIEZASSIMPLES
*
ERROR at line 1:
ORA-00942: table or view does not exist


SELECT	NAVION PARTE_ID,NULL PARTE_PADRE,NOMBRE NOMBRE, NULL SN,NULL PN FROM AVIONES
                                                                             *
ERROR at line 2:
ORA-00942: table or view does not exist


CREATE SEQUENCE ALUMNO.INSTRUCTOR_ID_SEQ
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE SEQUENCE ALUMNO.SECTION_ID_SEQ
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE SEQUENCE ALUMNO.SECUENCIA_PIEZA_ID
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE SEQUENCE ALUMNO.SECUENCIA_SERIALNUMBER
*
ERROR at line 1:
ORA-01031: insufficient privileges


    BEFORE INSERT ON ALUMNO.AVIONES
                            *
ERROR at line 2:
ORA-00942: table or view does not exist


    BEFORE INSERT ON ALUMNO.PIEZASSIMPLES
                            *
ERROR at line 2:
ORA-00942: table or view does not exist


    BEFORE INSERT ON ALUMNO.PIEZASCOMPUESTAS
                            *
ERROR at line 2:
ORA-00942: table or view does not exist


    BEFORE INSERT ON ALUMNO.PIEZASSIMPLES
                            *
ERROR at line 2:
ORA-00942: table or view does not exist


    BEFORE INSERT ON ALUMNO.PIEZASCOMPUESTAS
                            *
ERROR at line 2:
ORA-00942: table or view does not exist


CREATE OR REPLACE PROCEDURE ALUMNO.BORRAR_AVION (AVION_ID IN NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.BORRAR_AVIONES  AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.COPIAR_AVION (AVION_ID IN NUMBER  , COPIA_AVION_ID IN NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE procedure ALUMNO.COPIAR_HIJOS(id_origen number, id_destino number) as
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.CREARAVION(ID NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION (AVION_ID IN NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION1(ID NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.CREAR_AVION11(ID NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.INTENTA_CREAR_AVION_MASDE10 (AVION_ID IN NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE PROCEDURE ALUMNO.INTENTA_CREAR_AVION_MASDE4 (AVION_ID IN NUMBER) AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE FUNCTION ALUMNO.COMPRUEBA_AVION(ID number) RETURN varchar2 AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE FUNCTION ALUMNO.COMPRUEBA_PIEZA(ID number) RETURN VARCHAR2 AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE FUNCTION ALUMNO.MEDIA RETURN number AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


CREATE OR REPLACE FUNCTION ALUMNO.MIFUNCIONMIA RETURN VARCHAR2 AS
*
ERROR at line 1:
ORA-01031: insufficient privileges


SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

Warning: View created with compilation errors.

****************Borrar aviones

Call completed.

  call borrar_aviones()
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


****************Crear avion 1000

Call completed.

  call crear_avion(1000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


****************Copiar avion 1000 en 2000

Call completed.

  call copiar_avion(1000,2000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


****************Crear avion 3000 (mas de 4)

Call completed.

  call intenta_crear_avion_masde4(3000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


****************Copiar avion 3000 en 4000

Call completed.

  call copiar_avion(3000,4000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


****************Borrar avion 3000

Call completed.

  call borrar_avion(3000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


****************Crear avion 5000 (mas de 10)

Call completed.

  call intenta_crear_avion_masde10(5000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors


*****************Es correcto el avion 1000

Call completed.

  select COMPRUEBA_AVION(1000) from dual
         *
ERROR at line 1:
ORA-00904: "COMPRUEBA_AVION": invalid identifier


*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-00904: "COMPRUEBA_AVION": invalid identifier


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-00904: "COMPRUEBA_AVION": invalid identifier


****************Borrar todos los aviones

Call completed.

  call borrar_aviones()
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AFERNANDEZ.AVIONES_PROFESOR_ARBOL" has errors



Rollback complete.

****************************************************
****************************************************
****************************************************
**************   ahammana
****************************************************
****************************************************
****************************************************
create or replace FUNCTION SECUENCIA_PIEZA_ID RETURN number AS  
secuencia_pieza_id number
begin
if inserting then 
      if "avion_id" is not null then 
         select avion_id_SEQ.nextval into "avion_id" from dual; 
      end if;  
   end if;  
   return avion_id;
end;
/

create or replace FUNCTION SECUENCIA_SERIALNUMBER RETURN number AS  
secuencia_serial_number number
begin
if inserting then 
      if "serial_number" is not null then 
         select serial_number_SEQ.nextval into 'SN-'||"serial_number" from dual; 
      end if;  
   end if;  
   return serial_number;
end;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_AVION RETURN VARCHAR2 AS 
BEGIN
AVIONES ALIAS FOR $$;
    IF EXISTS (SELECT PART_ID, COUNT(SERIAL_NUMBER) FROM PIEZAS_SIMPLES WHERE ) THEN
DBMS_OUTPUT.PUT_LINE('EL AVION EXISTE Y TIENE MENOS DE 10 PIEZAS');
ELSE
DBMS_OUTPUT.PUT_LINE('NO SE HA ENCONTRADO NINGUN AVION CON MENOS DE 10 PIEZAS');
END IF;
END COMPRUEBA_AVION;


CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA RETURN VARCHAR2 AS 
BEGIN
AVIONES ALIAS FOR $$;
    IF EXISTS (SELECT PART_ID, COUNT(SERIAL_NUMBER) FROM PIEZAS_SIMPLES WHERE COUNT(SERIAL_NUMBER)<10 ) THEN
DBMS_OUTPUT.PUT_LINE('EL AVION EXISTE Y TIENE MENOS DE 10 PIEZAS');
ELSE
DBMS_OUTPUT.PUT_LINE('NO SE HA ENCONTRADO NINGUN AVION CON MENOS DE 10 PIEZAS');
END IF;
END COMPRUEBA_PIEZA;



Create or replace procedure CREAR_AVION(avion in Avion.avion_id%type) is
numeroAvion number;
eNulo Exception;
Begin
If numeroAvion is null then
Raise eNulo;
End if;
DECLARE 
 SECUENCIA_PIEZA_ID AVION_id%TYPE; 
BEGIN 
 -- Extrae un nuevo avion_id
 SELECT SECUENCIA_PIEZA_ID.NEXTVAL 
 INTO v_AvionID 
 FROM dual; 
 -- Añade una fila a la tabla aviones 
 INSERT INTO aviones (avion_id,nombre_avion)
 VALUES (v_AvionID ,null); 
 -- Añade otra fila usando directamente el número 
 -- de secuencia en la orden INSERT 
 INSERT INTO AVIONES (avion_id,nombre_avion)
 VALUES (SECUENCIA_PIEZA_ID.NEXTVAL, 
null); 
END;
Exception
When no_data_found then
DBMS_OUTPUT.PUT_LINE(‘EL AVION INTRODUCIDO NO SE ENCUENTRA’);
WHEN eNulo THEN
DBMS_OUTPUT.PUT_LINE(‘DEBES INTRODUCIR UN  AVION’);
WHEN OTHERS THEN
DBMS_OUTPUT.PUT_LINE(‘ERROR: ‘||SQLCODE||’ MENSAJE ‘||SQLERRM);
end;/


 


CREATE VIEW AVIONES_PROFESOR 
SELECT pc.parte_id, pc.parte_padre, pc.nombre, ps.sn,ps.pn 
FROM piezas_compuestas pc, piezas_simples ps
WHERE ps.sn=pc.sn;


CREATE OR REPLACE PROCEDURE BORRAR_AVION(avion_id number)  
(pAvion_Id IN AVIONES.AVION_ID%TYPE) IS
eNulo EXCEPTION;
rAvion AVION_ID%ROWTYPE; --AQUI SE VAN A RECUPERAR DATOS POR LO CUAL NECESITAMOS EL REGISTRO 
BEGIN
    pError:=0;
    IF pAvion_Id IS NULL THEN
        RAISE eNulo;
    END IF;
	SELECT * INTO rAvion FROM AVION  --COMPRUEBA QUE TENEMOS EL EMPLEADO EN LA TABLA LO HACEMOS FUERA DE LOS IF (si encuentra algo en la tabla avión. Lo guarda en rAvion. (Into rAvion))
	WHERE Avion_Id= pAvion_Id;
	
    
    IF pAvion_Id IS NOT NULL THEN
			rAvion.Avion_Id:pAvion_Id;
	END IF;
	-- UNA VEZ COMPROBADO QUE NO ES NULO Y QUE EL REGISTRO NO HACE SALTAR LA EXCEPCION EJECUTAMOS LA ORDEN. 
		DELETE FROM AVION WHERE AVION_ID=pAvion_Id;
		DBMS_OUTPUT.PUT_LINE('SE HA BORRADO EL AVION '||pAvion_Id||' CORRECTAMENTE');

    EXCEPTION
		WHEN NO_DATA_FOUND THEN
			DBMS_OUTPUT.PUT_LINE('NO SE HA ENCONTRADO EL NUMERO DE AVION');
		WHEN eNulo THEN
            DBMS_OUTPUT.PUT_LINE('DEBES INTRODUCIR UN NUMERO DE AVION PARA BORRAR');
            		WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('ERROR: '||SQLCODE||' MENSAJE: '||SQLERRM);
     END;
/



CREATE OR REPLACE PROCEDURE BORRAR_AVIONES(avion_id number)  
(pAvion_Id IN AVIONES.AVION_ID%TYPE) AS
eNulo EXCEPTION;
rAvion AVION_ID%ROWTYPE; --AQUI SE VAN A RECUPERAR DATOS POR LO CUAL NECESITAMOS EL REGISTRO 
BEGIN
    pError:=0;
    IF pAvion_Id IS NULL THEN
        RAISE eNulo;
    END IF;
	SELECT * INTO rAvion FROM AVION  --COMPRUEBA QUE TENEMOS EL EMPLEADO EN LA TABLA LO HACEMOS FUERA DE LOS IF (si encuentra algo en la tabla avión. 
	--Lo guarda en rAvion. (Into rAvion))   
    IF pAvion_Id IS NOT NULL THEN
			rAvion.Avion_Id:pAvion_Id;
	END IF;
	-- UNA VEZ COMPROBADO QUE NO ES NULO Y QUE EL REGISTRO NO HACE SALTAR LA EXCEPCION EJECUTAMOS LA ORDEN. 
		DELETE FROM AVIONES;
		DBMS_OUTPUT.PUT_LINE('SE HA BORRADO TODOS LOS AVIONES CORRECTAMENTE');

    EXCEPTION
		WHEN NO_DATA_FOUND THEN
			DBMS_OUTPUT.PUT_LINE('NO SE HA ENCONTRADO NINGUN AVION PARA BORRAR');
		WHEN eNulo THEN
            DBMS_OUTPUT.PUT_LINE('DEBES INTRODUCIR UN AVION PARA BORRAR');
            		WHEN OTHERS THEN
            DBMS_OUTPUT.PUT_LINE('ERROR: '||SQLCODE||' MENSAJE: '||SQLERRM);
     END;




create or replace 
PROCEDURE COPIAR_AVION(avion_id number, copia_avion_id number) AS 
  avion_id_existente aviones%ROWTYPE;
BEGIN
  select * into avion_id from aviones where avion_id = avion_id_existente;
  
  select avion_id into avion_id_existente.avion_id from aviones;

  avion_id_existente.nombre := nombre_copia;  
  avion_id_existente.avion_id := avion_id_copia;
  
  insert into aviones values avion_id_existente;
  
END COPIAR_AVION;


CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4(avion_id number) AS
 avion_id aviones%ROWTYPE;
BEGIN
SELECT * FROM information_schema.tables WHERE table_name = aviones;
    IF NOT EXISTS THEN
		execute 'CREATE TABLE ' || aviones || '(
            avion_id varchar2 not null,
            nombre_avion varchar2,
            primary key (avion_id)
        )';
    END IF;
END INTENTA_CREAR_AVION_MASDE4;
drop user ahammana cascade;
 
 create user ahammana identified by ahammana;
 grant resource,connect, create view, create procedure to ahammana;
 connect ahammana/ahammana;
 @ahammana.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 18:59:58 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user ahammana cascade
            *
ERROR at line 1:
ORA-01918: user 'AHAMMANA' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Warning: Function created with compilation errors.


Warning: Function created with compilation errors.


Warning: Function created with compilation errors.

 59   60   61   62  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

Warning: View created with compilation errors.

****************Borrar aviones

Call completed.

  call borrar_aviones()
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


****************Crear avion 1000

Call completed.

  call crear_avion(1000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


****************Copiar avion 1000 en 2000

Call completed.

  call copiar_avion(1000,2000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


****************Crear avion 3000 (mas de 4)

Call completed.

  call intenta_crear_avion_masde4(3000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


****************Copiar avion 3000 en 4000

Call completed.

  call copiar_avion(3000,4000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


****************Borrar avion 3000

Call completed.

  call borrar_avion(3000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


****************Crear avion 5000 (mas de 10)

Call completed.

  call intenta_crear_avion_masde10(5000)
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors


*****************Es correcto el avion 1000

Call completed.

  select COMPRUEBA_AVION(1000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


****************Borrar todos los aviones

Call completed.

  call borrar_aviones()
       *
ERROR at line 1:
ORA-06576: not a valid function or procedure name


  select * from aviones_profesor_arbol
                *
ERROR at line 1:
ORA-04063: view "AHAMMANA.AVIONES_PROFESOR_ARBOL" has errors



Rollback complete.

****************************************************
****************************************************
****************************************************
**************   cdominguez
****************************************************
****************************************************
****************************************************
--PROBLEMA: Se necesita informatizar la gestión de las piezas de aviones.
--Autores: Zahira Zamora y Carlos Dominguez
-----secuencia para las piezas compuestas
CREATE sequence SECUENCIA_PIEZA_ID
  start with 100
  increment by 1
  maxvalue 999999
  minvalue 100;

-----secuencia para las piezas simples  
CREATE sequence SECUENCIA_SERIALNUMBER
  start with 1001
  increment by 1
  maxvalue 999999
  minvalue 1001;

-----Creacion tabla de relaciones--------------------------------
CREATE TABLE aviones (
  idPieza        number(6,0) not null, 
  descripcion    VARCHAR2(20) not null,
  idPadre        number(6,0),
  serialNumber   VARCHAR2(20),
  partNumber     VARCHAR2(20)
  );

ALTER TABLE aviones
  add constraint aviones_pk
  primary key (idPieza);

ALTER TABLE aviones
  add constraint aviones_fk
  foreign key (idPadre) references aviones(idPieza);

ALTER TABLE aviones
  add constraint aviones_unique
  unique (serialNumber);

-----Creacion vista de relaciones--------------------------------
create view AVIONES_PROFESOR as
select idPieza PARTE_ID, idPadre PARTE_PADRE, descripcion NOMBRE, serialnumber SN, partnumber PN
from aviones;

-----Triggers ID y SN----------------------------
CREATE OR REPLACE TRIGGER PONER_ID_PIEZA 
BEFORE INSERT ON AVIONES 
FOR EACH ROW 
BEGIN
  if :NEW.idPieza is null then
    select secuencia_pieza_id.nextval into :NEW.idPieza from dual;
  end if;
END;
/

CREATE OR REPLACE TRIGGER PONER_SN_PIEZA 
BEFORE INSERT ON AVIONES 
FOR EACH ROW 
BEGIN
  if :NEW.partnumber is not null then
    if :NEW.serialNumber is null then
      select secuencia_serialnumber.nextval into :NEW.serialNumber from dual;
      :NEW.serialNumber := 'SN-' || :NEW.serialNumber;
    end if;
  end if;
END;
/

-----Procedimiento de creacion de aviones-------------------------    /TODO
create or replace 
PROCEDURE CREAR_AVION(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 1');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 1');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 1',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');  
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 2',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 3',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 1',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 2',padre0,'PN-004');
END CREAR_AVION;
/

-----función COMPRUEBA_AVION(ID), error si el avión tiene más de 10 piezas simples, o si el ID no es el de un avión.
create or replace 
FUNCTION COMPRUEBA_AVION(avion_id number) RETURN varchar2 AS   
  resultado number;
  nAvion number;  
BEGIN
  SELECT count(idPieza) into nAvion from aviones where idPieza = avion_id;
  
  if nAvion=0 then
    raise_application_error(-20004,'Avion no encontrado');
  else  
    SELECT count(serialNumber)
    INTO resultado
    FROM aviones
    START WITH idPieza = avion_id
    CONNECT BY PRIOR idPieza = idPadre; 
    
    if resultado > 10 then
      raise_application_error(-20005,'Avion incorrecto');
    else return 'Avion correcto';
    end if;
  end if;
END;
/

-----función COMPRUEBA_PIEZA(ID), error si la pieza tiene más de 4 piezas simples, o el ID es el de un avión.
create or replace 
FUNCTION COMPRUEBA_PIEZA(pieza_id number) RETURN varchar2 AS   
  resultado number;
  existe number;
  esAvion number;  
BEGIN
  SELECT count(idPieza) into existe from aviones where idPieza = pieza_id;
  
  if existe = 0 then
    raise_application_error(-20001,'No existe esa pieza');
  end if;
  
  SELECT idPadre into esAvion from aviones where idPieza = pieza_id;
  if esAvion is null then
    raise_application_error(-20002,'No es una pieza, es un avion');
  else    
    SELECT count(serialNumber)
    INTO resultado
    FROM aviones
    START WITH idPieza = pieza_id
    CONNECT BY PRIOR idPieza = idPadre; 
    
    if resultado > 4 then
      raise_application_error(-20003,'Pieza incorrecta, tiene mas de 4 piezas simples');
    else return 'Pieza correcta';
    end if;
  end if;
END;
/

-----Procedimiento de borrado de todos los aviones-------------------------
create or replace 
PROCEDURE BORRAR_AVIONES AS 
BEGIN
  DELETE FROM aviones;
END BORRAR_AVIONES;
/

-----Procedimiento de borrado de un solo avion-----------------------------
create or replace 
PROCEDURE BORRAR_AVION(avion_id number) AS 
  CURSOR c_piezas is select idPieza from aviones
                      START WITH idPieza = avion_id
                      CONNECT BY PRIOR idPieza = idPadre
                      order by 1 desc;
BEGIN
  for i in c_piezas loop
    if i.idPieza <> avion_id then
      DELETE FROM aviones where idPieza = i.idPieza;
    end if;
  end loop;
  DELETE FROM aviones where idPieza = avion_id;
END BORRAR_AVION;
/

-----Procedimiento COPIAR_AVION(avion_id number, copia_avion_id number) que cree
----- un avión con el mismo número de piezas y del mismo tipo que el original.-------

--procedimiento auxiliar copiar_hijos
create or replace 
PROCEDURE COPIAR_HIJOS(id_origen number, id_destino number) AS
  id_nuevo number;
  hijo_origen aviones%rowtype;
BEGIN
  for hijo_origen in (select * from aviones where idPadre=id_origen)
  loop
    insert into aviones (descripcion,idPadre,partNumber) 
                 values (hijo_origen.descripcion,id_destino,hijo_origen.partNumber);
    select secuencia_pieza_id.currval into id_nuevo from dual;
    copiar_hijos(hijo_origen.idPieza,id_nuevo);
  end loop;
END COPIAR_HIJOS;
/

--procedimiento principal
create or replace 
PROCEDURE COPIAR_AVION(avion_id number, copia_avion_id number) AS
  existe number;
  descripcion_existente aviones.descripcion%type;
  id_nuevo number;
BEGIN
  SELECT count(idPieza) into existe from aviones where idPieza = avion_id;
  
  if existe = 0 then
    raise_application_error(-20006,'No existe ese avion para copiarlo');
  end if;
  
  select descripcion into descripcion_existente from aviones where idPieza = avion_id;
  insert into aviones (idpieza,descripcion) values (copia_avion_id,descripcion_existente);
  copiar_hijos(avion_id,copia_avion_id);
END COPIAR_AVION;
/

-----INTENTA_CREAR_AVION_MASDE10 ----------------------------------------------------
create or replace 
PROCEDURE INTENTA_CREAR_AVION_MASDE10(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 3');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 3');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 11',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');
  
  insert into aviones (descripcion,idpadre) values('Asiento copiloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 12',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');    
  
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 5',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 6',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 7',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 8',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Caja negra',padre0,'PN-005');
  insert into aviones (descripcion,idpadre,partnumber) values('GPS',padre0,'PN-006');
END INTENTA_CREAR_AVION_MASDE10;
/

-----INTENTA_CREAR_AVION_MASDE4------------------------------------
create or replace 
PROCEDURE INTENTA_CREAR_AVION_MASDE4(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 2');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 2');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 4',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');
  
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 5',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 6',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 7',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 8',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 9',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 10',padre1,'PN-002');     
  
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 3',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 4',padre0,'PN-004');  
END INTENTA_CREAR_AVION_MASDE4;
/
drop user cdominguez cascade;
 
 create user cdominguez identified by cdominguez;
 grant resource,connect, create view, create procedure to cdominguez;
 connect cdominguez/cdominguez;
 @cdominguez.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 18:59:58 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user cdominguez cascade
            *
ERROR at line 1:
ORA-01918: user 'CDOMINGUEZ' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Sequence created.


Sequence created.


Table created.


Table altered.


Table altered.


Table altered.


View created.


Trigger created.


Trigger created.


Procedure created.


Function created.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       3000
  Fuselaje		       SN-1015		    PN-001			118	   3000
  Cabina									119	   3000
    Asiento piloto								120	    119
      Asiento 4 	       SN-1016		    PN-002			121	    120
      Controles 	       SN-1017		    PN-003			122	    120
    Asiento 5		       SN-1018		    PN-002			123	    119
    Asiento 6		       SN-1019		    PN-002			124	    119
    Asiento 7		       SN-1020		    PN-002			125	    119
    Asiento 8		       SN-1021		    PN-002			126	    119
    Asiento 9		       SN-1022		    PN-002			127	    119
    Asiento 10		       SN-1023		    PN-002			128	    119
  Motor 3		       SN-1024		    PN-004			129	   3000
  Motor 4		       SN-1025		    PN-004			130	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       3000
  Fuselaje		       SN-1015		    PN-001			118	   3000
  Cabina									119	   3000
    Asiento piloto								120	    119
      Asiento 4 	       SN-1016		    PN-002			121	    120
      Controles 	       SN-1017		    PN-003			122	    120
    Asiento 5		       SN-1018		    PN-002			123	    119
    Asiento 6		       SN-1019		    PN-002			124	    119
    Asiento 7		       SN-1020		    PN-002			125	    119
    Asiento 8		       SN-1021		    PN-002			126	    119
    Asiento 9		       SN-1022		    PN-002			127	    119
    Asiento 10		       SN-1023		    PN-002			128	    119
  Motor 3		       SN-1024		    PN-004			129	   3000
  Motor 4		       SN-1025		    PN-004			130	   3000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000
Avion 3 								       5000
  Fuselaje		       SN-1037		    PN-001			144	   5000
  Cabina									145	   5000
    Asiento piloto								146	    145
      Asiento 11	       SN-1038		    PN-002			147	    146
      Controles 	       SN-1039		    PN-003			148	    146
    Asiento copiloto								149	    145
      Asiento 12	       SN-1040		    PN-002			150	    149
      Controles 	       SN-1041		    PN-003			151	    149
  Motor 5		       SN-1042		    PN-004			152	   5000
  Motor 6		       SN-1043		    PN-004			153	   5000
  Motor 7		       SN-1044		    PN-004			154	   5000
  Motor 8		       SN-1045		    PN-004			155	   5000
  Caja negra		       SN-1046		    PN-005			156	   5000
  GPS			       SN-1047		    PN-006			157	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Avion correcto

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20005: Avion incorrecto
ORA-06512: at "CDOMINGUEZ.COMPRUEBA_AVION", line 17


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20005: Avion incorrecto
ORA-06512: at "CDOMINGUEZ.COMPRUEBA_AVION", line 17


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   cloeches
****************************************************
****************************************************
****************************************************
-- Generado por Oracle SQL Developer Data Modeler 3.1.4.710
--   en:        2013-04-24 01:52:49 CEST
--   sitio:      Oracle Database 11g
--   tipo:      Oracle Database 11g



--CREATE USER PRUEBA 
--    IDENTIFIED BY  
--    ACCOUNT UNLOCK 
--;

CREATE TABLE AVIONES 
    ( 
     IDENTIFICADOR NUMBER (6)  NOT NULL , 
     NOMBRE VARCHAR2 (20 BYTE) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE AVIONES 
    ADD CONSTRAINT NOMBREAVION_NOTNULL 
    CHECK ( nombre is not null) 
;

CREATE UNIQUE INDEX AVIONES_PK ON AVIONES 
    ( 
     IDENTIFICADOR ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE AVIONES 
    ADD CONSTRAINT AVIONES_PK PRIMARY KEY ( IDENTIFICADOR ) 
    USING INDEX AVIONES_PK ;



CREATE TABLE PART_NUMBER 
    ( 
     PART_NUMBER VARCHAR2 (10 BYTE)  NOT NULL 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;


CREATE UNIQUE INDEX PART_PK ON PART_NUMBER 
    ( 
     PART_NUMBER ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PART_NUMBER 
    ADD CONSTRAINT PART_PK PRIMARY KEY ( PART_NUMBER ) 
    USING INDEX PART_PK ;

insert into part_number values('PN-001');
insert into part_number values('PN-002');
insert into part_number values('PN-003');
insert into part_number values('PN-004');
insert into part_number values('PN-005');
insert into part_number values('PN-006');

CREATE TABLE PIEZAS_COMPUESTAS 
    ( 
     IDENTIFICADOR NUMBER (6)  NOT NULL , 
     NOMBRE VARCHAR2 (20 BYTE) , 
     ID_AVION NUMBER (6) , 
     ID_PIEZA_CONTENEDORA NUMBER (6) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE PIEZAS_COMPUESTAS 
    ADD CONSTRAINT NOMBREPIEZACOMPUESTA 
    CHECK ( nombre is not null) 
;

CREATE UNIQUE INDEX PC_PK ON PIEZAS_COMPUESTAS 
    ( 
     IDENTIFICADOR ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PIEZAS_COMPUESTAS 
    ADD CONSTRAINT PC_PK PRIMARY KEY ( IDENTIFICADOR ) 
    USING INDEX PC_PK ;



CREATE TABLE PIEZAS_SIMPLES 
    ( 
     IDENTIFICADOR NUMBER (6)  NOT NULL , 
     SERIAL_NUMBER VARCHAR2 (10 BYTE) , 
     NOMBRE VARCHAR2 (20 BYTE) , 
     PART_NUMBER VARCHAR2 (10 BYTE) , 
     ID_AVION NUMBER (6) , 
     ID_PIEZA_CONTENEDORA NUMBER (6) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;



ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT SERIALNUMBER_NOTNULL 
    CHECK ( serial_number is not null) 
;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT NOMBREPIEZA_NOTNULL 
    CHECK ( nombre is not null) 
;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT PARTNUMBER_NOTNULL 
    CHECK ( part_number is not null) 
;

CREATE UNIQUE INDEX PS_PK ON PIEZAS_SIMPLES 
    ( 
     IDENTIFICADOR ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;
CREATE UNIQUE INDEX SERIALNUMBER_UNIQUE ON PIEZAS_SIMPLES 
    ( 
     SERIAL_NUMBER ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        NEXT 1048576 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT PS_PK PRIMARY KEY ( IDENTIFICADOR ) 
    USING INDEX PS_PK ;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT SERIALNUMBER_UNIQUE UNIQUE ( SERIAL_NUMBER ) 
    USING INDEX SERIALNUMBER_UNIQUE ;




ALTER TABLE PIEZAS_COMPUESTAS 
    ADD CONSTRAINT PC_FK FOREIGN KEY 
    ( 
     ID_AVION
    ) 
    REFERENCES AVIONES 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZAS_COMPUESTAS 
    ADD CONSTRAINT PC_FK2 FOREIGN KEY 
    ( 
     ID_PIEZA_CONTENEDORA
    ) 
    REFERENCES PIEZAS_COMPUESTAS 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT PS_FK1 FOREIGN KEY 
    ( 
     PART_NUMBER
    ) 
    REFERENCES PART_NUMBER 
    ( 
     PART_NUMBER
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT PS_FK2 FOREIGN KEY 
    ( 
     ID_AVION
    ) 
    REFERENCES AVIONES 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZAS_SIMPLES 
    ADD CONSTRAINT PS_FK3 FOREIGN KEY 
    ( 
     ID_PIEZA_CONTENEDORA
    ) 
    REFERENCES PIEZAS_COMPUESTAS 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS
select identificador PARTE_ID, null PARTE_PADRE, nombre NOMBRE, null SN, null PN 
from aviones
union
select identificador PARTE_ID, id_pieza_contenedora PARTE_PADRE, nombre NOMBRE, serial_number SN, part_number PN 
from piezas_simples
where id_pieza_contenedora is not null
union
select identificador PARTE_ID, id_avion PARTE_PADRE, nombre NOMBRE, serial_number SN, part_number PN 
from piezas_simples
where id_pieza_contenedora is null
union
select identificador PARTE_ID, id_pieza_contenedora PARTE_PADRE, nombre NOMBRE, null SN, null PN
from piezas_compuestas
where id_pieza_contenedora is not null
union
select identificador PARTE_ID, id_avion PARTE_PADRE, nombre NOMBRE, null SN, null PN
from piezas_compuestas
where id_pieza_contenedora is null ;



CREATE SEQUENCE SECUENCIA_PIEZA_ID 
    INCREMENT BY 1 
    MAXVALUE 999999999999999999999999999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER 
    INCREMENT BY 1 
    MAXVALUE 999999999999999999999999999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE OR REPLACE TRIGGER DISPARADOR_SERIALNUMBER 
    BEFORE INSERT ON PIEZAS_SIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."SERIAL_NUMBER" is null then 
         select 'SN-100'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIAL_NUMBER" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER IDENTIFICADOR_AVION 
    BEFORE INSERT ON AVIONES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER IDENTIFICADOR_PIEZASCOMPUESTAS 
    BEFORE INSERT ON PIEZAS_COMPUESTAS 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER IDENTIFICADOR_PIEZASSIMPLES 
    BEFORE INSERT ON PIEZAS_SIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end; 
/



CREATE OR REPLACE procedure BORRAR_AVION(avion_id number) as
idavion number;
begin
  idavion:=avion_id;
  delete from piezas_simples where id_avion=idavion;
  delete from piezas_compuestas where id_avion=idavion;
  delete from aviones where identificador=idavion;
end;
/

CREATE OR REPLACE procedure BORRAR_AVIONES as
begin
  delete from piezas_simples;
  delete from piezas_compuestas;
  delete from aviones;
end;
/

CREATE OR REPLACE procedure COPIAR_HIJOS(id_origen number, id_destino number) as
cursor c_compuesta is select * from piezas_compuestas where id_avion=id_origen;
cursor c_compuesta2 is select * from piezas_compuestas where id_pieza_contenedora=id_origen;
cursor c_simple is select * from piezas_simples where id_avion=id_origen;
cursor c_simple2 is select * from piezas_simples where id_pieza_contenedora=id_origen;
avion number(10);
nuevo_hijo_id number(10);
ident number(10);
begin
  avion:=91;
  for i in c_compuesta loop
    if i.id_pieza_contenedora is null then
      insert into piezas_compuestas(nombre, id_avion) values(i.nombre, id_destino);
      ident:=i.identificador;
      select secuencia_pieza_id.currval into nuevo_hijo_id from dual;
      copiar_hijos(ident, nuevo_hijo_id);
    end if;
  end loop;
  for j in c_compuesta2 loop
    if j.id_pieza_contenedora is not null then 
      select id_avion into avion from piezas_compuestas where identificador=id_destino;
      insert into piezas_compuestas(nombre, id_pieza_contenedora, id_avion) values(j.nombre, id_destino, avion);
      ident:=j.identificador;
      select secuencia_pieza_id.currval into nuevo_hijo_id from dual;
      copiar_hijos(ident, nuevo_hijo_id);
    end if;
  end loop;
  for k in c_simple loop
    if k.id_pieza_contenedora is null then
      insert into piezas_simples(part_number, nombre, id_avion) values(k.part_number, k.nombre, id_destino);
    end if;
  end loop;
  for m in c_simple2 loop
    if m.id_pieza_contenedora is not null then
      select id_avion into avion from piezas_compuestas where identificador=id_destino;
      insert into piezas_simples(part_number, nombre, id_pieza_contenedora, id_avion) values(m.part_number, m.nombre, id_destino, avion);
    end if;
  end loop;
end;
/

CREATE OR REPLACE procedure COPIAR_AVION(avion_id number, copia_avion_id number) as
avion_existente aviones%rowtype;
begin
  select * into avion_existente 
  from aviones
  where identificador=avion_id;
  insert into aviones values(copia_avion_id, avion_existente.nombre);
  copiar_hijos(avion_id, copia_avion_id);
end;
/


CREATE OR REPLACE procedure CREAR_AVION(avion_id number) as
idavion number;
idcabina number;
idpiloto number;
e number;
begin
    insert into aviones(identificador, nombre) values(avion_id, 'Avion 1');
    idavion:=avion_id;
    insert into piezas_simples(part_number, id_avion, nombre) values('PN-001', idavion, 'Fuselaje');
    insert into piezas_compuestas(id_avion, nombre) values(idavion, 'Cabina');
    select secuencia_pieza_id.currval into idcabina from dual;
    insert into piezas_compuestas(id_avion, nombre, id_pieza_contenedora) values(idavion, 'Asiento piloto', idcabina);
    select secuencia_pieza_id.currval into idpiloto from dual;
    insert into piezas_simples(part_number, id_avion, id_pieza_contenedora, nombre) values('PN-002', idavion, idpiloto, 'Asiento1');
    insert into piezas_simples(part_number, id_avion, id_pieza_contenedora, nombre) values('PN-003', idavion, idpiloto, 'Controles');
    insert into piezas_simples(part_number, id_avion, id_pieza_contenedora, nombre) values('PN-002', idavion, idcabina, 'Asiento 2');
    insert into piezas_simples(part_number, id_avion, id_pieza_contenedora, nombre) values('PN-002', idavion, idcabina, 'Asiento 3');
    insert into piezas_simples(part_number, id_avion, nombre) values('PN-004', idavion, 'Motor 1');
    insert into piezas_simples(part_number, id_avion, nombre) values('PN-004', idavion, 'Motor 2'); 
end;
/

CREATE OR REPLACE procedure INTENTA_CREAR_AVION_MASDE10(avion_id number) as
idcabina number(10);
idpiloto number(10);
idcopiloto number(10);
begin
  insert into aviones(identificador, nombre) values(avion_id, 'Avion 3');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Fuselaje', avion_id, 'PN-001', 'SN-10019');
  insert into piezas_compuestas(nombre, id_avion) values('Cabina', avion_id);
  select secuencia_pieza_id.currval into idcabina from dual;
  insert into piezas_compuestas(nombre, id_avion, id_pieza_contenedora) values('Asiento piloto', avion_id, idcabina);
  select secuencia_pieza_id.currval into idpiloto from dual;
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 11', avion_id, idpiloto,'PN-002','SN-10020');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Controles', avion_id, idpiloto,'PN-003', 'SN-10021');
  insert into piezas_compuestas(nombre, id_avion, id_pieza_contenedora) values('Asiento copiloto', avion_id, idcabina);
  select secuencia_pieza_id.currval into idcopiloto from dual;
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 12', avion_id, idcopiloto,'PN-002','SN-10022');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Controles', avion_id, idcopiloto,'PN-003', 'SN-10023');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 5', avion_id, 'PN-004', 'SN-10024');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 6', avion_id, 'PN-004', 'SN-10025');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 7', avion_id, 'PN-004', 'SN-10026');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 8', avion_id, 'PN-004', 'SN-10027');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Caja negra', avion_id, 'PN-005', 'SN-10028');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('GPS', avion_id, 'PN-006', 'SN-10029');
end;
/

CREATE OR REPLACE procedure INTENTA_CREAR_AVION_MASDE4(avion_id number) as
idcabina number(10);
idpiloto number(10);
begin
  insert into aviones(identificador, nombre) values(avion_id, 'Avion 2');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Fuselaje', avion_id, 'PN-001', 'SN-1008');
  insert into piezas_compuestas(nombre, id_avion) values('Cabina', avion_id);
  select secuencia_pieza_id.currval into idcabina from dual;
  insert into piezas_compuestas(nombre, id_avion, id_pieza_contenedora) values('Asiento piloto', avion_id, idcabina);
  select secuencia_pieza_id.currval into idpiloto from dual;
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 4', avion_id, idpiloto,'PN-002','SN-1009');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Controles', avion_id, idpiloto,'PN-003', 'SN-10010');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 5', avion_id, idcabina,'PN-002', 'SN-10011');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 6', avion_id, idcabina,'PN-002', 'SN-10012');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 7', avion_id, idcabina,'PN-002', 'SN-10013'); 
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number ,serial_number) values('Asiento 8', avion_id, idcabina,'PN-002', 'SN-10014');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 9', avion_id, idcabina,'PN-002', 'SN-10015');
  insert into piezas_simples(nombre, id_avion, id_pieza_contenedora, part_number, serial_number) values('Asiento 10', avion_id, idcabina,'PN-002', 'SN-10016');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 1', avion_id, 'PN-004', 'SN-10017');
  insert into piezas_simples(nombre, id_avion, part_number, serial_number) values('Motor 2', avion_id, 'PN-004', 'SN-10018');
end;
/

CREATE OR REPLACE function COMPRUEBA_AVION(id number) return number as
es_avion number(10);
cantidad_de_piezas number(10);
no_es_avion exception;
mas_de_diez_piezas exception;
begin
  select count(identificador) into es_avion from aviones where identificador=id;
  if es_avion=0 then
    raise_application_error(-20002,'No es un avion');
  else
   select count(identificador) into cantidad_de_piezas from piezas_simples where id_avion=id;
   if cantidad_de_piezas > 10 then
      raise_application_error(-20001,'El avion tiene mas de diez piezas');
   end if;
  end if;
  return cantidad_de_piezas;
end;
/

CREATE OR REPLACE function COMPRUEBA_PIEZA(id number) return number as
es_avion number(10);
es_compuesta number(10);
cantidad_de_piezas number(10);
begin
  select count(identificador) into es_avion from aviones where identificador=id;
  if es_avion>0 then
    raise_application_error(-20003, 'Es un avion');
  else
    select count(identificador) into es_compuesta from piezas_compuestas where identificador=id;
    if es_compuesta=0 then
      raise_application_error(-20005, 'No es compuesta');
    else  
      select count(identificador) into cantidad_de_piezas from piezas_simples where id_pieza_contenedora=id;
      if cantidad_de_piezas>4 then
        raise_application_error(-20004, 'Hay mas de cuatro piezas');
      end if;
    end if;
  end if;
  return cantidad_de_piezas;
end;
/


-- Informe de Resumen de Oracle SQL Developer Data Modeler: 
-- 
-- CREATE TABLE                             4
-- CREATE INDEX                             5
-- ALTER TABLE                             15
-- CREATE VIEW                              1
-- CREATE PACKAGE                           0
-- CREATE PACKAGE BODY                      0
-- CREATE PROCEDURE                         7
-- CREATE FUNCTION                          2
-- CREATE TRIGGER                           4
-- ALTER TRIGGER                            0
-- CREATE STRUCTURED TYPE                   0
-- CREATE COLLECTION TYPE                   0
-- CREATE CLUSTER                           0
-- CREATE CONTEXT                           0
-- CREATE DATABASE                          0
-- CREATE DIMENSION                         0
-- CREATE DIRECTORY                         0
-- CREATE DISK GROUP                        0
-- CREATE ROLE                              0
-- CREATE ROLLBACK SEGMENT                  0
-- CREATE SEQUENCE                          2
-- CREATE MATERIALIZED VIEW                 0
-- CREATE SYNONYM                           0
-- CREATE TABLESPACE                        0
-- CREATE USER                              1
-- 
-- DROP TABLESPACE                          0
-- DROP DATABASE                            0
-- 
-- ERRORS                                   0
-- WARNINGS                                 0
drop user cloeches cascade;
 
 create user cloeches identified by cloeches;
 grant resource,connect, create view, create procedure to cloeches;
 connect cloeches/cloeches;
 @cloeches.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:00 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user cloeches cascade
            *
ERROR at line 1:
ORA-01918: user 'CLOECHES' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table altered.


Index created.


Table altered.


Table created.


Index created.


Table altered.


1 row created.


1 row created.


1 row created.


1 row created.


1 row created.


1 row created.


Table created.


Table altered.


Index created.


Table altered.


Table created.


Table altered.


Table altered.


Table altered.


Index created.


Index created.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Trigger created.


Trigger created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000
Avion 1 						   2000
  Cabina						     10        2000
    Asiento piloto					     11 	 10
      Asiento1		       SN-1008	  PN-002	     12 	 11
      Controles 	       SN-1009	  PN-003	     13 	 11
    Asiento 2		       SN-10010   PN-002	     14 	 10
    Asiento 3		       SN-10011   PN-002	     15 	 10
  Fuselaje		       SN-10012   PN-001	     16        2000
  Motor 1		       SN-10013   PN-004	     17        2000
  Motor 2		       SN-10014   PN-004	     18        2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.

  call intenta_crear_avion_masde4(3000)
       *
ERROR at line 1:
ORA-00001: unique constraint (CLOECHES.SERIALNUMBER_UNIQUE) violated
ORA-06512: at "CLOECHES.INTENTA_CREAR_AVION_MASDE4", line 6



NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000
Avion 1 						   2000
  Cabina						     10        2000
    Asiento piloto					     11 	 10
      Asiento1		       SN-1008	  PN-002	     12 	 11
      Controles 	       SN-1009	  PN-003	     13 	 11
    Asiento 2		       SN-10010   PN-002	     14 	 10
    Asiento 3		       SN-10011   PN-002	     15 	 10
  Fuselaje		       SN-10012   PN-001	     16        2000
  Motor 1		       SN-10013   PN-004	     17        2000
  Motor 2		       SN-10014   PN-004	     18        2000

20 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000
Avion 1 						   2000
  Cabina						     10        2000
    Asiento piloto					     11 	 10
      Asiento1		       SN-1008	  PN-002	     12 	 11
      Controles 	       SN-1009	  PN-003	     13 	 11
    Asiento 2		       SN-10010   PN-002	     14 	 10
    Asiento 3		       SN-10011   PN-002	     15 	 10
  Fuselaje		       SN-10012   PN-001	     16        2000
  Motor 1		       SN-10013   PN-004	     17        2000
  Motor 2		       SN-10014   PN-004	     18        2000

20 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000
Avion 1 						   2000
  Cabina						     10        2000
    Asiento piloto					     11 	 10
      Asiento1		       SN-1008	  PN-002	     12 	 11
      Controles 	       SN-1009	  PN-003	     13 	 11
    Asiento 2		       SN-10010   PN-002	     14 	 10
    Asiento 3		       SN-10011   PN-002	     15 	 10
  Fuselaje		       SN-10012   PN-001	     16        2000
  Motor 1		       SN-10013   PN-004	     17        2000
  Motor 2		       SN-10014   PN-004	     18        2000

20 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1001	  PN-001	      1        1000
  Cabina						      2        1000
    Asiento piloto					      3 	  2
      Asiento1		       SN-1002	  PN-002	      4 	  3
      Controles 	       SN-1003	  PN-003	      5 	  3
    Asiento 2		       SN-1004	  PN-002	      6 	  2
    Asiento 3		       SN-1005	  PN-002	      7 	  2
  Motor 1		       SN-1006	  PN-004	      8        1000
  Motor 2		       SN-1007	  PN-004	      9        1000
Avion 1 						   2000
  Cabina						     10        2000
    Asiento piloto					     11 	 10
      Asiento1		       SN-1008	  PN-002	     12 	 11
      Controles 	       SN-1009	  PN-003	     13 	 11
    Asiento 2		       SN-10010   PN-002	     14 	 10
    Asiento 3		       SN-10011   PN-002	     15 	 10
  Fuselaje		       SN-10012   PN-001	     16        2000
  Motor 1		       SN-10013   PN-004	     17        2000
  Motor 2		       SN-10014   PN-004	     18        2000
Avion 3 						   5000
  Fuselaje		       SN-10019   PN-001	     20        5000
  Cabina						     21        5000
    Asiento piloto					     22 	 21
      Asiento 11	       SN-10020   PN-002	     23 	 22
      Controles 	       SN-10021   PN-003	     24 	 22
    Asiento copiloto					     25 	 21
      Asiento 12	       SN-10022   PN-002	     26 	 25
      Controles 	       SN-10023   PN-003	     27 	 25
  Motor 5		       SN-10024   PN-004	     28        5000
  Motor 6		       SN-10025   PN-004	     29        5000
  Motor 7		       SN-10026   PN-004	     30        5000
  Motor 8		       SN-10027   PN-004	     31        5000
  Caja negra		       SN-10028   PN-005	     32        5000
  GPS			       SN-10029   PN-006	     33        5000

35 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
---------------------
		    7

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20002: No es un avion
ORA-06512: at "CLOECHES.COMPRUEBA_AVION", line 9


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20001: El avion tiene mas de diez piezas
ORA-06512: at "CLOECHES.COMPRUEBA_AVION", line 13


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   creina
****************************************************
****************************************************
****************************************************
-- Generado por Oracle SQL Developer Data Modeler 3.1.4.710
--   en:        2013-04-23 13:32:51 CEST
--   sitio:      Oracle Database 10g
--   tipo:      Oracle Database 10g



CREATE TABLE PIEZA (ID_PIEZA NUMBER (6)  NOT NULL ,ID_PIEZA_CONTENEDORA NUMBER (6) ,NOMBRE VARCHAR2 (20 BYTE)  NOT NULL ,SN VARCHAR2 (40 BYTE) ,PN VARCHAR2 (40 BYTE))TABLESPACE USERS LOGGING;

CREATE UNIQUE INDEX PIEZA_PK ON PIEZA (ID_PIEZA ASC)TABLESPACE USERS LOGGING;

ALTER TABLE PIEZA ADD CONSTRAINT PIEZA_PK PRIMARY KEY ( ID_PIEZA ) USING INDEX PIEZA_PK;


ALTER TABLE PIEZA ADD CONSTRAINT PIEZA_PIEZA_FK1 FOREIGN KEY(ID_PIEZA)REFERENCES PIEZA(ID_PIEZA)ON DELETE CASCADE NOT DEFERRABLE;

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS SELECT ID_PIEZA as PARTE_ID, ID_PIEZA_CONTENEDORA as PARTE_PADRE, NOMBRE as NOMBRE, SN as SN, PN as PN FROM pieza ;


CREATE SEQUENCE SECUENCIA_PIEZA_ID INCREMENT BY 1 MAXVALUE 999999999999999999999999999 MINVALUE 1 CACHE 20 ORDER;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER INCREMENT BY 1 MAXVALUE 999999999999999999999999999 MINVALUE 1 CACHE 20 ORDER ;

CREATE OR REPLACE TRIGGER DISPARADOR_ID 
    BEFORE INSERT ON PIEZA 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID_PIEZA" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID_PIEZA" from dual; 
      end if; 
   end if; 
end;
 
/
CREATE OR REPLACE TRIGGER DISPARADOR_SN 
    BEFORE INSERT ON PIEZA 
    FOR EACH ROW 
begin  
   if inserting then     
      if :NEW."SN" is null and :NEW."PN" is not null then  
      select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SN" from dual; 
      end if; 
   end if; 
end; 
/
CREATE OR REPLACE PROCEDURE BORRAR_AVION
(PADRE_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) 
IS
BEGIN
 for j in (select ID_PIEZA
            FROM pieza
            START WITH id_pieza=PADRE_ID_PIEZA
            CONNECT BY PRIOR ID_PIEZA=id_pieza_contenedora)
LOOP
            
    DELETE From pieza
    WHERE id_pieza= j.id_pieza;
    
    end loop;
END BORRAR_AVION;
/

CREATE OR REPLACE PROCEDURE COPIAR_HIJOS_DE_PIEZA 
(PIEZA_ID IN NUMBER, 
  PIEZA_COPIA_ID IN NUMBER) AS 
  PIEZA_EXISTENTE PIEZA%ROWTYPE;
  
  parte_recien_creada number;

BEGIN
  for PIEZA_EXISTENTE in (select * from PIEZA where id_pieza_contenedora=pieza_id)
  loop

    INSERT INTO PIEZA(ID_PIEZA, NOMBRE, id_pieza_contenedora, sn, PN)
    VALUES(NULL, PIEZA_EXISTENTE.nombre, PIEZA_COPIA_ID, NULL, PIEZA_EXISTENTE.PN );
    
    select SECUENCIA_PIEZA_ID.currval into parte_recien_creada from dual;
    COPIAR_HIJOS_DE_PIEZA(PIEZA_EXISTENTE.ID_PIEZA, parte_recien_creada);
  end loop;
                        
END COPIAR_HIJOS_DE_PIEZA;
/
CREATE OR REPLACE PROCEDURE COPIAR_AVION 
  (AVION_ID IN NUMBER, 
   COPIA_AVION_ID IN NUMBER) AS 
  AVION_EXISTENTE PIEZA%ROWTYPE;
  
BEGIN

  SELECT * INTO AVION_EXISTENTE
  FROM PIEZA
  WHERE ID_PIEZA = AVION_ID;
  
  INSERT INTO PIEZA(id_pieza, NOMBRE, id_pieza_contenedora, sn, PN)
  VALUES(COPIA_AVION_ID,AVION_existente.nombre, null,  null, NULL );
  
  COPIAR_HIJOS_DE_PIEZA(AVION_ID, COPIA_AVION_ID);
  
END COPIAR_AVION;
/

CREATE OR REPLACE PROCEDURE CREAR_AVION
(NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS 
BEGIN 
insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
VALUES (nuevo_id_pieza, null, 'Avion 1', null, null);
  
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', null, 'PN-001'); 
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);
  
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
      
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento1', null, 'PN-002');
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
          
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento2', null, 'PN-002');
      
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+7, nuevo_id_pieza+2, 'Asiento3', null, 'PN-002');
      
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+8, nuevo_id_pieza, 'Motor1', null, 'PN-004');   
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+9, nuevo_id_pieza, 'Motor2', null, 'PN-004'); 
  
END CREAR_AVION;
/
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10 
(NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS
BEGIN
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza, null, 'Avion  3', null, null);
    
        insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
        VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', null, 'PN-001'); 
        insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
        VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);

          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
          
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento11', null, 'PN-002');
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
              
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento Copiloto', null, null);
          
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+7, nuevo_id_pieza+3, 'Asiento12', null, 'PN-002');
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+8, nuevo_id_pieza+3, 'controles', null, 'PN-003');
              
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+9, nuevo_id_pieza, 'Motor5', null, 'PN-004');   
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+10, nuevo_id_pieza, 'Motor6', null, 'PN-004'); 
    
     insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+11, nuevo_id_pieza, 'Motor7', null, 'PN-004');   
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+12, nuevo_id_pieza, 'Motor8', null, 'PN-004');
    
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+13, nuevo_id_pieza, 'Caja Negra', null, 'PN-004');
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+14, nuevo_id_pieza, 'GPS', null, 'PN-004');
  NULL;
  
END INTENTA_CREAR_AVION_MASDE10;
/
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4 (NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS 
BEGIN
insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
VALUES (nuevo_id_pieza, null, 'Avion 2', null, null);
 insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', 'SN-1008', 'PN-001'); 
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);
  
     insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
      
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento11', null, 'PN-002');
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
          
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento5', null, 'PN-002');
      
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+7, nuevo_id_pieza+2, 'Asiento6', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+8, nuevo_id_pieza+2, 'Asiento7', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+9, nuevo_id_pieza+2, 'Asiento8', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+10, nuevo_id_pieza+2, 'Asiento9', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+11, nuevo_id_pieza+2, 'Asiento10', null, 'PN-002');
      
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+12, nuevo_id_pieza, 'Motor1', null, 'PN-004');   
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+13, nuevo_id_pieza, 'Motor2', null, 'PN-004'); 
  
END INTENTA_CREAR_AVION_MASDE4 ;
/
CREATE OR REPLACE FUNCTION COMPRUEBA_AVION(PADRE_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) RETURN varchar2 AS 
cantidad Number;

BEGIN
cantidad := 0;
 for j in (select id_pieza_contenedora , sn
           FROM pieza
          START WITH id_pieza=PADRE_ID_PIEZA
          CONNECT BY PRIOR ID_PIEZA=id_pieza_contenedora)
LOOP   
        if j.sn is not null then
           cantidad := cantidad +1;
        end if; 
        if cantidad > 10 then
          raise_application_error (-20001,'Este avion contiene demasiadas piezas simples.');
        end if;   
    end loop;
  RETURN 'Este avion no excede de piezas simples';
END COMPRUEBA_AVION;
/
CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA RETURN varchar2 AS 
cantidad Number;
piezaCompuesta Number;
BEGIN
piezaCompuesta :=0;
cantidad := 0;
 for j in (select id_pieza_contenedora, sn
            FROM pieza
             order by id_pieza_contenedora)
LOOP   
      if piezaCompuesta <> j.id_pieza_contenedora then  
        piezaCompuesta := j.id_pieza_contenedora;
         cantidad := 0;
      end if;
        if j.sn is not null then
           cantidad := cantidad +1;
        end if; 
        if cantidad > 4 then
          raise_application_error (-20001,'Este conjunto de piezas contiene demasiadas piezas simples.');
        end if;  
    end loop;
  RETURN 'No excede de piezas simples.';
END COMPRUEBA_PIEZA;
/
CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS BEGIN
Delete
from pieza;
END BORRAR_AVIONES;
/

-- Informe de Resumen de Oracle SQL Developer Data Modeler: 
-- 
-- CREATE TABLE                             1
-- CREATE INDEX                             1
-- ALTER TABLE                              2
-- CREATE VIEW                              1
-- CREATE PACKAGE                           0
-- CREATE PACKAGE BODY                      0
-- CREATE PROCEDURE                         7
-- CREATE FUNCTION                          2
-- CREATE TRIGGER                           2
-- ALTER TRIGGER                            0
-- CREATE STRUCTURED TYPE                   0
-- CREATE COLLECTION TYPE                   0
-- CREATE CLUSTER                           0
-- CREATE CONTEXT                           0
-- CREATE DATABASE                          0
-- CREATE DIMENSION                         0
-- CREATE DIRECTORY                         0
-- CREATE DISK GROUP                        0
-- CREATE ROLE                              0
-- CREATE ROLLBACK SEGMENT                  0
-- CREATE SEQUENCE                          2
-- CREATE MATERIALIZED VIEW                 0
-- CREATE SYNONYM                           0
-- CREATE TABLESPACE                        0
-- CREATE USER                              0
-- 
-- DROP TABLESPACE                          0
-- DROP DATABASE                            0
-- 
-- ERRORS                                   0
-- WARNINGS                                 0
drop user creina cascade;
 
 create user creina identified by creina;
 grant resource,connect, create view, create procedure to creina;
 connect creina/creina;
 @creina.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:01 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user creina cascade
            *
ERROR at line 1:
ORA-01918: user 'CREINA' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Index created.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       3000
  Fuselaje		       SN-1008					PN-001					       3001	   3000
  Cabina													       3002	   3000
    Asiento Piloto												       3003	   3002
      Asiento11 	       SN-15					PN-002					       3004	   3003
      controles 	       SN-16					PN-003					       3005	   3003
    Asiento5		       SN-17					PN-002					       3006	   3002
    Asiento6		       SN-18					PN-002					       3007	   3002
    Asiento7		       SN-19					PN-002					       3008	   3002
    Asiento8		       SN-20					PN-002					       3009	   3002
    Asiento9		       SN-21					PN-002					       3010	   3002
    Asiento10		       SN-22					PN-002					       3011	   3002
  Motor1		       SN-23					PN-004					       3012	   3000
  Motor2		       SN-24					PN-004					       3013	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       3000
  Fuselaje		       SN-1008					PN-001					       3001	   3000
  Cabina													       3002	   3000
    Asiento Piloto												       3003	   3002
      Asiento11 	       SN-15					PN-002					       3004	   3003
      controles 	       SN-16					PN-003					       3005	   3003
    Asiento5		       SN-17					PN-002					       3006	   3002
    Asiento6		       SN-18					PN-002					       3007	   3002
    Asiento7		       SN-19					PN-002					       3008	   3002
    Asiento8		       SN-20					PN-002					       3009	   3002
    Asiento9		       SN-21					PN-002					       3010	   3002
    Asiento10		       SN-22					PN-002					       3011	   3002
  Motor1		       SN-23					PN-004					       3012	   3000
  Motor2		       SN-24					PN-004					       3013	   3000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000
Avion  3													       5000
  Fuselaje		       SN-36					PN-001					       5001	   5000
  Cabina													       5002	   5000
    Asiento Piloto												       5003	   5002
      Asiento11 	       SN-37					PN-002					       5004	   5003
      controles 	       SN-38					PN-003					       5005	   5003
      Asiento12 	       SN-39					PN-002					       5007	   5003
      controles 	       SN-40					PN-003					       5008	   5003
    Asiento Copiloto												       5006	   5002
  Motor5		       SN-41					PN-004					       5009	   5000
  Motor6		       SN-42					PN-004					       5010	   5000
  Motor7		       SN-43					PN-004					       5011	   5000
  Motor8		       SN-44					PN-004					       5012	   5000
  Caja Negra		       SN-45					PN-004					       5013	   5000
  GPS			       SN-46					PN-004					       5014	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Este avion no excede de piezas simples

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20001: Este avion contiene demasiadas piezas simples.
ORA-06512: at "CREINA.COMPRUEBA_AVION", line 15


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20001: Este avion contiene demasiadas piezas simples.
ORA-06512: at "CREINA.COMPRUEBA_AVION", line 15


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   dmorera
****************************************************
****************************************************
****************************************************
-- Generado por Oracle SQL Developer Data Modeler 3.1.3.706
--   en:        2013-04-24 20:25:34 CEST
--   sitio:      Oracle Database 10g
--   tipo:      Oracle Database 10g



--CREATE USER PRUEBAS 
--    IDENTIFIED BY  
--    ACCOUNT UNLOCK 
--;

CREATE TABLE AVIONES 
    ( 
     NAVION NUMBER (10)  NOT NULL , 
     NOMBRE VARCHAR2 (10 BYTE) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;


CREATE UNIQUE INDEX PK_AVIONES ON AVIONES 
    ( 
     NAVION ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE AVIONES 
    ADD CONSTRAINT PK_AVIONES PRIMARY KEY ( NAVION ) 
    USING INDEX PK_AVIONES ;



CREATE TABLE PARTNUMBER 
    ( 
     IDPARTNUMBER VARCHAR2 (10 BYTE)  NOT NULL , 
     NOMBRE VARCHAR2 (10 BYTE) , 
     IDENTIFICADOR NUMBER (10) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;


CREATE UNIQUE INDEX PK_PN ON PARTNUMBER 
    ( 
     IDPARTNUMBER ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PARTNUMBER 
    ADD CONSTRAINT PK_PN PRIMARY KEY ( IDPARTNUMBER ) 
    USING INDEX PK_PN ;



CREATE TABLE PIEZASCOMPUESTAS 
    ( 
     IDCOMPUESTO NUMBER (10) , 
     NAVION NUMBER (10) , 
     NOMBRE VARCHAR2 (30 BYTE) , 
     IDENTIFICADOR NUMBER (10)  NOT NULL 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;


CREATE UNIQUE INDEX PK_PC ON PIEZASCOMPUESTAS 
    ( 
     IDENTIFICADOR ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PIEZASCOMPUESTAS 
    ADD CONSTRAINT PK_PC PRIMARY KEY ( IDENTIFICADOR ) 
    USING INDEX PK_PC ;



CREATE TABLE PIEZASSIMPLES 
    ( 
     IDENTIFICADOR NUMBER (10)  NOT NULL , 
     SERIALNUMBER VARCHAR2 (10 BYTE) , 
     NAVION NUMBER (10)  NOT NULL , 
     IDPARTNUMBER VARCHAR2 (10 BYTE) , 
     IDCOMPUESTO NUMBER (10) , 
     NOMBRE VARCHAR2 (10 BYTE) 
    ) 
        PCTFREE 10 
        PCTUSED 40 
        MAXTRANS 255 
        TABLESPACE USERS 
        LOGGING 
        STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT 
    ) 
;


CREATE UNIQUE INDEX PK_PS ON PIEZASSIMPLES 
    ( 
     IDENTIFICADOR ASC 
    ) 
    TABLESPACE USERS 
    PCTFREE 10 
    MAXTRANS 255 
    STORAGE ( 
        INITIAL 65536 
        PCTINCREASE 0 
        MINEXTENTS 1 
        MAXEXTENTS 2147483645 
        FREELISTS 1 
        FREELIST GROUPS 1 
        BUFFER_POOL DEFAULT ) 
    LOGGING 
;

ALTER TABLE PIEZASSIMPLES 
    ADD CONSTRAINT PK_PS PRIMARY KEY ( IDENTIFICADOR ) 
    USING INDEX PK_PS ;




ALTER TABLE PIEZASSIMPLES 
    ADD CONSTRAINT FK2_PS FOREIGN KEY 
    ( 
     IDCOMPUESTO
    ) 
    REFERENCES PIEZASCOMPUESTAS 
    ( 
     IDENTIFICADOR
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZASSIMPLES 
    ADD CONSTRAINT FK3_PS FOREIGN KEY 
    ( 
     IDPARTNUMBER
    ) 
    REFERENCES PARTNUMBER 
    ( 
     IDPARTNUMBER
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZASCOMPUESTAS 
    ADD CONSTRAINT FK_PC FOREIGN KEY 
    ( 
     NAVION
    ) 
    REFERENCES AVIONES 
    ( 
     NAVION
    ) 
    NOT DEFERRABLE 
;


ALTER TABLE PIEZASSIMPLES 
    ADD CONSTRAINT FK_PS FOREIGN KEY 
    ( 
     NAVION
    ) 
    REFERENCES AVIONES 
    ( 
     NAVION
    ) 
    NOT DEFERRABLE 
;

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS
SELECT  NAVION PARTE_ID,NULL PARTE_PADRE,NOMBRE NOMBRE, NULL SN,NULL PN FROM AVIONES
UNION
SELECT IDENTIFICADOR PARTE_ID, IDCOMPUESTO PARTE_PADRE,NOMBRE NOMBRE,SERIALNUMBER SN,IDPARTNUMBER PN FROM PIEZASSIMPLES
WHERE IDCOMPUESTO IS NOT NULL
UNION
SELECT IDENTIFICADOR PARTE_ID, NAVION PARTE_PADRE,NOMBRE NOMBRE, SERIALNUMBER SN,IDPARTNUMBER PN FROM PIEZASSIMPLES
WHERE IDCOMPUESTO IS NULL
UNION 
SELECT IDENTIFICADOR PARTE_ID,IDCOMPUESTO  PARTE_PADRE, NOMBRE NOMBRE,NULL SN, NULL PN FROM PIEZASCOMPUESTAS
WHERE IDCOMPUESTO IS NOT NULL 
UNION
SELECT IDENTIFICADOR PARTE_ID,NAVION  PARTE_PADRE, NOMBRE NOMBRE,NULL SN, NULL PN FROM PIEZASCOMPUESTAS
WHERE IDCOMPUESTO IS NULL ;



CREATE SEQUENCE SECUENCIA_PIEZA_ID 
    INCREMENT BY 1 
    MAXVALUE 999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER 
    INCREMENT BY 1 
    MAXVALUE 999 
    MINVALUE 1 
    CACHE 20 
    ORDER 
;

CREATE OR REPLACE TRIGGER CREACION_ID_PIEZA 
    BEFORE INSERT ON AVIONES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."NAVION" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."NAVION" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER DISPARADOR_DE_PIEZAS_SIMPLES 
    BEFORE INSERT ON PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER DISPARADOR_PIEZAS_COMPUESTAS 
    BEFORE INSERT ON PRUEBAS.PIEZASCOMPUESTAS 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."IDENTIFICADOR" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."IDENTIFICADOR" from dual; 
      end if; 
   end if; 
end;
 
/


CREATE OR REPLACE TRIGGER DISPARADOR_SERIALNUMBER 
    BEFORE INSERT ON PRUEBAS.PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."SERIALNUMBER" is null then 
         select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIALNUMBER" from dual; 
      end if; 
   end if; 
end; 
/



CREATE OR REPLACE PROCEDURE BORRAR_AVION (AVION_ID IN NUMBER) AS 
ID_AVION NUMBER;
BEGIN
ID_AVION:=AVION_ID;
DELETE FROM PIEZASSIMPLES WHERE NAVION=ID_AVION;
DELETE FROM PIEZASCOMPUESTAS WHERE NAVION=ID_AVION;
DELETE FROM AVIONES WHERE NAVION=ID_AVION;
END BORRAR_AVION;
/

CREATE OR REPLACE PROCEDURE BORRAR_AVIONES  AS 
BEGIN
DELETE FROM PIEZASSIMPLES;
DELETE FROM PIEZASCOMPUESTAS;
DELETE FROM AVIONES;
END BORRAR_AVIONES;
/


CREATE OR REPLACE PROCEDURE COPIA_PIEZA(ID_SIMPLE IN NUMBER,ID_COPIA_SIMPLES IN NUMBER) AS 
PARTE_EXISTE PIEZASSIMPLES%ROWTYPE;
PARTE_YA_CREADA NUMBER;
BEGIN
FOR PARTE_EXISTE IN (SELECT * FROM PIEZASSIMPLES WHERE IDCOMPUESTO=ID_SIMPLE
                  UNION
                  SELECT * FROM PIEZASSIMPLES WHERE NAVION=ID_SIMPLE)
LOOP
  INSERT INTO PIEZASSIMPLES(navion,NOMBRE) VALUES(ID_COPIA_SIMPLES,PARTE_EXISTE.NOMBRE);
  select SECUENCIA_PIEZA_ID.currval into PARTE_YA_CREADA from dual;
    COPIA_PIEZA(PARTE_EXISTE.IDENTIFICADOR,PARTE_YA_CREADA);
  end loop;
END COPIA_PIEZA;
/

CREATE OR REPLACE PROCEDURE COPIAR_AVION (AVION_ID IN NUMBER  , COPIA_AVION_ID IN NUMBER  ) AS 
AVION_EXISTENTE AVIONES%ROWTYPE;
BEGIN
  SELECT * INTO AVION_EXISTENTE FROM aviones WHERE NAVION = AVION_ID;
  INSERT INTO aviones(NAVION,NOMBRE) VALUES(copia_avion_id,AVION_EXISTENTE.nombre);
  COPIA_PIEZA(AVION_ID, COPIA_AVION_ID);
END COPIAR_AVION;
/





CREATE OR REPLACE PROCEDURE CREAR_AVION (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION1
');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10001',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10002',I,'PN-002','Asiento 1');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10003',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10004',I,'PN-002','Asiento 2');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10005',I,'PN-002','Asiento 3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10006',I,'PN-004','Motor 1');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10007',I,'PN-004','Motor 2');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
END CREAR_AVION;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10 (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10019',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10020',I,'PN-002','Asiento 11');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10021',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10022',I,'PN-002','Asiento 12');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10023',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10024',I,'PN-004','Motor 5');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10025',I,'PN-004','Motor 6');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10026',I,'PN-004','Motor 7');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10027',I,'PN-004','Motor 8');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10028',I,'PN-005','Caja negra');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10029',I,'PN-006','Gps');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(11,I,'Asiento piloto');
END INTENTA_CREAR_AVION_MASDE10;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4 (AVION_ID IN NUMBER) AS 
I NUMBER:=avion_id;
BEGIN
INSERT INTO AVIONES(NAVION,NOMBRE) VALUES(I,'AVION2');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10008',I,'PN-001','FUSELAJE');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10009',I,'PN-002','Asiento 4');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10010',I,'PN-003','Controles');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10011',I,'PN-002','Asiento 5');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10012',I,'PN-002','Asiento 6');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10013',I,'PN-002','Asiento 7');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10014',I,'PN-002','Asiento 8');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10015',I,'PN-002','Asiento 9');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10016',I,'PN-002','Asiento 10');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10017',I,'PN-004','Motor 3');
INSERT INTO piezassimples(SERIALNUMBER,NAVION,IDPARTNUMBER,NOMBRE) VALUES('SN-10018',I,'PN-004','Motor 4');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(1,I,'Cabina');
INSERT INTO piezascompuestas(idcompuesto,navion,nombre) VALUES(10,I,'Asiento piloto');
END INTENTA_CREAR_AVION_MASDE4;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_AVION(ID number) RETURN varchar2 AS 
NUMEROPIEZAS NUMBER(10);
ID_NO NUMBER(10):=ID;
EX EXCEPTION;
EX2 EXCEPTION;
  BEGIN
    SELECT COUNT(identificador) INTO NUMEROPIEZAS FROM piezassimples; 
    IF NUMEROPIEZAS>10 THEN
      RAISE EX;
    END IF;
    SELECT NAVION INTO ID_NO FROM aviones WHERE navion=ID;
    IF ID_NO<>ID THEN
      RAISE EX2;
    END IF ;
    EXCEPTION 
      WHEN EX2 THEN
         DBMS_OUTPUT.PUT_LINE('DEMASIADAS PIEZAS');
    RETURN numeropiezas;
  END;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA(ID number) RETURN VARCHAR2 AS 
NUMEROPIEZAS NUMBER(10);
IDAVION NUMBER(10);
EX exception;
BEGIN
select count(identificador) INTO NUMEROPIEZAS from piezascompuestas WHERE numeropiezas=ID;
  IF NUMEROPIEZAS>4 THEN
  RAISE EX;
  END IF;
  IF IDAVION <> id THEN
    RAISE EX;
  END IF;
  RETURN NUMEROPIEZAS;
  EXCEPTION WHEN EX THEN
  DBMS_OUTPUT.PUT_LINE('ERROR');
END;
/


-- Informe de Resumen de Oracle SQL Developer Data Modeler: 
-- 
-- CREATE TABLE                             4
-- CREATE INDEX                             4
-- ALTER TABLE                              8
-- CREATE VIEW                              1
-- CREATE PACKAGE                           0
-- CREATE PACKAGE BODY                      0
-- CREATE PROCEDURE                         7
-- CREATE FUNCTION                          2
-- CREATE TRIGGER                           4
-- ALTER TRIGGER                            0
-- CREATE STRUCTURED TYPE                   0
-- CREATE COLLECTION TYPE                   0
-- CREATE CLUSTER                           0
-- CREATE CONTEXT                           0
-- CREATE DATABASE                          0
-- CREATE DIMENSION                         0
-- CREATE DIRECTORY                         0
-- CREATE DISK GROUP                        0
-- CREATE ROLE                              0
-- CREATE ROLLBACK SEGMENT                  0
-- CREATE SEQUENCE                          2
-- CREATE MATERIALIZED VIEW                 0
-- CREATE SYNONYM                           0
-- CREATE TABLESPACE                        0
-- CREATE USER                              1
-- 
-- DROP TABLESPACE                          0
-- DROP DATABASE                            0
-- 
-- ERRORS                                   0
-- WARNINGS                                 0
drop user dmorera cascade;
 
 create user dmorera identified by dmorera;
 grant resource,connect, create view, create procedure to dmorera;
 connect dmorera/dmorera;
 @dmorera.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:02 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user dmorera cascade
            *
ERROR at line 1:
ORA-01918: user 'DMORERA' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Index created.


Table altered.


Table created.


Index created.


Table altered.


Table created.


Index created.


Table altered.


Table created.


Index created.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.

    BEFORE INSERT ON PRUEBAS.PIEZASCOMPUESTAS
                             *
ERROR at line 2:
ORA-00942: table or view does not exist


    BEFORE INSERT ON PRUEBAS.PIEZASSIMPLES
                             *
ERROR at line 2:
ORA-00942: table or view does not exist



Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.

  call crear_avion(1000)
       *
ERROR at line 1:
ORA-02291: integrity constraint (DMORERA.FK3_PS) violated - parent key not found
ORA-06512: at "DMORERA.CREAR_AVION", line 6



no rows selected

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


no rows selected

****************Crear avion 3000 (mas de 4)

Call completed.

  call intenta_crear_avion_masde4(3000)
       *
ERROR at line 1:
ORA-02291: integrity constraint (DMORERA.FK3_PS) violated - parent key not found
ORA-06512: at "DMORERA.INTENTA_CREAR_AVION_MASDE4", line 5



no rows selected

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


no rows selected

****************Borrar avion 3000

Call completed.


Call completed.


no rows selected

****************Crear avion 5000 (mas de 10)

Call completed.

  call intenta_crear_avion_masde10(5000)
       *
ERROR at line 1:
ORA-02291: integrity constraint (DMORERA.FK3_PS) violated - parent key not found
ORA-06512: at "DMORERA.INTENTA_CREAR_AVION_MASDE10", line 5



no rows selected

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


*****************Es correcto el avion 4000

Call completed.


COMPRUEBA_AVION(4000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


*****************Es correcto el avion 5000

Call completed.


COMPRUEBA_AVION(5000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   dparra
****************************************************
****************************************************
****************************************************
--Trabajo de Daniel Parra Crespo

--Creo la tabla de las piezas
create table piezas(
  serialNumber varchar2(10),
  partNumber varchar2(10),
  nombre Varchar2(20),
  id number(10),
  idPadre number(10));

alter table piezas add constraint piezas_pk primary Key(id);

--creo la SECUENCIA_AVION_ID

CREATE SEQUENCE  "SECUENCIA_AVION_ID"  MINVALUE 1 MAXVALUE 99 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE ;

--creo la SECUENCIA_SERIALNUMBER

CREATE SEQUENCE  "SECUENCIA_SERIALNUMBER"  MINVALUE 1000 MAXVALUE 9999999999 INCREMENT BY 1 START WITH 1000 CACHE 20 NOORDER  NOCYCLE ;

--creo la SECUENCIA_PIEZA_ID

CREATE SEQUENCE  "SECUENCIA_PIEZA_ID"  MINVALUE 100 MAXVALUE 9999999999 INCREMENT BY 1 START WITH 100 CACHE 20 NOORDER  NOCYCLE ;

--creo el trigger para meter SERIAL NUMBERS

CREATE OR REPLACE TRIGGER TRIGGER_SERIAL_NUMBER 
BEFORE INSERT ON PIEZAS 
  FOR EACH ROW
DECLARE
  serialNumber varchar2(3);
BEGIN
  serialNumber := 'SN-';
  IF INSERTING THEN
    IF :NEW."PARTNUMBER" is not null THEN 
      select serialNumber || SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIALNUMBER" from dual;
    end if;
  end if;
END;
/

--creo el trigger para crear el id del avion o de la pieza

create or replace 
trigger TRIGGER_ID 
BEFORE INSERT ON PIEZAS 
FOR EACH ROW
BEGIN
  if inserting then 
    if :NEW."IDPADRE" is null then
      if :NEW."ID" is null then
        select SECUENCIA_AVION_ID.nextval into :NEW."ID" from dual;
      end if;
    else
      select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual;
    end if;
  end if;
END;
/

--creo la funcion de no meter mas de 10 piezas en un avion( COMPRUEBA_AVION)

create or replace 
FUNCTION COMPRUEBA_AVION(idavion number) 
RETURN number AS 
  npiezas number;
  padreid number;
BEGIN
select idpadre into padreid from piezas where id = idavion;
if padreid is null then
  select count(nombre) into npiezas from piezas where serialnumber is not null start with id = idavion connect by prior id = idpadre;
  if npiezas > 10 then 
    raise_application_error(-20010, 'Avion de mas de 10 piezas simples');
  end if;
else
  raise_application_error(-20010, 'Este id no es de un avion');
end if;
END;
/

--creo la funcion de no tener mas de 4 piezas en una pieza compuesta(COMPRUEBA_PIEZA)
  
create or replace 
FUNCTION COMPRUEBA_PIEZA (idpieza number) 
RETURN number AS 
   npiezas number;
   padreid number;
BEGIN
select idpadre into padreid from piezas where id = idpieza;
if padreid is not null then
 select count(nombre) into npiezas from piezas start with id = idpieza connect by prior id = idpadre;
  if npiezas > 4 then 
    raise_application_error(-20010, 'Pieza compuesta de mas de 4 piezas simples');
  end if;
else
   raise_application_error(-20010, 'El id no es de una pieza');
end if;
END;
/
  
--creo el procedimiento CREAR_AVION

create or replace 
PROCEDURE CREAR_AVION(avion_id number) AS 
  cabina_id number;
  piloto_id number;
BEGIN
  insert into piezas (nombre, id) values ('Avion 1',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas (nombre,idpadre) values ('Cabina',avion_id);
    select secuencia_pieza_id.currval into cabina_id from dual;
      insert into piezas (nombre, idpadre) values ('Asiento piloto',cabina_id);
      select secuencia_pieza_id.currval into piloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 1','PN-002',piloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',piloto_id);
      insert into piezas (nombre, partnumber, idpadre) values ('Asiento 2','PN-002',cabina_id);
      insert into piezas (nombre, partnumber, idpadre) values ('Asiento 3','PN-002',cabina_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 1', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 2', 'PN-004',avion_id);
END;
/

--creo la vista AVIONES_PROFESOR
  
create view AVIONES_PROFESOR as
  select id as parte_id, nombre, serialNumber as SN, partNumber as PN, idPadre as parte_padre
  from piezas;
  
--creo el procedimiento BORRAR_AVION

create or replace 
PROCEDURE BORRAR_AVION (avion_id number) AS 
BEGIN
  delete from piezas where id IN (select id from piezas start with id = avion_id connect by prior id = idpadre);
END;
/

--creo el procedimiento BORRAR_AVIONES

CREATE OR REPLACE
PROCEDURE BORRAR_AVIONES AS 
BEGIN
  delete from piezas;
END;
/

--creo el copiar_hijos

create or replace 
PROCEDURE COPIAR_HIJOS (pieza_id number, pieza_copia_id number) AS  
  avion_creado piezas%ROWTYPE;
  pieza_recien_creada number;
BEGIN
  for piezas in (select * from piezas where idpadre=pieza_id)
  loop
    INSERT INTO piezas(nombre,idpadre,partnumber) VALUES(piezas.nombre, pieza_copia_id, avion_creado.partnumber );
    select SECUENCIA_PIEZA_ID.currval into pieza_recien_creada from dual;
    copiar_hijos(piezas.id,pieza_recien_creada);
  end loop;                 
END;
/

--creo el procedimiento COPIAR_AVION

create or replace 
PROCEDURE COPIAR_AVION (avion_id number, copia_avion_id number) AS 
  avion_creado piezas%ROWTYPE;
BEGIN
  SELECT * INTO avion_creado FROM piezas WHERE id = avion_id;  
  INSERT INTO piezas(id,nombre) VALUES(COPIA_AVION_ID,avion_creado.nombre); 
  copiar_hijos(avion_id, copia_avion_id);
END;
/

--creo el procedimiento INTENTA_CREAR_AVION_MASDE10

CREATE OR REPLACE
PROCEDURE INTENTA_CREAR_AVION_MASDE10 (avion_id number) AS 
  cabina_id number;
  piloto_id number;
  copiloto_id number;
BEGIN
  insert into piezas (nombre, id) values ('Avion 3',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas (nombre,idpadre) values ('Cabina',avion_id);
    select secuencia_pieza_id.currval into cabina_id from dual;
      insert into piezas (nombre, idpadre) values ('Asiento piloto',cabina_id);
      select secuencia_pieza_id.currval into piloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 11','PN-002',piloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',piloto_id);
       insert into piezas (nombre, idpadre) values ('Asiento copiloto',cabina_id);
       select secuencia_pieza_id.currval into copiloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 12','PN-002',copiloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',copiloto_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 5', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 6', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 7', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 8', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Caja negra', 'PN-005',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('GPS', 'PN-006',avion_id);
END;
/

--creo el procedimiento INTENTA_CREAR_AVION_MASDE4

CREATE OR REPLACE
PROCEDURE INTENTA_CREAR_AVION_MASDE4 (avion_id number) AS 
  cabina_id number;
  piloto_id number;
  copiloto_id number;
BEGIN
  insert into piezas (nombre, id) values ('Avion 3',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas (nombre,idpadre) values ('Cabina',avion_id);
    select secuencia_pieza_id.currval into cabina_id from dual;
      insert into piezas (nombre, idpadre) values ('Asiento piloto',cabina_id);
      select secuencia_pieza_id.currval into piloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 4','PN-002',piloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',piloto_id);
      insert into piezas (nombre, idpadre) values ('Asiento 5',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 6',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 7',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 8',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 9',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 10',cabina_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 5', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 6', 'PN-004',avion_id);
END;
/






drop user dparra cascade;
 
 create user dparra identified by dparra;
 grant resource,connect, create view, create procedure to dparra;
 connect dparra/dparra;
 @dparra.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:02 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL> 
User dropped.

SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table altered.


Sequence created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Function created.


Function created.


Procedure created.


View created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento piloto					    111 	110
      Asiento 1 					    112 	111
      Controles 					    113 	111
    Asiento 2						    114 	110
    Asiento 3						    115 	110
  Motor 1						    116        2000
  Motor 2						    117        2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento piloto					    111 	110
      Asiento 1 					    112 	111
      Controles 					    113 	111
    Asiento 2						    114 	110
    Asiento 3						    115 	110
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   3000
  Fuselaje		       SN-1007	  PN-001	    118        3000
  Cabina						    119        3000
    Asiento piloto					    120 	119
      Asiento 4 	       SN-1008	  PN-002	    121 	120
      Controles 	       SN-1009	  PN-003	    122 	120
    Asiento 5						    123 	119
    Asiento 6						    124 	119
    Asiento 7						    125 	119
    Asiento 8						    126 	119
    Asiento 9						    127 	119
    Asiento 10						    128 	119
  Motor 5		       SN-1010	  PN-004	    129        3000
  Motor 6		       SN-1011	  PN-004	    130        3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento piloto					    111 	110
      Asiento 1 					    112 	111
      Controles 					    113 	111
    Asiento 2						    114 	110
    Asiento 3						    115 	110
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   3000
  Fuselaje		       SN-1007	  PN-001	    118        3000
  Cabina						    119        3000
    Asiento piloto					    120 	119
      Asiento 4 	       SN-1008	  PN-002	    121 	120
      Controles 	       SN-1009	  PN-003	    122 	120
    Asiento 5						    123 	119
    Asiento 6						    124 	119
    Asiento 7						    125 	119
    Asiento 8						    126 	119
    Asiento 9						    127 	119
    Asiento 10						    128 	119
  Motor 5		       SN-1010	  PN-004	    129        3000
  Motor 6		       SN-1011	  PN-004	    130        3000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento piloto					    111 	110
      Asiento 1 					    112 	111
      Controles 					    113 	111
    Asiento 2						    114 	110
    Asiento 3						    115 	110
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento piloto					    102 	101
      Asiento 1 	       SN-1001	  PN-002	    103 	102
      Controles 	       SN-1002	  PN-003	    104 	102
    Asiento 2		       SN-1003	  PN-002	    105 	101
    Asiento 3		       SN-1004	  PN-002	    106 	101
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento piloto					    111 	110
      Asiento 1 					    112 	111
      Controles 					    113 	111
    Asiento 2						    114 	110
    Asiento 3						    115 	110
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000
Avion 3 						   5000
  Fuselaje		       SN-1012	  PN-001	    144        5000
  Cabina						    145        5000
    Asiento piloto					    146 	145
      Asiento 11	       SN-1013	  PN-002	    147 	146
      Controles 	       SN-1014	  PN-003	    148 	146
    Asiento copiloto					    149 	145
      Asiento 12	       SN-1015	  PN-002	    150 	149
      Controles 	       SN-1016	  PN-003	    151 	149
  Motor 5		       SN-1017	  PN-004	    152        5000
  Motor 6		       SN-1018	  PN-004	    153        5000
  Motor 7		       SN-1019	  PN-004	    154        5000
  Motor 8		       SN-1020	  PN-004	    155        5000
  Caja negra		       SN-1021	  PN-005	    156        5000
  GPS			       SN-1022	  PN-006	    157        5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.

  select COMPRUEBA_AVION(1000) from dual
         *
ERROR at line 1:
ORA-06503: PL/SQL: Function returned without value
ORA-06512: at "DPARRA.COMPRUEBA_AVION", line 15


*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-06503: PL/SQL: Function returned without value
ORA-06512: at "DPARRA.COMPRUEBA_AVION", line 15


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20010: Avion de mas de 10 piezas simples
ORA-06512: at "DPARRA.COMPRUEBA_AVION", line 10


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   egarcia
****************************************************
****************************************************
****************************************************
-- Generado por Oracle SQL Developer Data Modeler 3.1.4.710
--   en:        2013-04-23 13:32:51 CEST
--   sitio:      Oracle Database 10g
--   tipo:      Oracle Database 10g



CREATE TABLE PIEZA (ID_PIEZA NUMBER (6)  NOT NULL ,ID_PIEZA_CONTENEDORA NUMBER (6) ,NOMBRE VARCHAR2 (20 BYTE)  NOT NULL ,SN VARCHAR2 (40 BYTE) ,PN VARCHAR2 (40 BYTE))TABLESPACE USERS LOGGING;

CREATE UNIQUE INDEX PIEZA_PK ON PIEZA (ID_PIEZA ASC)TABLESPACE USERS LOGGING;

ALTER TABLE PIEZA ADD CONSTRAINT PIEZA_PK PRIMARY KEY ( ID_PIEZA ) USING INDEX PIEZA_PK;


ALTER TABLE PIEZA ADD CONSTRAINT PIEZA_PIEZA_FK1 FOREIGN KEY(ID_PIEZA)REFERENCES PIEZA(ID_PIEZA)ON DELETE CASCADE NOT DEFERRABLE;

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS SELECT ID_PIEZA as PARTE_ID, ID_PIEZA_CONTENEDORA as PARTE_PADRE, NOMBRE as NOMBRE, SN as SN, PN as PN FROM pieza ;


CREATE SEQUENCE SECUENCIA_PIEZA_ID INCREMENT BY 1 MAXVALUE 999999999999999999999999999 MINVALUE 1 CACHE 20 ORDER;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER INCREMENT BY 1 MAXVALUE 999999999999999999999999999 MINVALUE 1 CACHE 20 ORDER ;

CREATE OR REPLACE TRIGGER DISPARADOR_ID 
    BEFORE INSERT ON PIEZA 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID_PIEZA" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID_PIEZA" from dual; 
      end if; 
   end if; 
end;
 
/
CREATE OR REPLACE TRIGGER DISPARADOR_SN 
    BEFORE INSERT ON PIEZA 
    FOR EACH ROW 
begin  
   if inserting then     
      if :NEW."SN" is null and :NEW."PN" is not null then  
      select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SN" from dual; 
      end if; 
   end if; 
end; 
/
CREATE OR REPLACE PROCEDURE BORRAR_AVION
(PADRE_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) 
IS
BEGIN
 for j in (select ID_PIEZA
            FROM pieza
            START WITH id_pieza=PADRE_ID_PIEZA
            CONNECT BY PRIOR ID_PIEZA=id_pieza_contenedora)
LOOP
            
    DELETE From pieza
    WHERE id_pieza= j.id_pieza;
    
    end loop;
END BORRAR_AVION;
/

CREATE OR REPLACE PROCEDURE COPIAR_HIJOS_DE_PIEZA 
(PIEZA_ID IN NUMBER, 
  PIEZA_COPIA_ID IN NUMBER) AS 
  PIEZA_EXISTENTE PIEZA%ROWTYPE;
  
  parte_recien_creada number;

BEGIN
  for PIEZA_EXISTENTE in (select * from PIEZA where id_pieza_contenedora=pieza_id)
  loop

    INSERT INTO PIEZA(ID_PIEZA, NOMBRE, id_pieza_contenedora, sn, PN)
    VALUES(NULL, PIEZA_EXISTENTE.nombre, PIEZA_COPIA_ID, NULL, PIEZA_EXISTENTE.PN );
    
    select SECUENCIA_PIEZA_ID.currval into parte_recien_creada from dual;
    COPIAR_HIJOS_DE_PIEZA(PIEZA_EXISTENTE.ID_PIEZA, parte_recien_creada);
  end loop;
                        
END COPIAR_HIJOS_DE_PIEZA;
/
CREATE OR REPLACE PROCEDURE COPIAR_AVION 
  (AVION_ID IN NUMBER, 
   COPIA_AVION_ID IN NUMBER) AS 
  AVION_EXISTENTE PIEZA%ROWTYPE;
  
BEGIN

  SELECT * INTO AVION_EXISTENTE
  FROM PIEZA
  WHERE ID_PIEZA = AVION_ID;
  
  INSERT INTO PIEZA(id_pieza, NOMBRE, id_pieza_contenedora, sn, PN)
  VALUES(COPIA_AVION_ID,AVION_existente.nombre, null,  null, NULL );
  
  COPIAR_HIJOS_DE_PIEZA(AVION_ID, COPIA_AVION_ID);
  
END COPIAR_AVION;
/

CREATE OR REPLACE PROCEDURE CREAR_AVION
(NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS 
BEGIN 
insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
VALUES (nuevo_id_pieza, null, 'Avion 1', null, null);
  
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', null, 'PN-001'); 
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);
  
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
      
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento1', null, 'PN-002');
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
          
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento2', null, 'PN-002');
      
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+7, nuevo_id_pieza+2, 'Asiento3', null, 'PN-002');
      
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+8, nuevo_id_pieza, 'Motor1', null, 'PN-004');   
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+9, nuevo_id_pieza, 'Motor2', null, 'PN-004'); 
  
END CREAR_AVION;
/
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10 
(NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS
BEGIN
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza, null, 'Avion  3', null, null);
    
        insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
        VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', null, 'PN-001'); 
        insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
        VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);

          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
          
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento11', null, 'PN-002');
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
              
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento Copiloto', null, null);
          
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+7, nuevo_id_pieza+3, 'Asiento12', null, 'PN-002');
              insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
              VALUES (nuevo_id_pieza+8, nuevo_id_pieza+3, 'controles', null, 'PN-003');
              
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+9, nuevo_id_pieza, 'Motor5', null, 'PN-004');   
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+10, nuevo_id_pieza, 'Motor6', null, 'PN-004'); 
    
     insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+11, nuevo_id_pieza, 'Motor7', null, 'PN-004');   
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+12, nuevo_id_pieza, 'Motor8', null, 'PN-004');
    
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+13, nuevo_id_pieza, 'Caja Negra', null, 'PN-004');
    insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
    VALUES (nuevo_id_pieza+14, nuevo_id_pieza, 'GPS', null, 'PN-004');
  NULL;
  
END INTENTA_CREAR_AVION_MASDE10;
/
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4 (NUEVO_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) IS 
BEGIN
insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
VALUES (nuevo_id_pieza, null, 'Avion 2', null, null);
 insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+1, nuevo_id_pieza, 'Fuselaje', 'SN-1008', 'PN-001'); 
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+2, nuevo_id_pieza, 'Cabina', null, null);
  
     insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+3, nuevo_id_pieza+2, 'Asiento Piloto', null, null);
      
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+4, nuevo_id_pieza+3, 'Asiento11', null, 'PN-002');
          insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
          VALUES (nuevo_id_pieza+5, nuevo_id_pieza+3, 'controles', null, 'PN-003');
          
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+6, nuevo_id_pieza+2, 'Asiento5', null, 'PN-002');
      
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+7, nuevo_id_pieza+2, 'Asiento6', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+8, nuevo_id_pieza+2, 'Asiento7', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+9, nuevo_id_pieza+2, 'Asiento8', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+10, nuevo_id_pieza+2, 'Asiento9', null, 'PN-002');
      insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
      VALUES (nuevo_id_pieza+11, nuevo_id_pieza+2, 'Asiento10', null, 'PN-002');
      
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+12, nuevo_id_pieza, 'Motor1', null, 'PN-004');   
  insert into pieza (id_pieza, id_pieza_contenedora, nombre, sn, pn)
  VALUES (nuevo_id_pieza+13, nuevo_id_pieza, 'Motor2', null, 'PN-004'); 
  
END INTENTA_CREAR_AVION_MASDE4 ;
/
CREATE OR REPLACE FUNCTION COMPRUEBA_AVION(PADRE_ID_PIEZA  PIEZA.ID_PIEZA%TYPE) RETURN varchar2 AS 
cantidad Number;

BEGIN
cantidad := 0;
 for j in (select id_pieza_contenedora , sn
           FROM pieza
          START WITH id_pieza=PADRE_ID_PIEZA
          CONNECT BY PRIOR ID_PIEZA=id_pieza_contenedora)
LOOP   
        if j.sn is not null then
           cantidad := cantidad +1;
        end if; 
        if cantidad > 10 then
          raise_application_error (-20001,'Este avion contiene demasiadas piezas simples.');
        end if;   
    end loop;
  RETURN 'Este avion no excede de piezas simples';
END COMPRUEBA_AVION;
/
CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA RETURN varchar2 AS 
cantidad Number;
piezaCompuesta Number;
BEGIN
piezaCompuesta :=0;
cantidad := 0;
 for j in (select id_pieza_contenedora, sn
            FROM pieza
             order by id_pieza_contenedora)
LOOP   
      if piezaCompuesta <> j.id_pieza_contenedora then  
        piezaCompuesta := j.id_pieza_contenedora;
         cantidad := 0;
      end if;
        if j.sn is not null then
           cantidad := cantidad +1;
        end if; 
        if cantidad > 4 then
          raise_application_error (-20001,'Este conjunto de piezas contiene demasiadas piezas simples.');
        end if;  
    end loop;
  RETURN 'No excede de piezas simples.';
END COMPRUEBA_PIEZA;
/
CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS BEGIN
Delete
from pieza;
END BORRAR_AVIONES;
/

-- Informe de Resumen de Oracle SQL Developer Data Modeler: 
-- 
-- CREATE TABLE                             1
-- CREATE INDEX                             1
-- ALTER TABLE                              2
-- CREATE VIEW                              1
-- CREATE PACKAGE                           0
-- CREATE PACKAGE BODY                      0
-- CREATE PROCEDURE                         7
-- CREATE FUNCTION                          2
-- CREATE TRIGGER                           2
-- ALTER TRIGGER                            0
-- CREATE STRUCTURED TYPE                   0
-- CREATE COLLECTION TYPE                   0
-- CREATE CLUSTER                           0
-- CREATE CONTEXT                           0
-- CREATE DATABASE                          0
-- CREATE DIMENSION                         0
-- CREATE DIRECTORY                         0
-- CREATE DISK GROUP                        0
-- CREATE ROLE                              0
-- CREATE ROLLBACK SEGMENT                  0
-- CREATE SEQUENCE                          2
-- CREATE MATERIALIZED VIEW                 0
-- CREATE SYNONYM                           0
-- CREATE TABLESPACE                        0
-- CREATE USER                              0
-- 
-- DROP TABLESPACE                          0
-- DROP DATABASE                            0
-- 
-- ERRORS                                   0
-- WARNINGS                                 0
drop user egarcia cascade;
 
 create user egarcia identified by egarcia;
 grant resource,connect, create view, create procedure to egarcia;
 connect egarcia/egarcia;
 @egarcia.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:06 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user egarcia cascade
            *
ERROR at line 1:
ORA-01918: user 'EGARCIA' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Index created.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       3000
  Fuselaje		       SN-1008					PN-001					       3001	   3000
  Cabina													       3002	   3000
    Asiento Piloto												       3003	   3002
      Asiento11 	       SN-15					PN-002					       3004	   3003
      controles 	       SN-16					PN-003					       3005	   3003
    Asiento5		       SN-17					PN-002					       3006	   3002
    Asiento6		       SN-18					PN-002					       3007	   3002
    Asiento7		       SN-19					PN-002					       3008	   3002
    Asiento8		       SN-20					PN-002					       3009	   3002
    Asiento9		       SN-21					PN-002					       3010	   3002
    Asiento10		       SN-22					PN-002					       3011	   3002
  Motor1		       SN-23					PN-004					       3012	   3000
  Motor2		       SN-24					PN-004					       3013	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       3000
  Fuselaje		       SN-1008					PN-001					       3001	   3000
  Cabina													       3002	   3000
    Asiento Piloto												       3003	   3002
      Asiento11 	       SN-15					PN-002					       3004	   3003
      controles 	       SN-16					PN-003					       3005	   3003
    Asiento5		       SN-17					PN-002					       3006	   3002
    Asiento6		       SN-18					PN-002					       3007	   3002
    Asiento7		       SN-19					PN-002					       3008	   3002
    Asiento8		       SN-20					PN-002					       3009	   3002
    Asiento9		       SN-21					PN-002					       3010	   3002
    Asiento10		       SN-22					PN-002					       3011	   3002
  Motor1		       SN-23					PN-004					       3012	   3000
  Motor2		       SN-24					PN-004					       3013	   3000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN					PN					   PARTE_ID PARTE_PADRE
------------------------------ ---------------------------------------- ---------------------------------------- ---------- -----------
Avion 1 													       1000
  Fuselaje		       SN-1					PN-001					       1001	   1000
  Cabina													       1002	   1000
    Asiento Piloto												       1003	   1002
      Asiento1		       SN-2					PN-002					       1004	   1003
      controles 	       SN-3					PN-003					       1005	   1003
    Asiento2		       SN-4					PN-002					       1006	   1002
    Asiento3		       SN-5					PN-002					       1007	   1002
  Motor1		       SN-6					PN-004					       1008	   1000
  Motor2		       SN-7					PN-004					       1009	   1000
Avion 1 													       2000
  Fuselaje		       SN-8					PN-001						  1	   2000
  Cabina														  2	   2000
    Asiento Piloto													  3	      2
      Asiento1		       SN-9					PN-002						  4	      3
      controles 	       SN-10					PN-003						  5	      3
    Asiento2		       SN-11					PN-002						  6	      2
    Asiento3		       SN-12					PN-002						  7	      2
  Motor1		       SN-13					PN-004						  8	   2000
  Motor2		       SN-14					PN-004						  9	   2000
Avion 2 													       4000
  Fuselaje		       SN-25					PN-001						 10	   4000
  Cabina														 11	   4000
    Asiento Piloto													 12	     11
      Asiento11 	       SN-26					PN-002						 13	     12
      controles 	       SN-27					PN-003						 14	     12
    Asiento5		       SN-28					PN-002						 15	     11
    Asiento6		       SN-29					PN-002						 16	     11
    Asiento7		       SN-30					PN-002						 17	     11
    Asiento8		       SN-31					PN-002						 18	     11
    Asiento9		       SN-32					PN-002						 19	     11
    Asiento10		       SN-33					PN-002						 20	     11
  Motor1		       SN-34					PN-004						 21	   4000
  Motor2		       SN-35					PN-004						 22	   4000
Avion  3													       5000
  Fuselaje		       SN-36					PN-001					       5001	   5000
  Cabina													       5002	   5000
    Asiento Piloto												       5003	   5002
      Asiento11 	       SN-37					PN-002					       5004	   5003
      controles 	       SN-38					PN-003					       5005	   5003
      Asiento12 	       SN-39					PN-002					       5007	   5003
      controles 	       SN-40					PN-003					       5008	   5003
    Asiento Copiloto												       5006	   5002
  Motor5		       SN-41					PN-004					       5009	   5000
  Motor6		       SN-42					PN-004					       5010	   5000
  Motor7		       SN-43					PN-004					       5011	   5000
  Motor8		       SN-44					PN-004					       5012	   5000
  Caja Negra		       SN-45					PN-004					       5013	   5000
  GPS			       SN-46					PN-004					       5014	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Este avion no excede de piezas simples

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20001: Este avion contiene demasiadas piezas simples.
ORA-06512: at "EGARCIA.COMPRUEBA_AVION", line 15


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20001: Este avion contiene demasiadas piezas simples.
ORA-06512: at "EGARCIA.COMPRUEBA_AVION", line 15


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   igaraballu
****************************************************
****************************************************
****************************************************
--Creamos la tabla que necesitamos
create table piezas(
  serialnumber VARCHAR2(10),
  partnumber VARCHAR2(10),
  nombre VARCHAR2(20),
  id NUMBER(10),
  idpadre NUMBER(10));

alter table piezas
  add constraint piezas_pk
  primary key (id);

--Creamos la vista AVIONES_PROFESOR
create view AVIONES_PROFESOR as
select id PARTE_ID, nombre, idpadre PARTE_PADRE, serialnumber SN, partnumber PN
from piezas;

--Creamos la secuencia SECUENCIA_AVION_ID (Empezará apartir del 1)--
CREATE SEQUENCE  "SECUENCIA_AVION_ID"  MINVALUE 1 MAXVALUE 99 INCREMENT BY 1 START WITH 1 CACHE 20 NOORDER  NOCYCLE ;

--Creamos la secuencia SECUENCIA_PIEZA_ID (Empezará apartir del 100)--
CREATE SEQUENCE  "SECUENCIA_PIEZA_ID"  MINVALUE 100 MAXVALUE 999 INCREMENT BY 1 START WITH 100 CACHE 20 NOORDER  NOCYCLE ;

--Creamos la secuencia SECUENCIA_SERIALNUMBER (Empezará apartir del 1000)--
CREATE SEQUENCE  "SECUENCIA_SERIALNUMBER"  MINVALUE 1000 MAXVALUE 9999 INCREMENT BY 1 START WITH 1000 CACHE 20 NOORDER  NOCYCLE ;

--Creamos el trigger TRIGGER_ID
create or replace 
trigger TRIGGER_ID
BEFORE INSERT ON PIEZAS
FOR EACH ROW
BEGIN
  IF inserting THEN
    IF :NEW."IDPADRE" IS NULL THEN
      IF :NEW."ID" IS NULL THEN
        select SECUENCIA_AVION_ID.nextval into :NEW."ID" from dual;
      END IF;
    ELSE
      select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual;
    END IF;
  END IF;
END;
/

--Creamos el trigger TRIGGER_SN
CREATE OR REPLACE TRIGGER TRIGGER_SN 
BEFORE INSERT ON PIEZAS
FOR EACH ROW
DECLARE
  prefijo varchar2(3):= 'SN-';
BEGIN
  IF inserting THEN
    IF :NEW."PARTNUMBER" is not null THEN
      select prefijo || SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIALNUMBER" from dual;
    END IF;
  END IF;
END;
/

--Creamos la función de un avion no tener más de 10 piezas simples
create or replace 
FUNCTION COMPRUEBA_AVION(idavion number) RETURN NUMBER AS
  numpiezas number;
  padreid number;
BEGIN
select idpadre into padreid from piezas where id = idavion;
if padreid is null then
  select count(nombre) into numpiezas from piezas where serialnumber is not null start with id=idavion connect by prior id=idpadre;
  if numpiezas > 10 then 
    raise_application_error(-20001, 'Mas de 10 piezas simples.');
  end if;
else
  raise_application_error(-20002, 'No es un avión.');
end if;
END;
/

--Creamos la funcion de un avion no tener mas de 4 piezas en una pieza compuesta
create or replace 
FUNCTION COMPRUEBA_PIEZA (idpieza number) RETURN number AS 
   numpiezas number;
   padreid number;
BEGIN
select idpadre into padreid from piezas where id = idpieza;
if padreid is not null then
 select count(nombre) into numpiezas from piezas start with id=idpieza connect by prior id=idpadre;
  if numpiezas > 4 then 
    raise_application_error(-20001, 'Mas de 4 piezas simples');
  end if;
else
   raise_application_error(-20002, 'No es una pieza');
end if;
END;
/

--Creamos el procedimiento CREAR_AVION
create or replace 
PROCEDURE CREAR_AVION(avion_id number) AS
  cabina_id number;
  piloto_id number;
BEGIN
  insert into piezas(nombre,id) values ('Avion 1',avion_id);
    insert into piezas(nombre,partnumber,idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas(nombre,idpadre) values ('Cabina',avion_id);
    select SECUENCIA_PIEZA_ID.currval into cabina_id from dual;
      insert into piezas(nombre,partnumber,idpadre) values ('Asiento 2','PN-002',cabina_id);
      insert into piezas(nombre,partnumber,idpadre) values ('Asiento 3','PN-002',cabina_id);
      insert into piezas(nombre,idpadre) values ('Asiento Piloto',cabina_id);
        select SECUENCIA_PIEZA_ID.currval into piloto_id from dual;
        insert into piezas(nombre,partnumber,idpadre) values ('Asiento 1','PN-002',piloto_id);
        insert into piezas(nombre,partnumber,idpadre) values ('Controles','PN-003',piloto_id);
    insert into piezas(nombre,partnumber,idpadre) values ('Motor 1','PN-004',avion_id);
    insert into piezas(nombre,partnumber,idpadre) values ('Motor 2','PN-004',avion_id);
END CREAR_AVION;
/

--Creamos el procedimiento BORRAR_AVION
create or replace 
PROCEDURE BORRAR_AVION (avion_id number) AS 
BEGIN
  delete from piezas where id IN (select id from piezas start with id = avion_id connect by prior id = idpadre);
END;
/

--Creamos el procedimiento BORRAR_AVIONES
create or replace
procedure BORRAR_AVIONES as
BEGIN
  delete from piezas;
 END;
/

--Creamos el procedimiento INTENTA_CREAR_AVION_MASDE4
CREATE OR REPLACE
PROCEDURE INTENTA_CREAR_AVION_MASDE4 (avion_id number) AS 
  cabina_id number;
  piloto_id number;
  copiloto_id number;
BEGIN
  insert into piezas (nombre, id) values ('Avion 3',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas (nombre,idpadre) values ('Cabina',avion_id);
    select secuencia_pieza_id.currval into cabina_id from dual;
      insert into piezas (nombre, idpadre) values ('Asiento piloto',cabina_id);
      select secuencia_pieza_id.currval into piloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 4','PN-002',piloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',piloto_id);
      insert into piezas (nombre, idpadre) values ('Asiento 5',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 6',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 7',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 8',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 9',cabina_id);
      insert into piezas (nombre, idpadre) values ('Asiento 10',cabina_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 5', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 6', 'PN-004',avion_id);
END;
/

--Creamos el procedimiento INTENTA_CREAR_AVION_MASDE10
CREATE OR REPLACE
PROCEDURE INTENTA_CREAR_AVION_MASDE10 (avion_id number) AS 
  cabina_id number;
  piloto_id number;
  copiloto_id number;
BEGIN
  insert into piezas (nombre, id) values ('Avion 3',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Fuselaje','PN-001',avion_id);
    insert into piezas (nombre,idpadre) values ('Cabina',avion_id);
    select secuencia_pieza_id.currval into cabina_id from dual;
      insert into piezas (nombre, idpadre) values ('Asiento piloto',cabina_id);
      select secuencia_pieza_id.currval into piloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 11','PN-002',piloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',piloto_id);
       insert into piezas (nombre, idpadre) values ('Asiento copiloto',cabina_id);
       select secuencia_pieza_id.currval into copiloto_id from dual;
        insert into piezas (nombre, partnumber, idpadre) values ('Asiento 12','PN-002',copiloto_id);
        insert into piezas (nombre, partnumber, idpadre) values ('Controles','PN-003',copiloto_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 5', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 6', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 7', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Motor 8', 'PN-004',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('Caja negra', 'PN-005',avion_id);
    insert into piezas (nombre, partnumber, idpadre) values ('GPS', 'PN-006',avion_id);
END;
/

--Creamos el procedimiento COPIAR_HIJOS
create or replace 
PROCEDURE COPIAR_HIJOS (pieza_id number, pieza_copia_id number) AS  
  avion_creado piezas%ROWTYPE;
  pieza_recien_creada number;
BEGIN
  for piezas in (select * from piezas where idpadre=pieza_id)
  loop
    INSERT INTO piezas(nombre,idpadre,partnumber) VALUES(piezas.nombre, pieza_copia_id, avion_creado.partnumber );
    select SECUENCIA_PIEZA_ID.currval into pieza_recien_creada from dual;
    copiar_hijos(piezas.id,pieza_recien_creada);
  end loop;                 
END;
/

--Creamos el procedimiento COPIAR_AVION
create or replace 
PROCEDURE COPIAR_AVION (avion_id number, copia_avion_id number) AS 
  avion_creado piezas%ROWTYPE;
BEGIN
  SELECT * INTO avion_creado FROM piezas WHERE id = avion_id;  
  INSERT INTO piezas(id,nombre,idpadre,partnumber) VALUES(COPIA_AVION_ID,avion_creado.nombre, null,  null ); 
  copiar_hijos(avion_id, copia_avion_id);
END;
/drop user igaraballu cascade;
 
 create user igaraballu identified by igaraballu;
 grant resource,connect, create view, create procedure to igaraballu;
 connect igaraballu/igaraballu;
 @igaraballu.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:07 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user igaraballu cascade
            *
ERROR at line 1:
ORA-01918: user 'IGARABALLU' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table altered.


View created.


Sequence created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Warning: Function created with compilation errors.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento 2						    111 	110
    Asiento 3						    112 	110
    Asiento Piloto					    113 	110
      Asiento 1 					    114 	113
      Controles 					    115 	113
  Motor 1						    116        2000
  Motor 2						    117        2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento 2						    111 	110
    Asiento 3						    112 	110
    Asiento Piloto					    113 	110
      Asiento 1 					    114 	113
      Controles 					    115 	113
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   3000
  Fuselaje		       SN-1007	  PN-001	    118        3000
  Cabina						    119        3000
    Asiento piloto					    120 	119
      Asiento 4 	       SN-1008	  PN-002	    121 	120
      Controles 	       SN-1009	  PN-003	    122 	120
    Asiento 5						    123 	119
    Asiento 6						    124 	119
    Asiento 7						    125 	119
    Asiento 8						    126 	119
    Asiento 9						    127 	119
    Asiento 10						    128 	119
  Motor 5		       SN-1010	  PN-004	    129        3000
  Motor 6		       SN-1011	  PN-004	    130        3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento 2						    111 	110
    Asiento 3						    112 	110
    Asiento Piloto					    113 	110
      Asiento 1 					    114 	113
      Controles 					    115 	113
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   3000
  Fuselaje		       SN-1007	  PN-001	    118        3000
  Cabina						    119        3000
    Asiento piloto					    120 	119
      Asiento 4 	       SN-1008	  PN-002	    121 	120
      Controles 	       SN-1009	  PN-003	    122 	120
    Asiento 5						    123 	119
    Asiento 6						    124 	119
    Asiento 7						    125 	119
    Asiento 8						    126 	119
    Asiento 9						    127 	119
    Asiento 10						    128 	119
  Motor 5		       SN-1010	  PN-004	    129        3000
  Motor 6		       SN-1011	  PN-004	    130        3000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento 2						    111 	110
    Asiento 3						    112 	110
    Asiento Piloto					    113 	110
      Asiento 1 					    114 	113
      Controles 					    115 	113
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN	  PN	       PARTE_ID PARTE_PADRE
------------------------------ ---------- ---------- ---------- -----------
Avion 1 						   1000
  Fuselaje		       SN-1000	  PN-001	    100        1000
  Cabina						    101        1000
    Asiento 2		       SN-1001	  PN-002	    102 	101
    Asiento 3		       SN-1002	  PN-002	    103 	101
    Asiento Piloto					    104 	101
      Asiento 1 	       SN-1003	  PN-002	    105 	104
      Controles 	       SN-1004	  PN-003	    106 	104
  Motor 1		       SN-1005	  PN-004	    107        1000
  Motor 2		       SN-1006	  PN-004	    108        1000
Avion 1 						   2000
  Fuselaje						    109        2000
  Cabina						    110        2000
    Asiento 2						    111 	110
    Asiento 3						    112 	110
    Asiento Piloto					    113 	110
      Asiento 1 					    114 	113
      Controles 					    115 	113
  Motor 1						    116        2000
  Motor 2						    117        2000
Avion 3 						   4000
  Fuselaje						    131        4000
  Cabina						    132        4000
    Asiento piloto					    133 	132
      Asiento 4 					    134 	133
      Controles 					    135 	133
    Asiento 5						    136 	132
    Asiento 6						    137 	132
    Asiento 7						    138 	132
    Asiento 8						    139 	132
    Asiento 9						    140 	132
    Asiento 10						    141 	132
  Motor 5						    142        4000
  Motor 6						    143        4000
Avion 3 						   5000
  Fuselaje		       SN-1012	  PN-001	    144        5000
  Cabina						    145        5000
    Asiento piloto					    146 	145
      Asiento 11	       SN-1013	  PN-002	    147 	146
      Controles 	       SN-1014	  PN-003	    148 	146
    Asiento copiloto					    149 	145
      Asiento 12	       SN-1015	  PN-002	    150 	149
      Controles 	       SN-1016	  PN-003	    151 	149
  Motor 5		       SN-1017	  PN-004	    152        5000
  Motor 6		       SN-1018	  PN-004	    153        5000
  Motor 7		       SN-1019	  PN-004	    154        5000
  Motor 8		       SN-1020	  PN-004	    155        5000
  Caja negra		       SN-1021	  PN-005	    156        5000
  GPS			       SN-1022	  PN-006	    157        5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.

  select COMPRUEBA_AVION(1000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-06575: Package or function COMPRUEBA_AVION is in an invalid state


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   jgil
****************************************************
****************************************************
****************************************************
CREATE TABLE PIEZASCOMPUESTAS (
ID NUMBER  NOT NULL , 
NOMBRE_PC VARCHAR2 (50 BYTE)  NOT NULL , 
ID_PIEZA_COMPUESTA NUMBER);

CREATE TABLE PIEZASSIMPLES ( 
ID NUMBER  NOT NULL , 
NOMBRE_PS VARCHAR2 (50 BYTE)  NOT NULL , 
SERIAL_NUMBER VARCHAR2 (20 BYTE)  NOT NULL , 
PART_NUMBER VARCHAR2 (20 BYTE)  NOT NULL , 
ID_PIEZA_COMPUESTA NUMBER  NOT NULL );

ALTER TABLE PIEZASCOMPUESTAS 
ADD CONSTRAINT PK_PIEZA_COMPUESTA PRIMARY KEY (ID);

ALTER TABLE PIEZASSIMPLES 
ADD CONSTRAINT PK_PIEZA_SIMPLE PRIMARY KEY (ID);

ALTER TABLE PIEZASCOMPUESTAS 
ADD CONSTRAINT FK_COMPUESTA_A_COMPUESTA FOREIGN KEY 
(ID_PIEZA_COMPUESTA) REFERENCES PIEZASCOMPUESTAS (ID);

ALTER TABLE PIEZASSIMPLES 
ADD CONSTRAINT FK_SIMPLE_A_COMPUESTA FOREIGN KEY 
(ID_PIEZA_COMPUESTA) REFERENCES PIEZASCOMPUESTAS (ID);

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS
SELECT ID AS PARTE_ID,
ID_PIEZA_COMPUESTA AS PARTE_PADRE,
NOMBRE_PS AS NOMBRE, 
SERIAL_NUMBER AS SN,
PART_NUMBER AS PN
FROM PIEZASSIMPLES
UNION
SELECT ID AS PARTE_ID,
ID_PIEZA_COMPUESTA AS PARTE_PADRE,
NOMBRE_PC AS NOMBRE,NULL,NULL
FROM PIEZASCOMPUESTAS ;

CREATE SEQUENCE SECUENCIA_PIEZA_ID 
INCREMENT BY 1 
MAXVALUE 999999999999999999999999999 
MINVALUE 1 
CACHE 20;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER 
INCREMENT BY 1 
MAXVALUE 999999999999999999999999999 
MINVALUE 1 
CACHE 20;

CREATE OR REPLACE TRIGGER GENERAR_ID_PC 
    BEFORE INSERT ON PIEZASCOMPUESTAS 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end;
/

CREATE OR REPLACE TRIGGER GENERAR_ID_PS 
    BEFORE INSERT ON PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER GENERAR_SN 
    BEFORE INSERT ON PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."SERIAL_NUMBER" is null then 
          select 'SN-100'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIAL_NUMBER" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE FUNCTION ES_AVION(ID_AVION NUMBER) RETURN NUMBER AS 
RETORNO NUMBER;
COMP NUMBER;
BEGIN
  RETORNO := 0;
  for j in (SELECT ID FROM PIEZASCOMPUESTAS) 
  loop
    SELECT ID_PIEZA_COMPUESTA INTO COMP FROM piezascompuestas WHERE id = j.ID;
    if j.ID = ID_AVION and COMP IS NULL then
          RETORNO := 1;
          EXIT;
    end if;
  end loop;
  RETURN RETORNO;
END ES_AVION;
/


create or replace 
PROCEDURE BORRAR_AVION(AVION_ID NUMBER) AS
es_o_no_avion number;
BEGIN
  es_o_no_avion := es_avion(avion_id);
  
  if es_o_no_avion = 1 then
  
  for j in (SELECT ID FROM PIEZASCOMPUESTAS)
  loop
    if j.ID = AVION_ID then
      DELETE FROM PIEZASSIMPLES WHERE id_pieza_compuesta = avion_id;

      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = avion_id
      );

      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta in(
          select id from piezascompuestas where id_pieza_compuesta = avion_id
        )
      );

      delete from piezascompuestas where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = avion_id
      );

      delete from piezascompuestas where id_pieza_compuesta = avion_id;

      delete from piezascompuestas where id = avion_id;
    exit;
    end if;
  end loop;
  ELSE
      raise_application_error(-20014, 'ESTE AVION_ID NO EXISTE');
  end if;

END BORRAR_AVION;
/


CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS 

MAX_ID NUMBER;
BEGIN
  for j in (SELECT * FROM PIEZASCOMPUESTAS) 
  loop
      MAX_ID := es_avion(j.id);
      IF MAX_ID = 1 then
      DELETE FROM PIEZASSIMPLES WHERE id_pieza_compuesta = j.id;
      
      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = j.id
      );
      
      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta in(
          select id from piezascompuestas where id_pieza_compuesta = j.id
        )
      );
            
      delete from piezascompuestas where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = j.id
      );      
      
      delete from piezascompuestas where id_pieza_compuesta = j.id;
            
      delete from piezascompuestas where id = j.id;
    
    end if;
  end loop;
END BORRAR_AVIONES;
/

CREATE OR REPLACE PROCEDURE COPIA_PIEZA_SIMP(PIEZA_ORIGINAL NUMBER, PIEZA_NUEVA NUMBER) AS 
PARTE_EXISTENTE PIEZASSIMPLES%ROWTYPE;
parte_recien_creada number;

BEGIN

  for PARTE_EXISTENTE in (select * from PIEZASSIMPLES where id_pieza_compuesta=PIEZA_ORIGINAL)
  loop
    
    INSERT INTO PIEZASSIMPLES(NOMBRE_PS,part_number,id_pieza_compuesta)
    VALUES(PARTE_EXISTENTE.nombre_ps,PARTE_EXISTENTE.PART_NUMBER, PIEZA_NUEVA );
    
  end loop;
  
END COPIA_PIEZA_SIMP;
/

CREATE OR REPLACE PROCEDURE COPIA_PIEZA_COMPUESTA(PIEZA_ORIGINAL NUMBER, PIEZA_NUEVA NUMBER) AS 
PARTE_EXISTENTE piezascompuestas%ROWTYPE;
parte_recien_creada number;

BEGIN

  for PARTE_EXISTENTE in (select * from piezascompuestas where id_pieza_compuesta=PIEZA_ORIGINAL)
  loop
    
    INSERT INTO piezascompuestas(NOMBRE_PC,id_pieza_compuesta)
    VALUES(PARTE_EXISTENTE.nombre_pc, PIEZA_NUEVA );
    
    select SECUENCIA_PIEZA_ID.currval into parte_recien_creada from dual;
    copia_pieza_simp(PARTE_EXISTENTE.ID,parte_recien_creada);
    COPIA_PIEZA_COMPUESTA(PARTE_EXISTENTE.ID,parte_recien_creada);
  end loop;
  
END COPIA_PIEZA_COMPUESTA;
/

CREATE OR REPLACE PROCEDURE COPIAR_AVION 
(
  AVION_ID IN NUMBER  
, COPIA_AVION_ID IN NUMBER  
) AS 
  AVION_EXISTENTE PIEZASCOMPUESTAS%ROWTYPE;
BEGIN
  SELECT * INTO avion_EXISTENTE
  FROM PIEZASCOMPUESTAS
  WHERE ID = AVION_ID;
  
  INSERT INTO PIEZASCOMPUESTAS(ID,NOMBRE_PC,id_pieza_compuesta)
  VALUES(COPIA_AVION_ID,AVION_existente.nombre_pc, null);
  
  copia_pieza_simp(AVION_ID, COPIA_AVION_ID);
  COPIA_PIEZA_COMPUESTA(AVION_ID, COPIA_AVION_ID);
  
  
END COPIAR_AVION;
/

CREATE OR REPLACE PROCEDURE CREAR_AVION (AVION_ID NUMBER) AS 
id_compuesta1 number;
id_compuesta2 number;
BEGIN
  
  for j in (SELECT ID FROM PIEZASCOMPUESTAS) 
  loop
    if j.ID = AVION_ID then
      raise_application_error(-20014, 'ESTE AVION_ID YA EXISTE');
      exit;
    end if;
  end loop;
    
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 1');
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 1', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 2', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 3', 'PN-002', id_compuesta1);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 1', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 2', 'PN-004', AVION_ID);
    
END CREAR_AVION;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10(avion_id number) AS 
id_compuesta1 number;
id_compuesta2 number;
id_compuesta3 number;
BEGIN
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 3');
    
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 11', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    select secuencia_pieza_id.nextval into id_compuesta3 from dual;
    INSERT INTO piezascompuestas values(id_compuesta3, 'Asiento copiloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 12', 'PN-002', id_compuesta3);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta3);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 5', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 6', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 7', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 8', 'PN-004', AVION_ID);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Caja negra', 'PN-005', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('GPS', 'PN-006', AVION_ID);
    
END INTENTA_CREAR_AVION_MASDE10;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4(avion_id number) AS 
id_compuesta1 number;
id_compuesta2 number;
BEGIN
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 2');
    
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ( 'Asiento 4', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 5', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 6', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 7', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 8', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 9', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 10', 'PN-002', id_compuesta1);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 3', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 4', 'PN-004', AVION_ID);
    
END INTENTA_CREAR_AVION_MASDE4;
/

CREATE OR REPLACE FUNCTION CUANTAS_PIEZAS_SIMPLES(ID_PIEZA NUMBER) RETURN VARCHAR2 AS 
NUM_PIEZAS_SIMPLES NUMBER;
BEGIN
  SELECT COUNT(*) INTO NUM_PIEZAS_SIMPLES FROM PIEZASSIMPLES WHERE id_pieza_compuesta = ID_PIEZA;
  RETURN NUM_PIEZAS_SIMPLES;
END CUANTAS_PIEZAS_SIMPLES;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_AVION(ID_AVION NUMBER) RETURN VARCHAR2 AS 
ES_UN_AVION NUMBER;
PIEZAS_SIMPLES NUMBER;
BEGIN
  ES_UN_AVION := ES_AVION(ID_AVION);
  IF es_un_avion != 1 THEN
    
    raise_application_error(-20010, 'ESTO NO ES UN AVION');
  ELSE
      PIEZAS_SIMPLES := 0;
      for j in (
        select id from piezascompuestas 
        start with id =  id_avion
        connect by prior id = id_pieza_compuesta
      ) 
      
      loop
        
        
        PIEZAS_SIMPLES := PIEZAS_SIMPLES + cuantas_piezas_simples(j.id);
      end loop;
    
    
    IF piezas_simples > 10 THEN
      raise_application_error(-20011, 'ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL');
    END IF;
  END IF;
  RETURN 'TODO ESTA CORRECTO';
END COMPRUEBA_AVION;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA(ID_PIEZA NUMBER) RETURN VARCHAR2 AS 
ES_UN_AVION NUMBER;
PIEZAS_SIMPLES NUMBER;
BEGIN
  ES_UN_AVION := ES_AVION(ID_PIEZA);
  IF es_un_avion = 1 THEN
    raise_application_error(-20012, 'ESTO ES UN AVION');
  ELSE
      PIEZAS_SIMPLES := 0;
      for j in (
        select id from piezascompuestas 
        start with id =  ID_PIEZA
        connect by prior id = id_pieza_compuesta
      ) 
      loop
         PIEZAS_SIMPLES := PIEZAS_SIMPLES + cuantas_piezas_simples(j.id);
      end loop;
    
    IF piezas_simples > 4 THEN
      raise_application_error(-20013, 'ESTA PIEZA COMPUESTA TIENE MAS DE 4 PIEZAS SIMPLES EN TOTAL');
    END IF;
  END IF;
  RETURN 'TODO ESTA CORRECTO';
END COMPRUEBA_PIEZA;
/

















drop user jgil cascade;
 
 create user jgil identified by jgil;
 grant resource,connect, create view, create procedure to jgil;
 connect jgil/jgil;
 @jgil.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:07 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user jgil cascade
            *
ERROR at line 1:
ORA-01918: user 'JGIL' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table created.


Table altered.


Table altered.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Trigger created.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.


Function created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       3000
  Cabina									 19	   3000
    Asiento piloto								 20	     19
      Asiento 4 	       SN-10015 	    PN-002			 21	     20
      Controles 	       SN-10016 	    PN-003			 22	     20
    Asiento 5		       SN-10017 	    PN-002			 23	     19
    Asiento 6		       SN-10018 	    PN-002			 24	     19
    Asiento 7		       SN-10019 	    PN-002			 25	     19
    Asiento 8		       SN-10020 	    PN-002			 26	     19
    Asiento 9		       SN-10021 	    PN-002			 27	     19
    Asiento 10		       SN-10022 	    PN-002			 28	     19
  Fuselaje		       SN-10023 	    PN-001			 29	   3000
  Motor 3		       SN-10024 	    PN-004			 30	   3000
  Motor 4		       SN-10025 	    PN-004			 31	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       3000
  Cabina									 19	   3000
    Asiento piloto								 20	     19
      Asiento 4 	       SN-10015 	    PN-002			 21	     20
      Controles 	       SN-10016 	    PN-003			 22	     20
    Asiento 5		       SN-10017 	    PN-002			 23	     19
    Asiento 6		       SN-10018 	    PN-002			 24	     19
    Asiento 7		       SN-10019 	    PN-002			 25	     19
    Asiento 8		       SN-10020 	    PN-002			 26	     19
    Asiento 9		       SN-10021 	    PN-002			 27	     19
    Asiento 10		       SN-10022 	    PN-002			 28	     19
  Fuselaje		       SN-10023 	    PN-001			 29	   3000
  Motor 3		       SN-10024 	    PN-004			 30	   3000
  Motor 4		       SN-10025 	    PN-004			 31	   3000
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42
Avion 3 								       5000
  Cabina									 45	   5000
    Asiento piloto								 46	     45
      Asiento 11	       SN-10037 	    PN-002			 47	     46
      Controles 	       SN-10038 	    PN-003			 48	     46
    Asiento copiloto								 49	     45
      Asiento 12	       SN-10039 	    PN-002			 50	     49
      Controles 	       SN-10040 	    PN-003			 51	     49
  Fuselaje		       SN-10041 	    PN-001			 52	   5000
  Motor 5		       SN-10042 	    PN-004			 53	   5000
  Motor 6		       SN-10043 	    PN-004			 54	   5000
  Motor 7		       SN-10044 	    PN-004			 55	   5000
  Motor 8		       SN-10045 	    PN-004			 56	   5000
  Caja negra		       SN-10046 	    PN-005			 57	   5000
  GPS			       SN-10047 	    PN-006			 58	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
TODO ESTA CORRECTO

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20011: ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL
ORA-06512: at "JGIL.COMPRUEBA_AVION", line 25


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20011: ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL
ORA-06512: at "JGIL.COMPRUEBA_AVION", line 25


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   lmiguel
****************************************************
****************************************************
****************************************************
CREATE TABLE PIEZASCOMPUESTAS (
ID NUMBER  NOT NULL , 
NOMBRE_PC VARCHAR2 (50 BYTE)  NOT NULL , 
ID_PIEZA_COMPUESTA NUMBER);

CREATE TABLE PIEZASSIMPLES ( 
ID NUMBER  NOT NULL , 
NOMBRE_PS VARCHAR2 (50 BYTE)  NOT NULL , 
SERIAL_NUMBER VARCHAR2 (20 BYTE)  NOT NULL , 
PART_NUMBER VARCHAR2 (20 BYTE)  NOT NULL , 
ID_PIEZA_COMPUESTA NUMBER  NOT NULL );

ALTER TABLE PIEZASCOMPUESTAS 
ADD CONSTRAINT PK_PIEZA_COMPUESTA PRIMARY KEY (ID);

ALTER TABLE PIEZASSIMPLES 
ADD CONSTRAINT PK_PIEZA_SIMPLE PRIMARY KEY (ID);

ALTER TABLE PIEZASCOMPUESTAS 
ADD CONSTRAINT FK_COMPUESTA_A_COMPUESTA FOREIGN KEY 
(ID_PIEZA_COMPUESTA) REFERENCES PIEZASCOMPUESTAS (ID);

ALTER TABLE PIEZASSIMPLES 
ADD CONSTRAINT FK_SIMPLE_A_COMPUESTA FOREIGN KEY 
(ID_PIEZA_COMPUESTA) REFERENCES PIEZASCOMPUESTAS (ID);

CREATE OR REPLACE VIEW AVIONES_PROFESOR AS
SELECT ID AS PARTE_ID,
ID_PIEZA_COMPUESTA AS PARTE_PADRE,
NOMBRE_PS AS NOMBRE, 
SERIAL_NUMBER AS SN,
PART_NUMBER AS PN
FROM PIEZASSIMPLES
UNION
SELECT ID AS PARTE_ID,
ID_PIEZA_COMPUESTA AS PARTE_PADRE,
NOMBRE_PC AS NOMBRE,NULL,NULL
FROM PIEZASCOMPUESTAS ;

CREATE SEQUENCE SECUENCIA_PIEZA_ID 
INCREMENT BY 1 
MAXVALUE 999999999999999999999999999 
MINVALUE 1 
CACHE 20;

CREATE SEQUENCE SECUENCIA_SERIALNUMBER 
INCREMENT BY 1 
MAXVALUE 999999999999999999999999999 
MINVALUE 1 
CACHE 20;

CREATE OR REPLACE TRIGGER GENERAR_ID_PC 
    BEFORE INSERT ON PIEZASCOMPUESTAS 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end;
/

CREATE OR REPLACE TRIGGER GENERAR_ID_PS 
    BEFORE INSERT ON PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE TRIGGER GENERAR_SN 
    BEFORE INSERT ON PIEZASSIMPLES 
    FOR EACH ROW 
begin  
   if inserting then 
      if :NEW."SERIAL_NUMBER" is null then 
          select 'SN-100'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIAL_NUMBER" from dual; 
      end if; 
   end if; 
end; 
/


CREATE OR REPLACE FUNCTION ES_AVION(ID_AVION NUMBER) RETURN NUMBER AS 
RETORNO NUMBER;
COMP NUMBER;
BEGIN
  RETORNO := 0;
  for j in (SELECT ID FROM PIEZASCOMPUESTAS) 
  loop
    SELECT ID_PIEZA_COMPUESTA INTO COMP FROM piezascompuestas WHERE id = j.ID;
    if j.ID = ID_AVION and COMP IS NULL then
          RETORNO := 1;
          EXIT;
    end if;
  end loop;
  RETURN RETORNO;
END ES_AVION;
/


create or replace 
PROCEDURE BORRAR_AVION(AVION_ID NUMBER) AS
es_o_no_avion number;
BEGIN
  es_o_no_avion := es_avion(avion_id);
  
  if es_o_no_avion = 1 then
  
  for j in (SELECT ID FROM PIEZASCOMPUESTAS)
  loop
    if j.ID = AVION_ID then
      DELETE FROM PIEZASSIMPLES WHERE id_pieza_compuesta = avion_id;

      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = avion_id
      );

      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta in(
          select id from piezascompuestas where id_pieza_compuesta = avion_id
        )
      );

      delete from piezascompuestas where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = avion_id
      );

      delete from piezascompuestas where id_pieza_compuesta = avion_id;

      delete from piezascompuestas where id = avion_id;
    exit;
    end if;
  end loop;
  ELSE
      raise_application_error(-20014, 'ESTE AVION_ID NO EXISTE');
  end if;

END BORRAR_AVION;
/


CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS 

MAX_ID NUMBER;
BEGIN
  for j in (SELECT * FROM PIEZASCOMPUESTAS) 
  loop
      MAX_ID := es_avion(j.id);
      IF MAX_ID = 1 then
      DELETE FROM PIEZASSIMPLES WHERE id_pieza_compuesta = j.id;
      
      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = j.id
      );
      
      delete from piezassimples where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta in(
          select id from piezascompuestas where id_pieza_compuesta = j.id
        )
      );
            
      delete from piezascompuestas where id_pieza_compuesta in(
        select id from piezascompuestas where id_pieza_compuesta = j.id
      );      
      
      delete from piezascompuestas where id_pieza_compuesta = j.id;
            
      delete from piezascompuestas where id = j.id;
    
    end if;
  end loop;
END BORRAR_AVIONES;
/

CREATE OR REPLACE PROCEDURE COPIA_PIEZA_SIMP(PIEZA_ORIGINAL NUMBER, PIEZA_NUEVA NUMBER) AS 
PARTE_EXISTENTE PIEZASSIMPLES%ROWTYPE;
parte_recien_creada number;

BEGIN

  for PARTE_EXISTENTE in (select * from PIEZASSIMPLES where id_pieza_compuesta=PIEZA_ORIGINAL)
  loop
    
    INSERT INTO PIEZASSIMPLES(NOMBRE_PS,part_number,id_pieza_compuesta)
    VALUES(PARTE_EXISTENTE.nombre_ps,PARTE_EXISTENTE.PART_NUMBER, PIEZA_NUEVA );
    
  end loop;
  
END COPIA_PIEZA_SIMP;
/

CREATE OR REPLACE PROCEDURE COPIA_PIEZA_COMPUESTA(PIEZA_ORIGINAL NUMBER, PIEZA_NUEVA NUMBER) AS 
PARTE_EXISTENTE piezascompuestas%ROWTYPE;
parte_recien_creada number;

BEGIN

  for PARTE_EXISTENTE in (select * from piezascompuestas where id_pieza_compuesta=PIEZA_ORIGINAL)
  loop
    
    INSERT INTO piezascompuestas(NOMBRE_PC,id_pieza_compuesta)
    VALUES(PARTE_EXISTENTE.nombre_pc, PIEZA_NUEVA );
    
    select SECUENCIA_PIEZA_ID.currval into parte_recien_creada from dual;
    copia_pieza_simp(PARTE_EXISTENTE.ID,parte_recien_creada);
    COPIA_PIEZA_COMPUESTA(PARTE_EXISTENTE.ID,parte_recien_creada);
  end loop;
  
END COPIA_PIEZA_COMPUESTA;
/

CREATE OR REPLACE PROCEDURE COPIAR_AVION 
(
  AVION_ID IN NUMBER  
, COPIA_AVION_ID IN NUMBER  
) AS 
  AVION_EXISTENTE PIEZASCOMPUESTAS%ROWTYPE;
BEGIN
  SELECT * INTO avion_EXISTENTE
  FROM PIEZASCOMPUESTAS
  WHERE ID = AVION_ID;
  
  INSERT INTO PIEZASCOMPUESTAS(ID,NOMBRE_PC,id_pieza_compuesta)
  VALUES(COPIA_AVION_ID,AVION_existente.nombre_pc, null);
  
  copia_pieza_simp(AVION_ID, COPIA_AVION_ID);
  COPIA_PIEZA_COMPUESTA(AVION_ID, COPIA_AVION_ID);
  
  
END COPIAR_AVION;
/

CREATE OR REPLACE PROCEDURE CREAR_AVION (AVION_ID NUMBER) AS 
id_compuesta1 number;
id_compuesta2 number;
BEGIN
  
  for j in (SELECT ID FROM PIEZASCOMPUESTAS) 
  loop
    if j.ID = AVION_ID then
      raise_application_error(-20014, 'ESTE AVION_ID YA EXISTE');
      exit;
    end if;
  end loop;
    
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 1');
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 1', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 2', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 3', 'PN-002', id_compuesta1);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 1', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 2', 'PN-004', AVION_ID);
    
END CREAR_AVION;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10(avion_id number) AS 
id_compuesta1 number;
id_compuesta2 number;
id_compuesta3 number;
BEGIN
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 3');
    
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 11', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    select secuencia_pieza_id.nextval into id_compuesta3 from dual;
    INSERT INTO piezascompuestas values(id_compuesta3, 'Asiento copiloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 12', 'PN-002', id_compuesta3);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta3);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 5', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 6', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 7', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 8', 'PN-004', AVION_ID);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Caja negra', 'PN-005', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('GPS', 'PN-006', AVION_ID);
    
END INTENTA_CREAR_AVION_MASDE10;
/

CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4(avion_id number) AS 
id_compuesta1 number;
id_compuesta2 number;
BEGIN
    INSERT INTO piezascompuestas (ID, nombre_pc) VALUES(AVION_ID, 'Avion 2');
    
    
    select secuencia_pieza_id.nextval into id_compuesta1 from dual;
    INSERT INTO piezascompuestas values(id_compuesta1, 'Cabina',AVION_ID);
    
    select secuencia_pieza_id.nextval into id_compuesta2 from dual;
    INSERT INTO piezascompuestas values(id_compuesta2, 'Asiento piloto',id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ( 'Asiento 4', 'PN-002', id_compuesta2);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Controles', 'PN-003', id_compuesta2);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 5', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 6', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 7', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 8', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 9', 'PN-002', id_compuesta1);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Asiento 10', 'PN-002', id_compuesta1);
    
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Fuselaje', 'PN-001', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 3', 'PN-004', AVION_ID);
    INSERT INTO piezassimples (nombre_ps, part_number, id_pieza_compuesta) VALUES ('Motor 4', 'PN-004', AVION_ID);
    
END INTENTA_CREAR_AVION_MASDE4;
/

CREATE OR REPLACE FUNCTION CUANTAS_PIEZAS_SIMPLES(ID_PIEZA NUMBER) RETURN VARCHAR2 AS 
NUM_PIEZAS_SIMPLES NUMBER;
BEGIN
  SELECT COUNT(*) INTO NUM_PIEZAS_SIMPLES FROM PIEZASSIMPLES WHERE id_pieza_compuesta = ID_PIEZA;
  RETURN NUM_PIEZAS_SIMPLES;
END CUANTAS_PIEZAS_SIMPLES;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_AVION(ID_AVION NUMBER) RETURN VARCHAR2 AS 
ES_UN_AVION NUMBER;
PIEZAS_SIMPLES NUMBER;
BEGIN
  ES_UN_AVION := ES_AVION(ID_AVION);
  IF es_un_avion != 1 THEN
    
    raise_application_error(-20010, 'ESTO NO ES UN AVION');
  ELSE
      PIEZAS_SIMPLES := 0;
      for j in (
        select id from piezascompuestas 
        start with id =  id_avion
        connect by prior id = id_pieza_compuesta
      ) 
      
      loop
        
        
        PIEZAS_SIMPLES := PIEZAS_SIMPLES + cuantas_piezas_simples(j.id);
      end loop;
    
    
    IF piezas_simples > 10 THEN
      raise_application_error(-20011, 'ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL');
    END IF;
  END IF;
  RETURN 'TODO ESTA CORRECTO';
END COMPRUEBA_AVION;
/

CREATE OR REPLACE FUNCTION COMPRUEBA_PIEZA(ID_PIEZA NUMBER) RETURN VARCHAR2 AS 
ES_UN_AVION NUMBER;
PIEZAS_SIMPLES NUMBER;
BEGIN
  ES_UN_AVION := ES_AVION(ID_PIEZA);
  IF es_un_avion = 1 THEN
    raise_application_error(-20012, 'ESTO ES UN AVION');
  ELSE
      PIEZAS_SIMPLES := 0;
      for j in (
        select id from piezascompuestas 
        start with id =  ID_PIEZA
        connect by prior id = id_pieza_compuesta
      ) 
      loop
         PIEZAS_SIMPLES := PIEZAS_SIMPLES + cuantas_piezas_simples(j.id);
      end loop;
    
    IF piezas_simples > 4 THEN
      raise_application_error(-20013, 'ESTA PIEZA COMPUESTA TIENE MAS DE 4 PIEZAS SIMPLES EN TOTAL');
    END IF;
  END IF;
  RETURN 'TODO ESTA CORRECTO';
END COMPRUEBA_PIEZA;
/

















drop user lmiguel cascade;
 
 create user lmiguel identified by lmiguel;
 grant resource,connect, create view, create procedure to lmiguel;
 connect lmiguel/lmiguel;
 @lmiguel.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:08 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL> 
User dropped.

SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table created.


Table altered.


Table altered.


Table altered.


Table altered.


View created.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Trigger created.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Function created.


Function created.


Function created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       3000
  Cabina									 19	   3000
    Asiento piloto								 20	     19
      Asiento 4 	       SN-10015 	    PN-002			 21	     20
      Controles 	       SN-10016 	    PN-003			 22	     20
    Asiento 5		       SN-10017 	    PN-002			 23	     19
    Asiento 6		       SN-10018 	    PN-002			 24	     19
    Asiento 7		       SN-10019 	    PN-002			 25	     19
    Asiento 8		       SN-10020 	    PN-002			 26	     19
    Asiento 9		       SN-10021 	    PN-002			 27	     19
    Asiento 10		       SN-10022 	    PN-002			 28	     19
  Fuselaje		       SN-10023 	    PN-001			 29	   3000
  Motor 3		       SN-10024 	    PN-004			 30	   3000
  Motor 4		       SN-10025 	    PN-004			 31	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       3000
  Cabina									 19	   3000
    Asiento piloto								 20	     19
      Asiento 4 	       SN-10015 	    PN-002			 21	     20
      Controles 	       SN-10016 	    PN-003			 22	     20
    Asiento 5		       SN-10017 	    PN-002			 23	     19
    Asiento 6		       SN-10018 	    PN-002			 24	     19
    Asiento 7		       SN-10019 	    PN-002			 25	     19
    Asiento 8		       SN-10020 	    PN-002			 26	     19
    Asiento 9		       SN-10021 	    PN-002			 27	     19
    Asiento 10		       SN-10022 	    PN-002			 28	     19
  Fuselaje		       SN-10023 	    PN-001			 29	   3000
  Motor 3		       SN-10024 	    PN-004			 30	   3000
  Motor 4		       SN-10025 	    PN-004			 31	   3000
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Cabina									  1	   1000
    Asiento piloto								  2	      1
      Asiento 1 	       SN-1001		    PN-002			  3	      2
      Controles 	       SN-1002		    PN-003			  4	      2
    Asiento 2		       SN-1003		    PN-002			  5	      1
    Asiento 3		       SN-1004		    PN-002			  6	      1
  Fuselaje		       SN-1005		    PN-001			  7	   1000
  Motor 1		       SN-1006		    PN-004			  8	   1000
  Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			 10	   2000
  Motor 1		       SN-1009		    PN-004			 11	   2000
  Motor 2		       SN-10010 	    PN-004			 12	   2000
  Cabina									 13	   2000
    Asiento 2		       SN-10011 	    PN-002			 14	     13
    Asiento 3		       SN-10012 	    PN-002			 15	     13
    Asiento piloto								 16	     13
      Asiento 1 	       SN-10013 	    PN-002			 17	     16
      Controles 	       SN-10014 	    PN-003			 18	     16
Avion 2 								       4000
  Fuselaje		       SN-10026 	    PN-001			 32	   4000
  Motor 3		       SN-10027 	    PN-004			 33	   4000
  Motor 4		       SN-10028 	    PN-004			 34	   4000
  Cabina									 35	   4000
    Asiento 5		       SN-10029 	    PN-002			 36	     35
    Asiento 6		       SN-10030 	    PN-002			 37	     35
    Asiento 7		       SN-10031 	    PN-002			 38	     35
    Asiento 8		       SN-10032 	    PN-002			 39	     35
    Asiento 9		       SN-10033 	    PN-002			 40	     35
    Asiento 10		       SN-10034 	    PN-002			 41	     35
    Asiento piloto								 42	     35
      Asiento 4 	       SN-10035 	    PN-002			 43	     42
      Controles 	       SN-10036 	    PN-003			 44	     42
Avion 3 								       5000
  Cabina									 45	   5000
    Asiento piloto								 46	     45
      Asiento 11	       SN-10037 	    PN-002			 47	     46
      Controles 	       SN-10038 	    PN-003			 48	     46
    Asiento copiloto								 49	     45
      Asiento 12	       SN-10039 	    PN-002			 50	     49
      Controles 	       SN-10040 	    PN-003			 51	     49
  Fuselaje		       SN-10041 	    PN-001			 52	   5000
  Motor 5		       SN-10042 	    PN-004			 53	   5000
  Motor 6		       SN-10043 	    PN-004			 54	   5000
  Motor 7		       SN-10044 	    PN-004			 55	   5000
  Motor 8		       SN-10045 	    PN-004			 56	   5000
  Caja negra		       SN-10046 	    PN-005			 57	   5000
  GPS			       SN-10047 	    PN-006			 58	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
TODO ESTA CORRECTO

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20011: ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL
ORA-06512: at "LMIGUEL.COMPRUEBA_AVION", line 25


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20011: ESTE AVION TIENE MAS DE 10 PIEZAS SIMPLES EN TOTAL
ORA-06512: at "LMIGUEL.COMPRUEBA_AVION", line 25


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   lporrero
****************************************************
****************************************************
****************************************************
--------------------------------------------------------
-- Archivo creado  - miércoles-abril-24-2013   
--------------------------------------------------------
--------------------------------------------------------
--  DDL for Sequence SECUENCIA_PIEZA_ID
--------------------------------------------------------

   CREATE SEQUENCE  "SECUENCIA_PIEZA_ID"  MINVALUE 1 MAXVALUE 999999 INCREMENT BY 1 START WITH 1 NOCACHE  NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Sequence SECUENCIA_SERIALNUMBER
--------------------------------------------------------

   CREATE SEQUENCE  "SECUENCIA_SERIALNUMBER"  MINVALUE 1001 MAXVALUE 999999 INCREMENT BY 1 START WITH 1001 NOCACHE  NOORDER  NOCYCLE ;
--------------------------------------------------------
--  DDL for Table PIEZA
--------------------------------------------------------

  CREATE TABLE "PIEZA" 
   (	"ID_PIEZA" NUMBER(6,0), 
	"SN" VARCHAR2(20 BYTE), 
	"PN" VARCHAR2(20 BYTE), 
	"NOMBRE" VARCHAR2(20 BYTE), 
	"ID_PADRE" NUMBER(6,0)
   ) PCTFREE 10 PCTUSED 40 INITRANS 1 MAXTRANS 255 NOCOMPRESS LOGGING
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  DDL for View AVIONES_PROFESOR
--------------------------------------------------------

  CREATE OR REPLACE FORCE VIEW "AVIONES_PROFESOR" ("PARTE_ID", "PARTE_PADRE", "NOMBRE", "SN", "PN") AS 
  select id_pieza as PARTE_ID, id_padre as PARTE_PADRE, lpad('   ',3*(level -1)) || nombre as NOMBRE, SN, PN
  from pieza 
  start with id_padre is null
  connect by prior id_pieza = id_padre;
REM INSERTING into PIEZA
SET DEFINE OFF;
--------------------------------------------------------
--  DDL for Index PIEZA_PK
--------------------------------------------------------

  CREATE UNIQUE INDEX "PIEZA_PK" ON "PIEZA" ("ID_PIEZA") 
  PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "USERS" ;
--------------------------------------------------------
--  Constraints for Table PIEZA
--------------------------------------------------------

  ALTER TABLE "PIEZA" ADD CONSTRAINT "PIEZA_PK" PRIMARY KEY ("ID_PIEZA")
  USING INDEX PCTFREE 10 INITRANS 2 MAXTRANS 255 
  STORAGE(INITIAL 65536 NEXT 1048576 MINEXTENTS 1 MAXEXTENTS 2147483645
  PCTINCREASE 0 FREELISTS 1 FREELIST GROUPS 1 BUFFER_POOL DEFAULT)
  TABLESPACE "USERS"  ENABLE;
 
  ALTER TABLE "PIEZA" MODIFY ("ID_PIEZA" NOT NULL ENABLE);
--------------------------------------------------------
--  DDL for Trigger PONER_ID_Y_SN
--------------------------------------------------------

  CREATE OR REPLACE TRIGGER "PONER_ID_Y_SN" 
BEFORE INSERT ON PIEZA 
FOR EACH ROW 
BEGIN

  if inserting then    
    if :new."ID_PIEZA" is null then
      select SECUENCIA_PIEZA_ID.nextval into :NEW."ID_PIEZA" from dual;
      
      if :new."PN" is not null then
        select 'SN-' || SECUENCIA_SERIALNUMBER.nextval into :NEW."SN" from dual; 
      end if;
    end if;
  end if;

  exception
    when DUP_VAL_ON_INDEX
      then ROLLBACK;
END;

/


--------------------------------------------------------
--  DDL for Function GET_NUMERO_PIEZAS_SIMPLES
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "GET_NUMERO_PIEZAS_SIMPLES" 
(
  ID_AVION IN NUMBER  
) RETURN NUMBER AS 
numero_de_piezas_simples number;

BEGIN
  select count (SN) into numero_de_piezas_simples from pieza where
    SN in (select SN  from pieza
    start with id_pieza = id_avion       
    connect by prior id_pieza = id_padre); 
  RETURN numero_de_piezas_simples;  
END GET_NUMERO_PIEZAS_SIMPLES;

/


ALTER TRIGGER "PONER_ID_Y_SN" ENABLE;
--------------------------------------------------------
--  DDL for Function COMPRUEBA_AVION
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "COMPRUEBA_AVION" (id_avion number) RETURN number AS 
  numero_de_piezas_simples number;
  mi_id_padre number;
  MAXIMO_DE_PIEZAS_SIMPLES_AVION constant number := 10;
BEGIN
  select id_padre into mi_id_padre
    from pieza where id_pieza = id_avion;
  /* Comprueba que el id que se pasa a la funcion no sea de un avion*/
  if mi_id_padre is not null then
    raise_application_error(-20001, 'El id no es de un avion');
  end if;
  
  if mi_id_padre is null then
    numero_de_piezas_simples := get_numero_piezas_simples(id_avion);
    if numero_de_piezas_simples > MAXIMO_DE_PIEZAS_SIMPLES_AVION then
      raise_application_error(-20002, 'El avion tiene mas de ' ||
        MAXIMO_DE_PIEZAS_SIMPLES_AVION || ' piezas simples');
    end if;
  end if;  
  return numero_de_piezas_simples;
END COMPRUEBA_AVION;

/


--------------------------------------------------------
--  DDL for Function COMPRUEBA_PIEZA
--------------------------------------------------------

  CREATE OR REPLACE FUNCTION "COMPRUEBA_PIEZA" 
(
  ID_PIEZA_COMPUESTA IN NUMBER  
) RETURN number AS 
  mi_id_padre number;
  numero_de_piezas_simples number;
  MAXIMO_DE_PIEZAS_SIMPLES constant number := 4;
BEGIN
  select id_padre into mi_id_padre 
    from pieza where id_pieza_compuesta = id_pieza;
  if mi_id_padre is null then
    raise_application_error(-20003, 'El id es de un avion');
  end if;
  
  if mi_id_padre is not null then
    numero_de_piezas_simples := get_numero_piezas_simples(id_pieza_compuesta);
    if numero_de_piezas_simples > MAXIMO_DE_PIEZAS_SIMPLES then
      raise_application_error(-20004, 'La pieza compuesta  tiene mas de '
      || MAXIMO_DE_PIEZAS_SIMPLES || ' piezas simples');
    end if;
  end if;
  return numero_de_piezas_simples;
END COMPRUEBA_PIEZA;

/

--------------------------------------------------------
--  DDL for Procedure BORRAR_AVION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "BORRAR_AVION" 
(
  AVION_ID IN NUMBER  
) AS 
parte_avion pieza%rowtype;
BEGIN  
  /* Comprueba que el id que se pasa a la funcion sea de un avion*/
  select * into parte_avion
    from pieza where id_pieza = avion_id;
  if parte_avion.id_padre is not null then
    raise_application_error(-20001, 'El id no es de un avion');
  end if;
    
  if parte_avion.id_padre is null then
    delete from pieza where id_pieza in(
      select id_pieza from pieza
      start with id_pieza = avion_id      
      connect by prior id_pieza = id_padre
    );     
    dbms_output.put_line(parte_avion.nombre || ' con id = ' || avion_id || ' ha sido borrado.');    
  end if;
  
  exception 
  when no_data_found then
    dbms_output.put_line('El id no existe'); 
END BORRAR_AVION;

/
--------------------------------------------------------
--  DDL for Procedure BORRAR_AVIONES
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "BORRAR_AVIONES" AS 
parte_avion pieza%rowtype;
BEGIN  
  /*Recorrer toda la tabla en busca de aviones (id_padre = null)*/
  /*Si se encuentra uno, se recorren todas sus piezas con connect by prior y se borran*/

  for parte_avion in( select * from pieza where id_padre is null)
  loop
    if parte_avion.id_padre is null then
      delete from pieza where parte_avion.id_pieza in(
        select id_pieza from pieza
        start with id_pieza = id_pieza      
        connect by prior id_pieza = id_padre
      );     
    end if;   
  end loop;  
END BORRAR_AVIONES;

/

--------------------------------------------------------
--  DDL for Procedure COPIAR_PIEZAS_HIJAS
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "COPIAR_PIEZAS_HIJAS" 
(
  PIEZA_ID_PADRE IN NUMBER  
, PIEZA_COPIA_ID_PADRE IN NUMBER  
) AS 
pieza_original pieza%rowtype;
id_pieza_copia number;
BEGIN
  -- Se copian los hijos de cada pieza.
  for pieza_original in (select * from pieza where id_padre = PIEZA_ID_PADRE)
  loop
    insert into pieza (nombre, id_padre, pn)
    values (pieza_original.nombre, PIEZA_COPIA_ID_PADRE, pieza_original.pn);
    
    dbms_output.put_line(pieza_original.nombre || ' con id = ' ||
      pieza_original.id_pieza || ' ha sido copiado.');    
    
    -- Como el id no se puede copiar por ser PK, generamos un id nuevo para la
    -- pieza copia:
    select SECUENCIA_PIEZA_ID.currval into id_pieza_copia from dual;
    copiar_piezas_hijas(pieza_original.id_pieza, id_pieza_copia);    
  end loop;
END COPIAR_PIEZAS_HIJAS;

/

--------------------------------------------------------
--  DDL for Procedure COPIAR_AVION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "COPIAR_AVION" 
(
  AVION_ID IN NUMBER  
, COPIA_AVION_ID IN NUMBER  
) AS 
avion_original pieza%rowtype;
BEGIN
  select * into avion_original from pieza where id_pieza = avion_id;
  -- Se crea la copia del avion_original sin piezas:
  insert into pieza (id_pieza, sn, pn, nombre, id_padre)
    values (COPIA_AVION_ID, null, null, avion_original.nombre, null); 
    
  copiar_piezas_hijas(AVION_ID, COPIA_AVION_ID);   
END COPIAR_AVION;

/

--------------------------------------------------------
--  DDL for Procedure CREAR_AVION
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "CREAR_AVION" 
(
  ID_AVION IN NUMBER
) AS 
ID_ASIENTO_PILOTO number(6,0);
ID_CABINA number (6,0);
BEGIN  
  -- simpre que hay PN hay SN
  -- secuencia para poner el id_padre: currval
  insert into pieza(id_pieza, nombre) values(ID_AVION, 'Avion 1');
  insert into pieza(pn, nombre, id_padre) values('PN-001', 'Fuselaje', ID_AVION);
  insert into pieza(nombre, id_padre) values('Cabina', ID_AVION);    
  select SECUENCIA_PIEZA_ID.currval into ID_CABINA from dual;
  insert into pieza(nombre, id_padre) values('Asiento piloto', ID_CABINA);  
  select SECUENCIA_PIEZA_ID.currval into ID_ASIENTO_PILOTO from dual;
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 1', ID_ASIENTO_PILOTO);
  insert into pieza(pn, nombre, id_padre) values('PN-003', 'Controles', ID_ASIENTO_PILOTO);  
  
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 2', ID_CABINA);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 3', ID_CABINA);  
  
  insert into pieza(pn, nombre, id_padre) values('PN-004', 'Motor 1', ID_AVION);
  insert into pieza(pn, nombre, id_padre) values('PN-004', 'Motor 2', ID_AVION);  
END CREAR_AVION;

/
--------------------------------------------------------
--  DDL for Procedure INTENTA_CREAR_AVION_MASDE10
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "INTENTA_CREAR_AVION_MASDE10" 
(
  AVION_ID IN NUMBER 
) AS 
id_padre number(6,0);
ID_CABINA number (6,0);
BEGIN
  insert into pieza values(AVION_ID, null, null, 'Avion 3', null);
  insert into pieza values(null, null, 'PN-001', 'Fuselaje', AVION_ID);
  insert into pieza values(null, null, null, 'Cabina', AVION_ID);  
  
  select SECUENCIA_PIEZA_ID.currval into id_padre from dual;
  id_cabina := id_padre;
  insert into pieza values(null, null, null, 'Asiento piloto', id_padre);
  
  select SECUENCIA_PIEZA_ID.currval into id_padre from dual;
  insert into pieza values(null, null, 'PN-002', 'Asiento 11', id_padre);
  insert into pieza values(null, null, 'PN-003', 'Controles', id_padre);
    
  insert into pieza values(null, null, null, 'Asiento copiloto', id_cabina);
  select SECUENCIA_PIEZA_ID.currval into id_padre from dual;
  insert into pieza values(null, null, 'PN-002', 'Asiento 12', id_padre);  
  insert into pieza values(null, null, 'PN-003', 'Controles', id_padre);

  insert into pieza values(null, null, 'PN-004', 'Motor 5', AVION_ID);
  insert into pieza values(null, null, 'PN-004', 'Motor 6', AVION_ID);
  insert into pieza values(null, null, 'PN-004', 'Motor 7', AVION_ID);
  insert into pieza values(null, null, 'PN-004', 'Motor 8', AVION_ID);
  
  insert into pieza values(null, null, 'PN-005', 'Caja negra', AVION_ID);
  insert into pieza values(null, null, 'PN-006', 'GPS', AVION_ID);
END INTENTA_CREAR_AVION_MASDE10;

/
--------------------------------------------------------
--  DDL for Procedure INTENTA_CREAR_AVION_MASDE4
--------------------------------------------------------
set define off;

  CREATE OR REPLACE PROCEDURE "INTENTA_CREAR_AVION_MASDE4" 
(
  AVION_ID IN NUMBER  
) AS 
id_cabina number;
id_asiento_piloto number;
BEGIN
  insert into pieza(id_pieza, nombre) values(AVION_ID, 'Avion 2');    
  insert into pieza(pn, nombre, id_padre) values('PN-001', 'Fuselaje', AVION_ID);
  insert into pieza(nombre, id_padre) values('Cabina', AVION_ID);
  select SECUENCIA_PIEZA_ID.currval into id_cabina from dual;
  insert into pieza(nombre, id_padre) values('Asiento piloto', id_cabina);
  select SECUENCIA_PIEZA_ID.currval into id_asiento_piloto from dual;
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 4', id_asiento_piloto);
  insert into pieza(pn, nombre, id_padre) values('PN-003', 'Controles', id_asiento_piloto);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 5', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 6', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 7', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 8', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 9', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-002', 'Asiento 10', id_cabina);
  insert into pieza(pn, nombre, id_padre) values('PN-004', 'Motor 3', AVION_ID);
  insert into pieza(pn, nombre, id_padre) values('PN-004', 'Motor 4', AVION_ID);    
END INTENTA_CREAR_AVION_MASDE4;

/
drop user lporrero cascade;
 
 create user lporrero identified by lporrero;
 grant resource,connect, create view, create procedure to lporrero;
 connect lporrero/lporrero;
 @lporrero.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:10 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user lporrero cascade
            *
ERROR at line 1:
ORA-01918: user 'LPORRERO' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Sequence created.


Sequence created.


Table created.


View created.


Index created.


Table altered.


Table altered.


Trigger created.


Function created.


Trigger altered.


Function created.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.

Fuselaje con id = 1 ha sido copiado.
Cabina con id = 2 ha sido copiado.
Asiento piloto con id = 3 ha sido copiado.
Asiento 1 con id = 4 ha sido copiado.
Controles con id = 5 ha sido copiado.
Asiento 2 con id = 6 ha sido copiado.
Asiento 3 con id = 7 ha sido copiado.
Motor 1 con id = 8 ha sido copiado.
Motor 2 con id = 9 ha sido copiado.

Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
     Fuselaje		       SN-1008		    PN-001			 10	   2000
     Cabina									 11	   2000
	  Asiento piloto							 12	     11
	       Asiento 1       SN-1009		    PN-002			 13	     12
	       Controles       SN-1010		    PN-003			 14	     12
	  Asiento 2	       SN-1011		    PN-002			 15	     11
	  Asiento 3	       SN-1012		    PN-002			 16	     11
     Motor 1		       SN-1013		    PN-004			 17	   2000
     Motor 2		       SN-1014		    PN-004			 18	   2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
     Fuselaje		       SN-1008		    PN-001			 10	   2000
     Cabina									 11	   2000
	  Asiento piloto							 12	     11
	       Asiento 1       SN-1009		    PN-002			 13	     12
	       Controles       SN-1010		    PN-003			 14	     12
	  Asiento 2	       SN-1011		    PN-002			 15	     11
	  Asiento 3	       SN-1012		    PN-002			 16	     11
     Motor 1		       SN-1013		    PN-004			 17	   2000
     Motor 2		       SN-1014		    PN-004			 18	   2000
Avion 2 								       3000
     Fuselaje		       SN-1015		    PN-001			 19	   3000
     Cabina									 20	   3000
	  Asiento piloto							 21	     20
	       Asiento 4       SN-1016		    PN-002			 22	     21
	       Controles       SN-1017		    PN-003			 23	     21
	  Asiento 5	       SN-1018		    PN-002			 24	     20
	  Asiento 6	       SN-1019		    PN-002			 25	     20
	  Asiento 7	       SN-1020		    PN-002			 26	     20
	  Asiento 8	       SN-1021		    PN-002			 27	     20
	  Asiento 9	       SN-1022		    PN-002			 28	     20
	  Asiento 10	       SN-1023		    PN-002			 29	     20
     Motor 3		       SN-1024		    PN-004			 30	   3000
     Motor 4		       SN-1025		    PN-004			 31	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.

Fuselaje con id = 19 ha sido copiado.
Cabina con id = 20 ha sido copiado.
Asiento piloto con id = 21 ha sido copiado.
Asiento 4 con id = 22 ha sido copiado.
Controles con id = 23 ha sido copiado.
Asiento 5 con id = 24 ha sido copiado.
Asiento 6 con id = 25 ha sido copiado.
Asiento 7 con id = 26 ha sido copiado.
Asiento 8 con id = 27 ha sido copiado.
Asiento 9 con id = 28 ha sido copiado.
Asiento 10 con id = 29 ha sido copiado.
Motor 3 con id = 30 ha sido copiado.
Motor 4 con id = 31 ha sido copiado.

Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
     Fuselaje		       SN-1008		    PN-001			 10	   2000
     Cabina									 11	   2000
	  Asiento piloto							 12	     11
	       Asiento 1       SN-1009		    PN-002			 13	     12
	       Controles       SN-1010		    PN-003			 14	     12
	  Asiento 2	       SN-1011		    PN-002			 15	     11
	  Asiento 3	       SN-1012		    PN-002			 16	     11
     Motor 1		       SN-1013		    PN-004			 17	   2000
     Motor 2		       SN-1014		    PN-004			 18	   2000
Avion 2 								       3000
     Fuselaje		       SN-1015		    PN-001			 19	   3000
     Cabina									 20	   3000
	  Asiento piloto							 21	     20
	       Asiento 4       SN-1016		    PN-002			 22	     21
	       Controles       SN-1017		    PN-003			 23	     21
	  Asiento 5	       SN-1018		    PN-002			 24	     20
	  Asiento 6	       SN-1019		    PN-002			 25	     20
	  Asiento 7	       SN-1020		    PN-002			 26	     20
	  Asiento 8	       SN-1021		    PN-002			 27	     20
	  Asiento 9	       SN-1022		    PN-002			 28	     20
	  Asiento 10	       SN-1023		    PN-002			 29	     20
     Motor 3		       SN-1024		    PN-004			 30	   3000
     Motor 4		       SN-1025		    PN-004			 31	   3000
Avion 2 								       4000
     Fuselaje		       SN-1026		    PN-001			 32	   4000
     Cabina									 33	   4000
	  Asiento piloto							 34	     33
	       Asiento 4       SN-1027		    PN-002			 35	     34
	       Controles       SN-1028		    PN-003			 36	     34
	  Asiento 5	       SN-1029		    PN-002			 37	     33
	  Asiento 6	       SN-1030		    PN-002			 38	     33
	  Asiento 7	       SN-1031		    PN-002			 39	     33
	  Asiento 8	       SN-1032		    PN-002			 40	     33
	  Asiento 9	       SN-1033		    PN-002			 41	     33
	  Asiento 10	       SN-1034		    PN-002			 42	     33
     Motor 3		       SN-1035		    PN-004			 43	   4000
     Motor 4		       SN-1036		    PN-004			 44	   4000

48 rows selected.

****************Borrar avion 3000

Call completed.

Avion 2 con id = 3000 ha sido borrado.

Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
     Fuselaje		       SN-1008		    PN-001			 10	   2000
     Cabina									 11	   2000
	  Asiento piloto							 12	     11
	       Asiento 1       SN-1009		    PN-002			 13	     12
	       Controles       SN-1010		    PN-003			 14	     12
	  Asiento 2	       SN-1011		    PN-002			 15	     11
	  Asiento 3	       SN-1012		    PN-002			 16	     11
     Motor 1		       SN-1013		    PN-004			 17	   2000
     Motor 2		       SN-1014		    PN-004			 18	   2000
Avion 2 								       4000
     Fuselaje		       SN-1026		    PN-001			 32	   4000
     Cabina									 33	   4000
	  Asiento piloto							 34	     33
	       Asiento 4       SN-1027		    PN-002			 35	     34
	       Controles       SN-1028		    PN-003			 36	     34
	  Asiento 5	       SN-1029		    PN-002			 37	     33
	  Asiento 6	       SN-1030		    PN-002			 38	     33
	  Asiento 7	       SN-1031		    PN-002			 39	     33
	  Asiento 8	       SN-1032		    PN-002			 40	     33
	  Asiento 9	       SN-1033		    PN-002			 41	     33
	  Asiento 10	       SN-1034		    PN-002			 42	     33
     Motor 3		       SN-1035		    PN-004			 43	   4000
     Motor 4		       SN-1036		    PN-004			 44	   4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
     Fuselaje		       SN-1001		    PN-001			  1	   1000
     Cabina									  2	   1000
	  Asiento piloto							  3	      2
	       Asiento 1       SN-1002		    PN-002			  4	      3
	       Controles       SN-1003		    PN-003			  5	      3
	  Asiento 2	       SN-1004		    PN-002			  6	      2
	  Asiento 3	       SN-1005		    PN-002			  7	      2
     Motor 1		       SN-1006		    PN-004			  8	   1000
     Motor 2		       SN-1007		    PN-004			  9	   1000
Avion 1 								       2000
     Fuselaje		       SN-1008		    PN-001			 10	   2000
     Cabina									 11	   2000
	  Asiento piloto							 12	     11
	       Asiento 1       SN-1009		    PN-002			 13	     12
	       Controles       SN-1010		    PN-003			 14	     12
	  Asiento 2	       SN-1011		    PN-002			 15	     11
	  Asiento 3	       SN-1012		    PN-002			 16	     11
     Motor 1		       SN-1013		    PN-004			 17	   2000
     Motor 2		       SN-1014		    PN-004			 18	   2000
Avion 2 								       4000
     Fuselaje		       SN-1026		    PN-001			 32	   4000
     Cabina									 33	   4000
	  Asiento piloto							 34	     33
	       Asiento 4       SN-1027		    PN-002			 35	     34
	       Controles       SN-1028		    PN-003			 36	     34
	  Asiento 5	       SN-1029		    PN-002			 37	     33
	  Asiento 6	       SN-1030		    PN-002			 38	     33
	  Asiento 7	       SN-1031		    PN-002			 39	     33
	  Asiento 8	       SN-1032		    PN-002			 40	     33
	  Asiento 9	       SN-1033		    PN-002			 41	     33
	  Asiento 10	       SN-1034		    PN-002			 42	     33
     Motor 3		       SN-1035		    PN-004			 43	   4000
     Motor 4		       SN-1036		    PN-004			 44	   4000
Avion 3 								       5000
     Fuselaje		       SN-1037		    PN-001			 45	   5000
     Cabina									 46	   5000
	  Asiento piloto							 47	     46
	       Asiento 11      SN-1038		    PN-002			 48	     47
	       Controles       SN-1039		    PN-003			 49	     47
	  Asiento copiloto							 50	     46
	       Asiento 12      SN-1040		    PN-002			 51	     50
	       Controles       SN-1041		    PN-003			 52	     50
     Motor 5		       SN-1042		    PN-004			 53	   5000
     Motor 6		       SN-1043		    PN-004			 54	   5000
     Motor 7		       SN-1044		    PN-004			 55	   5000
     Motor 8		       SN-1045		    PN-004			 56	   5000
     Caja negra 	       SN-1046		    PN-005			 57	   5000
     GPS		       SN-1047		    PN-006			 58	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
---------------------
		    7

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20002: El avion tiene mas de 10 piezas simples
ORA-06512: at "LPORRERO.COMPRUEBA_AVION", line 16


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20002: El avion tiene mas de 10 piezas simples
ORA-06512: at "LPORRERO.COMPRUEBA_AVION", line 16


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   rmendez
****************************************************
****************************************************
****************************************************

--creacion de tablas
create table Pieza_Simple
	(id number(6,0),serial_number varchar(25),part_Number varchar(25),id_piezaCompuesta number(6,0), nombre varchar(25));
create table Pieza_Compuesta
	(id number(6,0), id_piezaCompuesta number(6,0), nombre varchar(25));
--creacion de las pk	
alter table Pieza_Simple
add CONSTRAINTS PK_Pieza_Simple
Primary Key (id);

alter table Pieza_Compuesta
add CONSTRAINTS PK_Pieza_Compuesta
Primary Key (id);
--creacion de las fk
alter table Pieza_Simple
add CONSTRAINTS FK_Simple_Compuesta
FOREIGN key (id_piezaCompuesta) references Pieza_Compuesta(id);

alter table Pieza_Compuesta
add CONSTRAINTS FK_Compuesta_Compuesta
FOREIGN key (id_piezaCompuesta) references Pieza_Compuesta(id);

--valores que no pueden se null. No va a ser null nada, sÃ³lo el id_piezacompuesta 
--en el caso de la tabla pieza compuesta.
alter table Pieza_Simple
add CONSTRAINTS serialNumberNotNull
check (serial_number is not null);

alter table Pieza_Simple
add CONSTRAINTS partNumberNotNull
check (part_number is not null);

alter table Pieza_Simple
add CONSTRAINTS idCompuestaNotNull
check (id_piezaCompuesta is not null);

alter table Pieza_Simple
add CONSTRAINTS nombrePSNotNull
check (nombre is not null);

alter table Pieza_Compuesta
add CONSTRAINTS nombrePCNotNull
check (nombre is not null);


--Creacion de las secuencias

--Secuencia para obtener el ID, es tanto el id de la tabla piezas compuestas, 
--como para la tabla pieza_simple
create sequence SECUENCIA_PIEZA_ID
increment by 1
start WITH 1
MAXVALUE 999999
MINVALUE 1;

--Secuencia para obtener el serial number
create sequence SECUENCIA_SERIALNUMBER
increment by 1
start WITH 1
MAXVALUE 999999
MINVALUE 1;

--Trigger para conseguir que si no ponemos los id de las piezas al introducir los datos,
--los ponga automÃ¡ticamente desde la secuencia_pieza_id ya creada
create or replace 
trigger SECUENCIA_PIEZA  
   before insert on "PIEZA_COMPUESTA" 
   for each row 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end SECUENCIA_PIEZA;
/

create or replace 
trigger SECUENCIAPIEZAID  
   before insert on "PIEZA_SIMPLE" 
   for each row 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end SECUENCIAPIEZAID;
/

--CreaciÃ³n de un trigger para que si no introducimos el SN de una pieza lo ponga de forma automÃ¡tica desde
--la secuencia creada SECUENCIA_SERIALNUMBER
create or replace 
trigger SERIAL_NUMBER  
   before insert on "PIEZA_SIMPLE" 
   for each row 
declare
  snletras varchar(25);
  snnum varchar(25);
begin  
   if inserting then 
      if :NEW."SERIAL_NUMBER" is null then
         select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIAL_NUMBER" from dual; 
      end if; 
   end if; 
end;
/

--Funcion que comprueba si una pieza compuesta es un avion
create or replace 
FUNCTION ES_AVION(id_avion numeric) RETURN numeric AS 
is_avion numeric;
BEGIN
  select id_piezacompuesta into is_avion from pieza_compuesta where id=id_avion;

  if (is_avion is not null) then
    RETURN 0;
  else
    return 1;
  end if;
END ES_AVION;
/

--Funcion que cuenta el numero de piezas simples en una pieza compuesta
create or replace 
FUNCTION CONTADOR_PIEZAS(id_pieza_compuesta numeric) RETURN numeric AS 
total numeric;
BEGIN
  select count (s.id) into total
  from pieza_simple s
  where s.id_piezacompuesta in (
            select c.id 
            from pieza_compuesta c
            start with c.id=id_pieza_compuesta
            connect by prior c.id=c.id_piezacompuesta);
              
  return total;
END CONTADOR_PIEZAS;
/

--Funcion que provoca un error si un avion tiene mas de 10 piezas simples, si no introducimos
--el id de un avion tambien da error
create or replace 
FUNCTION COMPRUEBA_AVION (id_avion numeric) RETURN VARCHAR2 AS 
comprobacion numeric;
piezas_simples numeric;
BEGIN

    select es_avion(id_avion) into comprobacion from dual;

    if comprobacion = 1 then
      select contador_piezas(id_avion) into piezas_simples from dual;
      if (piezas_simples < 10) then
        return 'Es una avion valida.';
      else
        raise_application_error(-20000,'El avion tiene demasiadas piezas');
      end if;
    else
      raise_application_error (-20001, 'El id no es de una avion');
    end if;
    
END COMPRUEBA_AVION;
/

--Funcion que comprueba que una pieza compuesta no tenga mas de 4 piezas simples,
--sino dara un error. Tambien da error si el id es el de un avion.
create or replace 
FUNCTION COMPRUEBA_PIEZA(id_pieza number) RETURN VARCHAR2 AS 
avion exception;
numeropiezasexcedido exception;
aviontrue number;
numeroPiezasSimples number;
BEGIN
 select es_avion (id_pieza) into aviontrue from dual;
 if aviontrue=1 then
   raise avion;
 
 else
  select contador_piezas (id_pieza) into numeropiezasSimples from dual;
    if numeropiezassimples<=4 then
      return 'El numero de piezas simples que la componen es correcto.';
    else
      raise numeropiezasexcedido;
    end if;  
   end if; 
END COMPRUEBA_PIEZA;
/

--Procedimiento para crear piezas simples, lo necesitaremos en todos los procedimientos de cerar aviones.
create or replace 
PROCEDURE CREAR_PIEZA_SIMPLE (id_padre numeric, pn varchar2, sn varchar2, nbr varchar2) AS 
BEGIN
  insert into pieza_simple (id_piezacompuesta,part_number,serial_number,nombre) 
  values (id_padre, pn, sn, nbr);
END CREAR_PIEZA_SIMPLE;
/

--Procedimiento para crear piezas compuestas, lo necesitaremos en todos los procedimientos de crear aviones.
create or replace 
PROCEDURE CREAR_PIEZA_COMPUESTA (id_padre numeric, nbr varchar2) AS 
BEGIN
  insert into pieza_compuesta (id_piezacompuesta, nombre)
  values (id_padre, nbr);
END CREAR_PIEZA_COMPUESTA;
/

--Procedimiento que crea un avion concreto al pasarle el id de dicho avion.
create or replace PROCEDURE CREAR_AVION(id_avion numeric) AS 
id_intermedio numeric;
id_intermedio2 numeric;
BEGIN
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 1');
 
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio 
	from pieza_compuesta 
	where nombre like 'Cabina' and id_piezacompuesta=id_avion;
  crear_pieza_simple(id_intermedio,'PN-002','SN-1004','Asiento 2');
  crear_pieza_simple(id_intermedio,'PN-002','SN-1005','Asiento 3');
  
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 
	from pieza_compuesta 
	where nombre like 'Asiento Piloto' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio,'PN-002','SN-1002','Asiento 1');
  crear_pieza_simple(id_intermedio,'PN-003','SN-1003','Controles');
  
  crear_pieza_simple(id_avion,'PN-004','SN-1006','Motor1');
  crear_pieza_simple(id_avion,'PN-004','SN-1007','Motor2');
  crear_pieza_simple(id_avion,'PN-001','SN-1001','Fuselaje');
END CREAR_AVION;
/

--Realizacion de la vista pedida, cuyo nombre es AVIONES_PROFESOR y lista todo.
Create view AVIONES_PROFESOR AS
	(SELECT ID AS PARTE_ID, ID_PIEZACOMPUESTA AS PARTE_PADRE, NOMBRE, NULL AS SN, NULL AS PN
		FROM PIEZA_COMPUESTA)
		UNION
(SELECT ID AS PARTE_ID, ID_PIEZACOMPUESTA AS PARTE_PADRE, NOMBRE, SERIAL_NUMBER AS SN, PART_NUMBER AS PN
	FROM PIEZA_SIMPLE);

--Procedimiento que borra piezas simples, serÃ¡ de utilidad para los procedimientos
--de borrado de aviones.
CREATE OR REPLACE PROCEDURE BORRAR_PIEZA_SIMPLE (ID_PIEZA_PADRE number) AS 
BEGIN

  DELETE FROM pieza_simple 
  WHERE id_piezacompuesta=id_pieza_padre;
  
END BORRAR_PIEZA_SIMPLE;
/	

--Procedimiento que borra piezas compuestas, serÃ¡ de utilidad para los procedimientos
--de borrado de aviones.
CREATE OR REPLACE PROCEDURE BORRAR_PIEZA_COMPUESTA (ID_PIEZA_PADRE number) AS 
PIEZAS_CONTENIDAS PIEZA_COMPUESTA%ROWTYPE;

BEGIN

FOR PIEZAS_CONTENIDAS IN (select c.id 
            from pieza_compuesta c
            start with c.id=ID_PIEZA_PADRE
            connect by prior c.id=c.id_piezacompuesta 
            ORDER BY 1 DESC)
LOOP
         BORRAR_PIEZA_SIMPLE(PIEZAS_CONTENIDAS.ID);
         DELETE FROM pieza_compuesta
         WHERE ID=PIEZAS_CONTENIDAS.ID;
END LOOP;
END BORRAR_PIEZA_COMPUESTA;
/

--Procedimiento que borra un avion incluidas todas sus piezas al pasarle un id de un avion
create or replace 
PROCEDURE BORRAR_AVION (ID_PIEZA_PADRE number) AS
PIEZAS_CONTENIDAS PIEZA_COMPUESTA%ROWTYPE;

BEGIN

FOR PIEZAS_CONTENIDAS IN (select c.id
            from pieza_compuesta c
            start with c.id=ID_PIEZA_PADRE
            connect by prior c.id=c.id_piezacompuesta
            ORDER BY 1 DESC)
LOOP
         BORRAR_PIEZA_SIMPLE(PIEZAS_CONTENIDAS.ID);
         if(piezas_contenidas.id!=id_pieza_padre)then
			 DELETE FROM pieza_compuesta
			 WHERE ID=PIEZAS_CONTENIDAS.ID;
         end if;
END LOOP;
  delete from pieza_compuesta
  where id=id_pieza_padre;
END BORRAR_AVION;
/

--Procedimiento encargado de borrar todas las aviones con sus piezas.
CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS 
AVIONES PIEZA_COMPUESTA%ROWTYPE;
BEGIN
 FOR AVIONES IN (SELECT ID
                 FROM pieza_compuesta
                 WHERE id_piezacompuesta IS NULL)
 LOOP
  BORRAR_AVION(AVIONES.ID);
 END LOOP;
END BORRAR_AVIONES;
/

--Procedimiento encargado de copiar piezas simples, se utilizarÃ¡ en el procedimiento copiar_piezaCompuesta
--que nos sera necesario para copiar un avion
CREATE OR REPLACE PROCEDURE COPIAR_PIEZA_SIMPLE (ID_PADRE_ORIGINAL NUMERIC, ID_PADRE_NUEVO NUMERIC) AS 
PIEZAS PIEZA_SIMPLE%ROWTYPE;
BEGIN
  FOR PIEZAS IN (SELECT * FROM PIEZA_SIMPLE WHERE ID_PIEZACOMPUESTA=ID_PADRE_ORIGINAL)
  LOOP
    INSERT INTO PIEZA_SIMPLE (ID_PIEZACOMPUESTA, PART_NUMBER, NOMBRE)
    VALUES (ID_PADRE_NUEVO, PIEZAS.PART_NUMBER, PIEZAS.NOMBRE);
  END LOOP;
END COPIAR_PIEZA_SIMPLE;
/

--Procedimiento que copia piezas compuestas.
CREATE OR REPLACE PROCEDURE COPIAR_PIEZA_COMPUESTA (ID_PADRE_ORIGINAL NUMERIC, ID_PADRE_NUEVO NUMERIC) AS 
PIEZAS PIEZA_SIMPLE%ROWTYPE;
PIEZA_NUEVA NUMERIC;
BEGIN
  FOR PIEZAS IN (SELECT * FROM PIEZA_COMPUESTA WHERE ID_PIEZACOMPUESTA=ID_PADRE_ORIGINAL)
  LOOP
  
  INSERT INTO pieza_compuesta (ID_PIEZACOMPUESTA, NOMBRE)
  VALUES (ID_PADRE_NUEVO, PIEZAS.NOMBRE);
  
  SELECT SECUENCIA_PIEZA_ID.CURRVAL INTO PIEZA_NUEVA FROM DUAL;
  
  copiar_pieza_simple(PIEZAS.ID,PIEZA_NUEVA);
  copiar_pieza_COMPUESTA(PIEZAS.ID,PIEZA_NUEVA);
  
  END LOOP;
END COPIAR_PIEZA_COMPUESTA;
/

--Procedimiento que copia un avion entero.
CREATE OR REPLACE PROCEDURE COPIAR_AVION (AVION_ID NUMBER, COPIA_AVION_ID NUMBER) AS 
AVION PIEZA_COMPUESTA%ROWTYPE;
BEGIN

  SELECT * INTO AVION FROM pieza_compuesta WHERE id=AVION_ID;

  INSERT INTO pieza_compuesta (ID, NOMBRE)
  VALUES (COPIA_AVION_ID,AVION.NOMBRE);
  
  copiar_pieza_simple(AVION_ID,COPIA_AVION_ID);
  copiar_pieza_COMPUESTA(AVION_ID,COPIA_AVION_ID);
  
END COPIAR_AVION;
/

--Creacion de un avion en el que una de sus piezas compuestas tiene mÃ¡s de 4 piezas simples.
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4(id_avion number) AS 
id_intermedio number;
id_intermedio2 number;
BEGIN
 
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 2');
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio from pieza_compuesta where id_piezacompuesta=id_avion and nombre like '%Cabina%';
  crear_pieza_simple(id_intermedio,'PN-002','SN-10011','Asiento 5');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10012','Asiento 6');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10013','Asiento 7');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10014','Asiento 8');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10015','Asiento 9');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10016','Asiento 10');
  
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like 'Asiento Piloto' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-1009','Asiento 4');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10010','Controles');
  crear_pieza_simple(id_avion,'PN-004','SN-10017','Motor3');
  crear_pieza_simple(id_avion,'PN-004','SN-10018','Motor4');
  crear_pieza_simple(id_avion,'PN-001','SN-1008','Fuselaje');

 
END INTENTA_CREAR_AVION_MASDE4;
/

--Creacion de un avion en el que tiene mas de 10 piezas simples.
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10(id_avion number) AS 
id_intermedio number;
id_intermedio2 number;
BEGIN
 
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 3');
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio from pieza_compuesta where id_piezacompuesta=id_avion and nombre like '%Cabina%';
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like '%Asiento Piloto%' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-10020','Asiento 11');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10021','Controles');
  crear_pieza_compuesta (id_intermedio,'Asiento Copiloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like '%Asiento Copiloto%' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-10022','Asiento 12');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10023','Controles');
  crear_pieza_simple (id_avion,'PN-004','SN-10024', 'Motor 5');
  crear_pieza_simple (id_avion,'PN-004','SN-10025', 'Motor 6');
  crear_pieza_simple (id_avion,'PN-004','SN-10026', 'Motor 7');
  crear_pieza_simple (id_avion,'PN-004','SN-10027', 'Motor 8');
  crear_pieza_simple (id_avion,'PN-005','SN-10028', 'Caja negra');
  crear_pieza_simple (id_avion,'PN-007','SN-10027', 'GPS');
  crear_pieza_simple(id_avion,'PN-001','SN-10019','Fuselaje');

  
 
END INTENTA_CREAR_AVION_MASDE10 ;
/


drop user rmendez cascade;
 
 create user rmendez identified by rmendez;
 grant resource,connect, create view, create procedure to rmendez;
 connect rmendez/rmendez;
 @rmendez.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:10 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user rmendez cascade
            *
ERROR at line 1:
ORA-01918: user 'RMENDEZ' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table created.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Trigger created.


Function created.


Function created.


Function created.


Function created.


Procedure created.


Procedure created.


Procedure created.


View created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 3000
  Cabina										   19	     3000
    Asiento 5		       SN-10011 		 PN-002 			   20	       19
    Asiento 6		       SN-10012 		 PN-002 			   21	       19
    Asiento 7		       SN-10013 		 PN-002 			   22	       19
    Asiento 8		       SN-10014 		 PN-002 			   23	       19
    Asiento 9		       SN-10015 		 PN-002 			   24	       19
    Asiento 10		       SN-10016 		 PN-002 			   25	       19
    Asiento Piloto									   26	       19
      Asiento 4 	       SN-1009			 PN-002 			   27	       26
      Controles 	       SN-10010 		 PN-003 			   28	       26
  Motor3		       SN-10017 		 PN-004 			   29	     3000
  Motor4		       SN-10018 		 PN-004 			   30	     3000
  Fuselaje		       SN-1008			 PN-001 			   31	     3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 3000
  Cabina										   19	     3000
    Asiento 5		       SN-10011 		 PN-002 			   20	       19
    Asiento 6		       SN-10012 		 PN-002 			   21	       19
    Asiento 7		       SN-10013 		 PN-002 			   22	       19
    Asiento 8		       SN-10014 		 PN-002 			   23	       19
    Asiento 9		       SN-10015 		 PN-002 			   24	       19
    Asiento 10		       SN-10016 		 PN-002 			   25	       19
    Asiento Piloto									   26	       19
      Asiento 4 	       SN-1009			 PN-002 			   27	       26
      Controles 	       SN-10010 		 PN-003 			   28	       26
  Motor3		       SN-10017 		 PN-004 			   29	     3000
  Motor4		       SN-10018 		 PN-004 			   30	     3000
  Fuselaje		       SN-1008			 PN-001 			   31	     3000
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42
Avion 3 										 5000
  Cabina										   45	     5000
    Asiento Piloto									   46	       45
      Asiento 11	       SN-10020 		 PN-002 			   47	       46
      Controles 	       SN-10021 		 PN-003 			   48	       46
    Asiento Copiloto									   49	       45
      Asiento 12	       SN-10022 		 PN-002 			   50	       49
      Controles 	       SN-10023 		 PN-003 			   51	       49
  Motor 5		       SN-10024 		 PN-004 			   52	     5000
  Motor 6		       SN-10025 		 PN-004 			   53	     5000
  Motor 7		       SN-10026 		 PN-004 			   54	     5000
  Motor 8		       SN-10027 		 PN-004 			   55	     5000
  Caja negra		       SN-10028 		 PN-005 			   56	     5000
  GPS			       SN-10027 		 PN-007 			   57	     5000
  Fuselaje		       SN-10019 		 PN-001 			   58	     5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Es una avion valida.

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20000: El avion tiene demasiadas piezas
ORA-06512: at "RMENDEZ.COMPRUEBA_AVION", line 13


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20000: El avion tiene demasiadas piezas
ORA-06512: at "RMENDEZ.COMPRUEBA_AVION", line 13


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   rsanchez
****************************************************
****************************************************
****************************************************

--creacion de tablas
create table Pieza_Simple
	(id number(6,0),serial_number varchar(25),part_Number varchar(25),id_piezaCompuesta number(6,0), nombre varchar(25));
create table Pieza_Compuesta
	(id number(6,0), id_piezaCompuesta number(6,0), nombre varchar(25));
--creacion de las pk	
alter table Pieza_Simple
add CONSTRAINTS PK_Pieza_Simple
Primary Key (id);

alter table Pieza_Compuesta
add CONSTRAINTS PK_Pieza_Compuesta
Primary Key (id);
--creacion de las fk
alter table Pieza_Simple
add CONSTRAINTS FK_Simple_Compuesta
FOREIGN key (id_piezaCompuesta) references Pieza_Compuesta(id);

alter table Pieza_Compuesta
add CONSTRAINTS FK_Compuesta_Compuesta
FOREIGN key (id_piezaCompuesta) references Pieza_Compuesta(id);

--valores que no pueden se null. No va a ser null nada, sÃ³lo el id_piezacompuesta 
--en el caso de la tabla pieza compuesta.
alter table Pieza_Simple
add CONSTRAINTS serialNumberNotNull
check (serial_number is not null);

alter table Pieza_Simple
add CONSTRAINTS partNumberNotNull
check (part_number is not null);

alter table Pieza_Simple
add CONSTRAINTS idCompuestaNotNull
check (id_piezaCompuesta is not null);

alter table Pieza_Simple
add CONSTRAINTS nombrePSNotNull
check (nombre is not null);

alter table Pieza_Compuesta
add CONSTRAINTS nombrePCNotNull
check (nombre is not null);


--Creacion de las secuencias

--Secuencia para obtener el ID, es tanto el id de la tabla piezas compuestas, 
--como para la tabla pieza_simple
create sequence SECUENCIA_PIEZA_ID
increment by 1
start WITH 1
MAXVALUE 999999
MINVALUE 1;

--Secuencia para obtener el serial number
create sequence SECUENCIA_SERIALNUMBER
increment by 1
start WITH 1
MAXVALUE 999999
MINVALUE 1;

--Trigger para conseguir que si no ponemos los id de las piezas al introducir los datos,
--los ponga automÃ¡ticamente desde la secuencia_pieza_id ya creada
create or replace 
trigger SECUENCIA_PIEZA  
   before insert on "PIEZA_COMPUESTA" 
   for each row 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end SECUENCIA_PIEZA;
/

create or replace 
trigger SECUENCIAPIEZAID  
   before insert on "PIEZA_SIMPLE" 
   for each row 
begin  
   if inserting then 
      if :NEW."ID" is null then 
         select SECUENCIA_PIEZA_ID.nextval into :NEW."ID" from dual; 
      end if; 
   end if; 
end SECUENCIAPIEZAID;
/

--CreaciÃ³n de un trigger para que si no introducimos el SN de una pieza lo ponga de forma automÃ¡tica desde
--la secuencia creada SECUENCIA_SERIALNUMBER
create or replace 
trigger SERIAL_NUMBER  
   before insert on "PIEZA_SIMPLE" 
   for each row 
declare
  snletras varchar(25);
  snnum varchar(25);
begin  
   if inserting then 
      if :NEW."SERIAL_NUMBER" is null then
         select 'SN-'||SECUENCIA_SERIALNUMBER.nextval into :NEW."SERIAL_NUMBER" from dual; 
      end if; 
   end if; 
end;
/

--Funcion que comprueba si una pieza compuesta es un avion
create or replace 
FUNCTION ES_AVION(id_avion numeric) RETURN numeric AS 
is_avion numeric;
BEGIN
  select id_piezacompuesta into is_avion from pieza_compuesta where id=id_avion;

  if (is_avion is not null) then
    RETURN 0;
  else
    return 1;
  end if;
END ES_AVION;
/

--Funcion que cuenta el numero de piezas simples en una pieza compuesta
create or replace 
FUNCTION CONTADOR_PIEZAS(id_pieza_compuesta numeric) RETURN numeric AS 
total numeric;
BEGIN
  select count (s.id) into total
  from pieza_simple s
  where s.id_piezacompuesta in (
            select c.id 
            from pieza_compuesta c
            start with c.id=id_pieza_compuesta
            connect by prior c.id=c.id_piezacompuesta);
              
  return total;
END CONTADOR_PIEZAS;
/

--Funcion que provoca un error si un avion tiene mas de 10 piezas simples, si no introducimos
--el id de un avion tambien da error
create or replace 
FUNCTION COMPRUEBA_AVION (id_avion numeric) RETURN VARCHAR2 AS 
comprobacion numeric;
piezas_simples numeric;
BEGIN

    select es_avion(id_avion) into comprobacion from dual;

    if comprobacion = 1 then
      select contador_piezas(id_avion) into piezas_simples from dual;
      if (piezas_simples < 10) then
        return 'Es una avion valida.';
      else
        raise_application_error(-20000,'El avion tiene demasiadas piezas');
      end if;
    else
      raise_application_error (-20001, 'El id no es de una avion');
    end if;
    
END COMPRUEBA_AVION;
/

--Funcion que comprueba que una pieza compuesta no tenga mas de 4 piezas simples,
--sino dara un error. Tambien da error si el id es el de un avion.
create or replace 
FUNCTION COMPRUEBA_PIEZA(id_pieza number) RETURN VARCHAR2 AS 
avion exception;
numeropiezasexcedido exception;
aviontrue number;
numeroPiezasSimples number;
BEGIN
 select es_avion (id_pieza) into aviontrue from dual;
 if aviontrue=1 then
   raise avion;
 
 else
  select contador_piezas (id_pieza) into numeropiezasSimples from dual;
    if numeropiezassimples<=4 then
      return 'El numero de piezas simples que la componen es correcto.';
    else
      raise numeropiezasexcedido;
    end if;  
   end if; 
END COMPRUEBA_PIEZA;
/

--Procedimiento para crear piezas simples, lo necesitaremos en todos los procedimientos de cerar aviones.
create or replace 
PROCEDURE CREAR_PIEZA_SIMPLE (id_padre numeric, pn varchar2, sn varchar2, nbr varchar2) AS 
BEGIN
  insert into pieza_simple (id_piezacompuesta,part_number,serial_number,nombre) 
  values (id_padre, pn, sn, nbr);
END CREAR_PIEZA_SIMPLE;
/

--Procedimiento para crear piezas compuestas, lo necesitaremos en todos los procedimientos de crear aviones.
create or replace 
PROCEDURE CREAR_PIEZA_COMPUESTA (id_padre numeric, nbr varchar2) AS 
BEGIN
  insert into pieza_compuesta (id_piezacompuesta, nombre)
  values (id_padre, nbr);
END CREAR_PIEZA_COMPUESTA;
/

--Procedimiento que crea un avion concreto al pasarle el id de dicho avion.
create or replace PROCEDURE CREAR_AVION(id_avion numeric) AS 
id_intermedio numeric;
id_intermedio2 numeric;
BEGIN
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 1');
 
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio 
	from pieza_compuesta 
	where nombre like 'Cabina' and id_piezacompuesta=id_avion;
  crear_pieza_simple(id_intermedio,'PN-002','SN-1004','Asiento 2');
  crear_pieza_simple(id_intermedio,'PN-002','SN-1005','Asiento 3');
  
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 
	from pieza_compuesta 
	where nombre like 'Asiento Piloto' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio,'PN-002','SN-1002','Asiento 1');
  crear_pieza_simple(id_intermedio,'PN-003','SN-1003','Controles');
  
  crear_pieza_simple(id_avion,'PN-004','SN-1006','Motor1');
  crear_pieza_simple(id_avion,'PN-004','SN-1007','Motor2');
  crear_pieza_simple(id_avion,'PN-001','SN-1001','Fuselaje');
END CREAR_AVION;
/

--Realizacion de la vista pedida, cuyo nombre es AVIONES_PROFESOR y lista todo.
Create view AVIONES_PROFESOR AS
	(SELECT ID AS PARTE_ID, ID_PIEZACOMPUESTA AS PARTE_PADRE, NOMBRE, NULL AS SN, NULL AS PN
		FROM PIEZA_COMPUESTA)
		UNION
(SELECT ID AS PARTE_ID, ID_PIEZACOMPUESTA AS PARTE_PADRE, NOMBRE, SERIAL_NUMBER AS SN, PART_NUMBER AS PN
	FROM PIEZA_SIMPLE);

--Procedimiento que borra piezas simples, serÃ¡ de utilidad para los procedimientos
--de borrado de aviones.
CREATE OR REPLACE PROCEDURE BORRAR_PIEZA_SIMPLE (ID_PIEZA_PADRE number) AS 
BEGIN

  DELETE FROM pieza_simple 
  WHERE id_piezacompuesta=id_pieza_padre;
  
END BORRAR_PIEZA_SIMPLE;
/	

--Procedimiento que borra piezas compuestas, serÃ¡ de utilidad para los procedimientos
--de borrado de aviones.
CREATE OR REPLACE PROCEDURE BORRAR_PIEZA_COMPUESTA (ID_PIEZA_PADRE number) AS 
PIEZAS_CONTENIDAS PIEZA_COMPUESTA%ROWTYPE;

BEGIN

FOR PIEZAS_CONTENIDAS IN (select c.id 
            from pieza_compuesta c
            start with c.id=ID_PIEZA_PADRE
            connect by prior c.id=c.id_piezacompuesta 
            ORDER BY 1 DESC)
LOOP
         BORRAR_PIEZA_SIMPLE(PIEZAS_CONTENIDAS.ID);
         DELETE FROM pieza_compuesta
         WHERE ID=PIEZAS_CONTENIDAS.ID;
END LOOP;
END BORRAR_PIEZA_COMPUESTA;
/

--Procedimiento que borra un avion incluidas todas sus piezas al pasarle un id de un avion
create or replace 
PROCEDURE BORRAR_AVION (ID_PIEZA_PADRE number) AS
PIEZAS_CONTENIDAS PIEZA_COMPUESTA%ROWTYPE;

BEGIN

FOR PIEZAS_CONTENIDAS IN (select c.id
            from pieza_compuesta c
            start with c.id=ID_PIEZA_PADRE
            connect by prior c.id=c.id_piezacompuesta
            ORDER BY 1 DESC)
LOOP
         BORRAR_PIEZA_SIMPLE(PIEZAS_CONTENIDAS.ID);
         if(piezas_contenidas.id!=id_pieza_padre)then
			 DELETE FROM pieza_compuesta
			 WHERE ID=PIEZAS_CONTENIDAS.ID;
         end if;
END LOOP;
  delete from pieza_compuesta
  where id=id_pieza_padre;
END BORRAR_AVION;
/

--Procedimiento encargado de borrar todas las aviones con sus piezas.
CREATE OR REPLACE PROCEDURE BORRAR_AVIONES AS 
AVIONES PIEZA_COMPUESTA%ROWTYPE;
BEGIN
 FOR AVIONES IN (SELECT ID
                 FROM pieza_compuesta
                 WHERE id_piezacompuesta IS NULL)
 LOOP
  BORRAR_AVION(AVIONES.ID);
 END LOOP;
END BORRAR_AVIONES;
/

--Procedimiento encargado de copiar piezas simples, se utilizarÃ¡ en el procedimiento copiar_piezaCompuesta
--que nos sera necesario para copiar un avion
CREATE OR REPLACE PROCEDURE COPIAR_PIEZA_SIMPLE (ID_PADRE_ORIGINAL NUMERIC, ID_PADRE_NUEVO NUMERIC) AS 
PIEZAS PIEZA_SIMPLE%ROWTYPE;
BEGIN
  FOR PIEZAS IN (SELECT * FROM PIEZA_SIMPLE WHERE ID_PIEZACOMPUESTA=ID_PADRE_ORIGINAL)
  LOOP
    INSERT INTO PIEZA_SIMPLE (ID_PIEZACOMPUESTA, PART_NUMBER, NOMBRE)
    VALUES (ID_PADRE_NUEVO, PIEZAS.PART_NUMBER, PIEZAS.NOMBRE);
  END LOOP;
END COPIAR_PIEZA_SIMPLE;
/

--Procedimiento que copia piezas compuestas.
CREATE OR REPLACE PROCEDURE COPIAR_PIEZA_COMPUESTA (ID_PADRE_ORIGINAL NUMERIC, ID_PADRE_NUEVO NUMERIC) AS 
PIEZAS PIEZA_SIMPLE%ROWTYPE;
PIEZA_NUEVA NUMERIC;
BEGIN
  FOR PIEZAS IN (SELECT * FROM PIEZA_COMPUESTA WHERE ID_PIEZACOMPUESTA=ID_PADRE_ORIGINAL)
  LOOP
  
  INSERT INTO pieza_compuesta (ID_PIEZACOMPUESTA, NOMBRE)
  VALUES (ID_PADRE_NUEVO, PIEZAS.NOMBRE);
  
  SELECT SECUENCIA_PIEZA_ID.CURRVAL INTO PIEZA_NUEVA FROM DUAL;
  
  copiar_pieza_simple(PIEZAS.ID,PIEZA_NUEVA);
  copiar_pieza_COMPUESTA(PIEZAS.ID,PIEZA_NUEVA);
  
  END LOOP;
END COPIAR_PIEZA_COMPUESTA;
/

--Procedimiento que copia un avion entero.
CREATE OR REPLACE PROCEDURE COPIAR_AVION (AVION_ID NUMBER, COPIA_AVION_ID NUMBER) AS 
AVION PIEZA_COMPUESTA%ROWTYPE;
BEGIN

  SELECT * INTO AVION FROM pieza_compuesta WHERE id=AVION_ID;

  INSERT INTO pieza_compuesta (ID, NOMBRE)
  VALUES (COPIA_AVION_ID,AVION.NOMBRE);
  
  copiar_pieza_simple(AVION_ID,COPIA_AVION_ID);
  copiar_pieza_COMPUESTA(AVION_ID,COPIA_AVION_ID);
  
END COPIAR_AVION;
/

--Creacion de un avion en el que una de sus piezas compuestas tiene mÃ¡s de 4 piezas simples.
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE4(id_avion number) AS 
id_intermedio number;
id_intermedio2 number;
BEGIN
 
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 2');
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio from pieza_compuesta where id_piezacompuesta=id_avion and nombre like '%Cabina%';
  crear_pieza_simple(id_intermedio,'PN-002','SN-10011','Asiento 5');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10012','Asiento 6');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10013','Asiento 7');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10014','Asiento 8');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10015','Asiento 9');
  crear_pieza_simple(id_intermedio,'PN-002','SN-10016','Asiento 10');
  
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like 'Asiento Piloto' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-1009','Asiento 4');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10010','Controles');
  crear_pieza_simple(id_avion,'PN-004','SN-10017','Motor3');
  crear_pieza_simple(id_avion,'PN-004','SN-10018','Motor4');
  crear_pieza_simple(id_avion,'PN-001','SN-1008','Fuselaje');

 
END INTENTA_CREAR_AVION_MASDE4;
/

--Creacion de un avion en el que tiene mas de 10 piezas simples.
CREATE OR REPLACE PROCEDURE INTENTA_CREAR_AVION_MASDE10(id_avion number) AS 
id_intermedio number;
id_intermedio2 number;
BEGIN
 
  insert into pieza_compuesta (id, nombre) values (id_avion, 'Avion 3');
  crear_pieza_compuesta(id_avion,'Cabina');
  select id into id_intermedio from pieza_compuesta where id_piezacompuesta=id_avion and nombre like '%Cabina%';
  crear_pieza_compuesta(id_intermedio,'Asiento Piloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like '%Asiento Piloto%' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-10020','Asiento 11');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10021','Controles');
  crear_pieza_compuesta (id_intermedio,'Asiento Copiloto');
  select id into id_intermedio2 from pieza_compuesta where nombre like '%Asiento Copiloto%' and id_piezacompuesta=id_intermedio;
  crear_pieza_simple(id_intermedio2,'PN-002','SN-10022','Asiento 12');
  crear_pieza_simple(id_intermedio2,'PN-003','SN-10023','Controles');
  crear_pieza_simple (id_avion,'PN-004','SN-10024', 'Motor 5');
  crear_pieza_simple (id_avion,'PN-004','SN-10025', 'Motor 6');
  crear_pieza_simple (id_avion,'PN-004','SN-10026', 'Motor 7');
  crear_pieza_simple (id_avion,'PN-004','SN-10027', 'Motor 8');
  crear_pieza_simple (id_avion,'PN-005','SN-10028', 'Caja negra');
  crear_pieza_simple (id_avion,'PN-007','SN-10027', 'GPS');
  crear_pieza_simple(id_avion,'PN-001','SN-10019','Fuselaje');

  
 
END INTENTA_CREAR_AVION_MASDE10 ;
/


drop user rsanchez cascade;
 
 create user rsanchez identified by rsanchez;
 grant resource,connect, create view, create procedure to rsanchez;
 connect rsanchez/rsanchez;
 @rsanchez.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:11 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user rsanchez cascade
            *
ERROR at line 1:
ORA-01918: user 'RSANCHEZ' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Table created.


Table created.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Table altered.


Sequence created.


Sequence created.


Trigger created.


Trigger created.


Trigger created.


Function created.


Function created.


Function created.


Function created.


Procedure created.


Procedure created.


Procedure created.


View created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 3000
  Cabina										   19	     3000
    Asiento 5		       SN-10011 		 PN-002 			   20	       19
    Asiento 6		       SN-10012 		 PN-002 			   21	       19
    Asiento 7		       SN-10013 		 PN-002 			   22	       19
    Asiento 8		       SN-10014 		 PN-002 			   23	       19
    Asiento 9		       SN-10015 		 PN-002 			   24	       19
    Asiento 10		       SN-10016 		 PN-002 			   25	       19
    Asiento Piloto									   26	       19
      Asiento 4 	       SN-1009			 PN-002 			   27	       26
      Controles 	       SN-10010 		 PN-003 			   28	       26
  Motor3		       SN-10017 		 PN-004 			   29	     3000
  Motor4		       SN-10018 		 PN-004 			   30	     3000
  Fuselaje		       SN-1008			 PN-001 			   31	     3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 3000
  Cabina										   19	     3000
    Asiento 5		       SN-10011 		 PN-002 			   20	       19
    Asiento 6		       SN-10012 		 PN-002 			   21	       19
    Asiento 7		       SN-10013 		 PN-002 			   22	       19
    Asiento 8		       SN-10014 		 PN-002 			   23	       19
    Asiento 9		       SN-10015 		 PN-002 			   24	       19
    Asiento 10		       SN-10016 		 PN-002 			   25	       19
    Asiento Piloto									   26	       19
      Asiento 4 	       SN-1009			 PN-002 			   27	       26
      Controles 	       SN-10010 		 PN-003 			   28	       26
  Motor3		       SN-10017 		 PN-004 			   29	     3000
  Motor4		       SN-10018 		 PN-004 			   30	     3000
  Fuselaje		       SN-1008			 PN-001 			   31	     3000
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN			 PN			     PARTE_ID PARTE_PADRE
------------------------------ ------------------------- ------------------------- ---------- -----------
Avion 1 										 1000
  Cabina										    1	     1000
    Asiento 2		       SN-1004			 PN-002 			    2		1
    Asiento 3		       SN-1005			 PN-002 			    3		1
    Asiento Piloto									    4		1
    Asiento 1		       SN-1002			 PN-002 			    5		1
    Controles		       SN-1003			 PN-003 			    6		1
  Motor1		       SN-1006			 PN-004 			    7	     1000
  Motor2		       SN-1007			 PN-004 			    8	     1000
  Fuselaje		       SN-1001			 PN-001 			    9	     1000
Avion 1 										 2000
  Motor1		       SN-1			 PN-004 			   10	     2000
  Motor2		       SN-2			 PN-004 			   11	     2000
  Fuselaje		       SN-3			 PN-001 			   12	     2000
  Cabina										   13	     2000
    Asiento 2		       SN-4			 PN-002 			   14	       13
    Asiento 3		       SN-5			 PN-002 			   15	       13
    Asiento 1		       SN-6			 PN-002 			   16	       13
    Controles		       SN-7			 PN-003 			   17	       13
    Asiento Piloto									   18	       13
Avion 2 										 4000
  Motor3		       SN-8			 PN-004 			   32	     4000
  Motor4		       SN-9			 PN-004 			   33	     4000
  Fuselaje		       SN-10			 PN-001 			   34	     4000
  Cabina										   35	     4000
    Asiento 5		       SN-11			 PN-002 			   36	       35
    Asiento 6		       SN-12			 PN-002 			   37	       35
    Asiento 7		       SN-13			 PN-002 			   38	       35
    Asiento 8		       SN-14			 PN-002 			   39	       35
    Asiento 9		       SN-15			 PN-002 			   40	       35
    Asiento 10		       SN-16			 PN-002 			   41	       35
    Asiento Piloto									   42	       35
      Asiento 4 	       SN-17			 PN-002 			   43	       42
      Controles 	       SN-18			 PN-003 			   44	       42
Avion 3 										 5000
  Cabina										   45	     5000
    Asiento Piloto									   46	       45
      Asiento 11	       SN-10020 		 PN-002 			   47	       46
      Controles 	       SN-10021 		 PN-003 			   48	       46
    Asiento Copiloto									   49	       45
      Asiento 12	       SN-10022 		 PN-002 			   50	       49
      Controles 	       SN-10023 		 PN-003 			   51	       49
  Motor 5		       SN-10024 		 PN-004 			   52	     5000
  Motor 6		       SN-10025 		 PN-004 			   53	     5000
  Motor 7		       SN-10026 		 PN-004 			   54	     5000
  Motor 8		       SN-10027 		 PN-004 			   55	     5000
  Caja negra		       SN-10028 		 PN-005 			   56	     5000
  GPS			       SN-10027 		 PN-007 			   57	     5000
  Fuselaje		       SN-10019 		 PN-001 			   58	     5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Es una avion valida.

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20000: El avion tiene demasiadas piezas
ORA-06512: at "RSANCHEZ.COMPRUEBA_AVION", line 13


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20000: El avion tiene demasiadas piezas
ORA-06512: at "RSANCHEZ.COMPRUEBA_AVION", line 13


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

****************************************************
****************************************************
****************************************************
**************   zzamora
****************************************************
****************************************************
****************************************************
--PROBLEMA: Se necesita informatizar la gestión de las piezas de aviones.
--Autores: Zahira Zamora y Carlos Dominguez
-----secuencia para las piezas compuestas
CREATE sequence SECUENCIA_PIEZA_ID
  start with 100
  increment by 1
  maxvalue 999999
  minvalue 100;

-----secuencia para las piezas simples  
CREATE sequence SECUENCIA_SERIALNUMBER
  start with 1001
  increment by 1
  maxvalue 999999
  minvalue 1001;

-----Creacion tabla de relaciones--------------------------------
CREATE TABLE aviones (
  idPieza        number(6,0) not null, 
  descripcion    VARCHAR2(20) not null,
  idPadre        number(6,0),
  serialNumber   VARCHAR2(20),
  partNumber     VARCHAR2(20)
  );

ALTER TABLE aviones
  add constraint aviones_pk
  primary key (idPieza);

ALTER TABLE aviones
  add constraint aviones_fk
  foreign key (idPadre) references aviones(idPieza);

ALTER TABLE aviones
  add constraint aviones_unique
  unique (serialNumber);

-----Creacion vista de relaciones--------------------------------
create view AVIONES_PROFESOR as
select idPieza PARTE_ID, idPadre PARTE_PADRE, descripcion NOMBRE, serialnumber SN, partnumber PN
from aviones;

-----Triggers ID y SN----------------------------
CREATE OR REPLACE TRIGGER PONER_ID_PIEZA 
BEFORE INSERT ON AVIONES 
FOR EACH ROW 
BEGIN
  if :NEW.idPieza is null then
    select secuencia_pieza_id.nextval into :NEW.idPieza from dual;
  end if;
END;
/

CREATE OR REPLACE TRIGGER PONER_SN_PIEZA 
BEFORE INSERT ON AVIONES 
FOR EACH ROW 
BEGIN
  if :NEW.partnumber is not null then
    if :NEW.serialNumber is null then
      select secuencia_serialnumber.nextval into :NEW.serialNumber from dual;
      :NEW.serialNumber := 'SN-' || :NEW.serialNumber;
    end if;
  end if;
END;
/

-----Procedimiento de creacion de aviones-------------------------    /TODO
create or replace 
PROCEDURE CREAR_AVION(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 1');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 1');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 1',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');  
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 2',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 3',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 1',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 2',padre0,'PN-004');
END CREAR_AVION;
/

-----función COMPRUEBA_AVION(ID), error si el avión tiene más de 10 piezas simples, o si el ID no es el de un avión.
create or replace 
FUNCTION COMPRUEBA_AVION(avion_id number) RETURN varchar2 AS   
  resultado number;
  nAvion number;  
BEGIN
  SELECT count(idPieza) into nAvion from aviones where idPieza = avion_id;
  
  if nAvion=0 then
    raise_application_error(-20004,'Avion no encontrado');
  else  
    SELECT count(serialNumber)
    INTO resultado
    FROM aviones
    START WITH idPieza = avion_id
    CONNECT BY PRIOR idPieza = idPadre; 
    
    if resultado > 10 then
      raise_application_error(-20005,'Avion incorrecto');
    else return 'Avion correcto';
    end if;
  end if;
END;
/

-----función COMPRUEBA_PIEZA(ID), error si la pieza tiene más de 4 piezas simples, o el ID es el de un avión.
create or replace 
FUNCTION COMPRUEBA_PIEZA(pieza_id number) RETURN varchar2 AS   
  resultado number;
  existe number;
  esAvion number;  
BEGIN
  SELECT count(idPieza) into existe from aviones where idPieza = pieza_id;
  
  if existe = 0 then
    raise_application_error(-20001,'No existe esa pieza');
  end if;
  
  SELECT idPadre into esAvion from aviones where idPieza = pieza_id;
  if esAvion is null then
    raise_application_error(-20002,'No es una pieza, es un avion');
  else    
    SELECT count(serialNumber)
    INTO resultado
    FROM aviones
    START WITH idPieza = pieza_id
    CONNECT BY PRIOR idPieza = idPadre; 
    
    if resultado > 4 then
      raise_application_error(-20003,'Pieza incorrecta, tiene mas de 4 piezas simples');
    else return 'Pieza correcta';
    end if;
  end if;
END;
/

-----Procedimiento de borrado de todos los aviones-------------------------
create or replace 
PROCEDURE BORRAR_AVIONES AS 
BEGIN
  DELETE FROM aviones;
END BORRAR_AVIONES;
/

-----Procedimiento de borrado de un solo avion-----------------------------
create or replace 
PROCEDURE BORRAR_AVION(avion_id number) AS 
  CURSOR c_piezas is select idPieza from aviones
                      START WITH idPieza = avion_id
                      CONNECT BY PRIOR idPieza = idPadre
                      order by 1 desc;
BEGIN
  for i in c_piezas loop
    if i.idPieza <> avion_id then
      DELETE FROM aviones where idPieza = i.idPieza;
    end if;
  end loop;
  DELETE FROM aviones where idPieza = avion_id;
END BORRAR_AVION;
/

-----Procedimiento COPIAR_AVION(avion_id number, copia_avion_id number) que cree
----- un avión con el mismo número de piezas y del mismo tipo que el original.-------

--procedimiento auxiliar copiar_hijos
create or replace 
PROCEDURE COPIAR_HIJOS(id_origen number, id_destino number) AS
  id_nuevo number;
  hijo_origen aviones%rowtype;
BEGIN
  for hijo_origen in (select * from aviones where idPadre=id_origen)
  loop
    insert into aviones (descripcion,idPadre,partNumber) 
                 values (hijo_origen.descripcion,id_destino,hijo_origen.partNumber);
    select secuencia_pieza_id.currval into id_nuevo from dual;
    copiar_hijos(hijo_origen.idPieza,id_nuevo);
  end loop;
END COPIAR_HIJOS;
/

--procedimiento principal
create or replace 
PROCEDURE COPIAR_AVION(avion_id number, copia_avion_id number) AS
  existe number;
  descripcion_existente aviones.descripcion%type;
  id_nuevo number;
BEGIN
  SELECT count(idPieza) into existe from aviones where idPieza = avion_id;
  
  if existe = 0 then
    raise_application_error(-20006,'No existe ese avion para copiarlo');
  end if;
  
  select descripcion into descripcion_existente from aviones where idPieza = avion_id;
  insert into aviones (idpieza,descripcion) values (copia_avion_id,descripcion_existente);
  copiar_hijos(avion_id,copia_avion_id);
END COPIAR_AVION;
/

-----INTENTA_CREAR_AVION_MASDE10 ----------------------------------------------------
create or replace 
PROCEDURE INTENTA_CREAR_AVION_MASDE10(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 3');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 3');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 11',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');
  
  insert into aviones (descripcion,idpadre) values('Asiento copiloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 12',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');    
  
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 5',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 6',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 7',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 8',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Caja negra',padre0,'PN-005');
  insert into aviones (descripcion,idpadre,partnumber) values('GPS',padre0,'PN-006');
END INTENTA_CREAR_AVION_MASDE10;
/

-----INTENTA_CREAR_AVION_MASDE4------------------------------------
create or replace 
PROCEDURE INTENTA_CREAR_AVION_MASDE4(avion_id number) AS 
  padre0 number;
  padre1 number;
  padre2 number;
BEGIN
  if avion_id is null then
    insert into aviones (descripcion) values ('Avion 2');
    select secuencia_pieza_id.currval into padre0 from dual;
  else
    insert into aviones (idpieza,descripcion) values (avion_id,'Avion 2');
    padre0 := avion_id;
  end if;
  
  insert into aviones (descripcion,idpadre,partnumber) values('Fuselaje',padre0,'PN-001');
  insert into aviones (descripcion,idpadre) values('Cabina',padre0);
  select secuencia_pieza_id.currval into padre1 from dual;
  insert into aviones (descripcion,idpadre) values('Asiento piloto',padre1);
  select secuencia_pieza_id.currval into padre2 from dual;
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 4',padre2,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Controles',padre2,'PN-003');
  
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 5',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 6',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 7',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 8',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 9',padre1,'PN-002');
  insert into aviones (descripcion,idpadre,partnumber) values('Asiento 10',padre1,'PN-002');     
  
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 3',padre0,'PN-004');
  insert into aviones (descripcion,idpadre,partnumber) values('Motor 4',padre0,'PN-004');  
END INTENTA_CREAR_AVION_MASDE4;
/
drop user zzamora cascade;
 
 create user zzamora identified by zzamora;
 grant resource,connect, create view, create procedure to zzamora;
 connect zzamora/zzamora;
 @zzamora.sql
 

SQL*Plus: Release 10.2.0.1.0 - Production on Tue Apr 30 19:00:12 2013

Copyright (c) 1982, 2005, Oracle.  All rights reserved.

SQL> Connected.
SQL> SQL> SQL> SQL> SQL>   drop user zzamora cascade
            *
ERROR at line 1:
ORA-01918: user 'ZZAMORA' does not exist


SQL> SQL> 
User created.

SQL> 
Grant succeeded.

SQL> Connected.
SQL> 
Sequence created.


Sequence created.


Table created.


Table altered.


Table altered.


Table altered.


View created.


Trigger created.


Trigger created.


Procedure created.


Function created.


Function created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.


Procedure created.

SQL> SQL>   2    3  Disconnected from Oracle Database 10g Express Edition Release 10.2.0.1.0 - Production

View created.

****************Borrar aviones

Call completed.


Call completed.

****************Crear avion 1000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000

10 rows selected.

****************Copiar avion 1000 en 2000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000

20 rows selected.

****************Crear avion 3000 (mas de 4)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       3000
  Fuselaje		       SN-1015		    PN-001			118	   3000
  Cabina									119	   3000
    Asiento piloto								120	    119
      Asiento 4 	       SN-1016		    PN-002			121	    120
      Controles 	       SN-1017		    PN-003			122	    120
    Asiento 5		       SN-1018		    PN-002			123	    119
    Asiento 6		       SN-1019		    PN-002			124	    119
    Asiento 7		       SN-1020		    PN-002			125	    119
    Asiento 8		       SN-1021		    PN-002			126	    119
    Asiento 9		       SN-1022		    PN-002			127	    119
    Asiento 10		       SN-1023		    PN-002			128	    119
  Motor 3		       SN-1024		    PN-004			129	   3000
  Motor 4		       SN-1025		    PN-004			130	   3000

34 rows selected.

****************Copiar avion 3000 en 4000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       3000
  Fuselaje		       SN-1015		    PN-001			118	   3000
  Cabina									119	   3000
    Asiento piloto								120	    119
      Asiento 4 	       SN-1016		    PN-002			121	    120
      Controles 	       SN-1017		    PN-003			122	    120
    Asiento 5		       SN-1018		    PN-002			123	    119
    Asiento 6		       SN-1019		    PN-002			124	    119
    Asiento 7		       SN-1020		    PN-002			125	    119
    Asiento 8		       SN-1021		    PN-002			126	    119
    Asiento 9		       SN-1022		    PN-002			127	    119
    Asiento 10		       SN-1023		    PN-002			128	    119
  Motor 3		       SN-1024		    PN-004			129	   3000
  Motor 4		       SN-1025		    PN-004			130	   3000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000

48 rows selected.

****************Borrar avion 3000

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000

34 rows selected.

****************Crear avion 5000 (mas de 10)

Call completed.


Call completed.


NOMBRE			       SN		    PN			   PARTE_ID PARTE_PADRE
------------------------------ -------------------- -------------------- ---------- -----------
Avion 1 								       1000
  Fuselaje		       SN-1001		    PN-001			100	   1000
  Cabina									101	   1000
    Asiento piloto								102	    101
      Asiento 1 	       SN-1002		    PN-002			103	    102
      Controles 	       SN-1003		    PN-003			104	    102
    Asiento 2		       SN-1004		    PN-002			105	    101
    Asiento 3		       SN-1005		    PN-002			106	    101
  Motor 1		       SN-1006		    PN-004			107	   1000
  Motor 2		       SN-1007		    PN-004			108	   1000
Avion 1 								       2000
  Fuselaje		       SN-1008		    PN-001			109	   2000
  Cabina									110	   2000
    Asiento piloto								111	    110
      Asiento 1 	       SN-1009		    PN-002			112	    111
      Controles 	       SN-1010		    PN-003			113	    111
    Asiento 2		       SN-1011		    PN-002			114	    110
    Asiento 3		       SN-1012		    PN-002			115	    110
  Motor 1		       SN-1013		    PN-004			116	   2000
  Motor 2		       SN-1014		    PN-004			117	   2000
Avion 2 								       4000
  Fuselaje		       SN-1026		    PN-001			131	   4000
  Cabina									132	   4000
    Asiento piloto								133	    132
      Asiento 4 	       SN-1027		    PN-002			134	    133
      Controles 	       SN-1028		    PN-003			135	    133
    Asiento 5		       SN-1029		    PN-002			136	    132
    Asiento 6		       SN-1030		    PN-002			137	    132
    Asiento 7		       SN-1031		    PN-002			138	    132
    Asiento 8		       SN-1032		    PN-002			139	    132
    Asiento 9		       SN-1033		    PN-002			140	    132
    Asiento 10		       SN-1034		    PN-002			141	    132
  Motor 3		       SN-1035		    PN-004			142	   4000
  Motor 4		       SN-1036		    PN-004			143	   4000
Avion 3 								       5000
  Fuselaje		       SN-1037		    PN-001			144	   5000
  Cabina									145	   5000
    Asiento piloto								146	    145
      Asiento 11	       SN-1038		    PN-002			147	    146
      Controles 	       SN-1039		    PN-003			148	    146
    Asiento copiloto								149	    145
      Asiento 12	       SN-1040		    PN-002			150	    149
      Controles 	       SN-1041		    PN-003			151	    149
  Motor 5		       SN-1042		    PN-004			152	   5000
  Motor 6		       SN-1043		    PN-004			153	   5000
  Motor 7		       SN-1044		    PN-004			154	   5000
  Motor 8		       SN-1045		    PN-004			155	   5000
  Caja negra		       SN-1046		    PN-005			156	   5000
  GPS			       SN-1047		    PN-006			157	   5000

49 rows selected.

*****************Es correcto el avion 1000

Call completed.


COMPRUEBA_AVION(1000)
--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------
Avion correcto

*****************Es correcto el avion 4000

Call completed.

  select COMPRUEBA_AVION(4000) from dual
         *
ERROR at line 1:
ORA-20005: Avion incorrecto
ORA-06512: at "ZZAMORA.COMPRUEBA_AVION", line 17


*****************Es correcto el avion 5000

Call completed.

  select COMPRUEBA_AVION(5000) from dual
         *
ERROR at line 1:
ORA-20005: Avion incorrecto
ORA-06512: at "ZZAMORA.COMPRUEBA_AVION", line 17


****************Borrar todos los aviones

Call completed.


Call completed.


no rows selected


Rollback complete.

